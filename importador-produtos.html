<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Importador Abella - Final</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #fdfaf5; padding: 40px; }
        .box { max-width: 700px; margin: auto; background: #fff; padding: 30px; border: 2px solid #A68966; border-radius: 12px; }
        button { background: #111; color: #fff; padding: 14px; width: 100%; margin-top: 15px; font-weight: bold; border: none; cursor: pointer; }
        #log { margin-top: 20px; background: #eee; padding: 10px; font-size: 11px; height: 300px; overflow: auto; border: 1px solid #ccc; line-height: 1.6em; }
        .cat-msg { color: #A68966; font-weight: bold; }
    </style>
</head>
<body>

<div class="box">
    <h2 style="color:#A68966">Importador Realtime Database</h2>
    <p>Selecione o arquivo: <strong>abella-produtos-importacao.csv</strong></p>
    <input type="file" id="csv" accept=".csv">
    <button onclick="importar()">GERAR CATEGORIAS E PRODUTOS</button>
    <div id="log">Aguardando...</div>
</div>

<script>
// Sua configura√ß√£o do Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function slug(txt) {
    if(!txt) return "geral";
    return txt.toLowerCase().normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/(^-|-$)/g,"");
}

// Fun√ß√£o inteligente para ler CSV com aspas e v√≠rgulas
function parseCSVLine(text) {
    const regex = /(".*?"|[^",\s]+)(?=\s*,|\s*$)/g;
    const sideRegex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/; 
    return text.split(sideRegex).map(i => i.replace(/^"|"$/g, '').trim());
}

async function importar() {
    const file = document.getElementById('csv').files[0];
    if(!file) return alert("Selecione o arquivo CSV");

    const text = await file.text();
    const linhas = text.split(/\r?\n/);
    const log = document.getElementById('log');
    log.innerHTML = "Iniciando processo...<br>";

    let count = 0;
    let categoriasCriadas = new Set();

    for(let i = 1; i < linhas.length; i++) {
        if(!linhas[i].trim()) continue;

        // Processa a linha respeitando as aspas do seu CSV
        const col = parseCSVLine(linhas[i]);
        
        // Estrutura baseada na sua planilha:
        // col[0]=nome, col[1]=sku, col[2]=categoria, col[3]=preco, col[4]=peso
        const nome = col[0];
        const sku = col[1] ? col[1].replace(/[\.\$#\[\]\/]/g, "-") : null;
        const categoriaNome = col[2];
        const preco = parseFloat(col[3]) || 0;
        const peso = col[4] || "0";

        if(!sku || !nome) continue;

        const catSlug = slug(categoriaNome);

        try {
            // 1. Cria a "pasta" de categorias se ainda n√£o processou esta
            if(!categoriasCriadas.has(catSlug)) {
                await db.ref('categories/' + catSlug).update({
                    name: categoriaNome,
                    slug: catSlug
                });
                categoriasCriadas.add(catSlug);
                log.innerHTML += `<span class="cat-msg">üìÅ Categoria criada: ${categoriaNome}</span><br>`;
            }

            // 2. Cria o produto na "pasta" products
            await db.ref('products/' + sku).set({
                name: nome,
                sku: col[1], // mantemos o original com ponto aqui se desejar
                category: catSlug,
                price: preco,
                weight: peso,
                image: "",
                promo: 0
            });

            log.innerHTML += `‚úÖ Produto: ${sku} importado<br>`;
            count++;
        } catch (e) {
            log.innerHTML += `<span style="color:red">‚ùå Erro no SKU ${sku}: ${e.message}</span><br>`;
        }
        
        log.scrollTop = log.scrollHeight;
    }

    alert("Fim! " + count + " produtos e " + categoriasCriadas.size + " categorias processadas.");
}
</script>
</body>
</html>
