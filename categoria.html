<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Categoria | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
    body{font-family:'Poppins',sans-serif;background:#f8f6f2;color:#333}
    .serif{font-family:'Cinzel',serif}
    .gold{color:#A68966}
    .card{background:#fff;border-radius:20px;border:1px solid #eee;transition:0.3s;position:relative;overflow:hidden;display:flex;flex-direction:column}
    .card:hover{transform:translateY(-5px);box-shadow:0 10px 20px rgba(0,0,0,0.05)}
    .btn-nav{background:white;border:1px solid #eee;padding:8px 15px;border-radius:50px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;transition:0.3s}
    .btn-nav:hover{border-color:#A68966;color:#A68966}
</style>
</head>

<body>

<header class="bg-white border-b sticky top-0 z-40 px-4 py-4">
    <div class="max-w-7xl mx-auto flex justify-between items-center mb-4">
        <a href="index.html" class="btn-nav">‚Üê Voltar</a>
        <div class="text-center">
            <span class="block text-[9px] font-bold gold tracking-[0.3em] uppercase">Abella Joias</span>
            <span class="block text-[7px] text-gray-400 uppercase tracking-tighter">Galv√¢nica & Bruto</span>
        </div>
        <a href="checkout_premium.html" class="btn-nav flex items-center gap-2">
            üõí Carrinho <span id="cartCount" class="bg-black text-white px-2 py-0.5 rounded-full text-[8px]">0</span>
        </a>
    </div>
    <div class="text-center pb-2">
        <h1 id="tituloCategoria" class="serif text-xl uppercase tracking-widest text-gray-800">Carregando...</h1>
    </div>
</header>

<main class="max-w-7xl mx-auto p-4 md:p-8">
    <div id="gridProdutos" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-8"></div>
</main>

<div id="modalCompra" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
        <div id="mFotoContainer" class="w-full aspect-square mb-4 rounded-2xl overflow-hidden bg-gray-50">
            <img id="mFoto" src="" class="w-full h-full object-cover">
        </div>
        <h2 id="modalNome" class="serif text-lg text-gray-800 mb-1 leading-tight"></h2>
        <p id="modalSku" class="text-[10px] text-gray-400 mb-4 font-bold tracking-widest uppercase"></p>
        
        <div class="flex items-center justify-between mb-6 bg-gray-50 p-3 rounded-2xl">
            <label class="text-[10px] font-bold uppercase text-gray-500">Quantidade</label>
            <input type="number" id="modalQtd" value="1" min="1" class="w-16 bg-transparent text-center font-bold text-lg outline-none">
        </div>
        
        <button id="btnConfirmarAdd" class="w-full bg-black text-white py-4 rounded-2xl font-bold text-[11px] uppercase tracking-widest hover:bg-gold transition-all shadow-lg">
            Adicionar ao Pedido
        </button>
        <button onclick="fecharModal()" class="w-full text-gray-400 text-[9px] mt-4 uppercase font-bold tracking-widest">Fechar Janela</button>
    </div>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY", databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com" };
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const urlParams = new URLSearchParams(window.location.search);
const slugCat = urlParams.get('cat');
let categoriaAtualDados = null;

// Sincroniza√ß√£o e Atualiza√ß√£o do Contador
function atualizarContador() {
    const carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
    document.getElementById('cartCount').innerText = carrinho.length;
}
atualizarContador();

// Carregar Dados da Categoria
db.ref('categories').orderByChild('slug').equalTo(slugCat).on('value', snap => {
    snap.forEach(child => {
        categoriaAtualDados = child.val();
        document.getElementById('tituloCategoria').innerText = categoriaAtualDados.name;
    });
    carregarProdutos();
});

function carregarProdutos() {
    db.ref('products').orderByChild('category').equalTo(slugCat).on('value', snap => {
        const grid = document.getElementById('gridProdutos');
        grid.innerHTML = '';
        
        snap.forEach(sp => {
            const v = sp.val();
            if(v.paused) return;

            const dCat = parseInt(categoriaAtualDados?.discount || 0);
            const pOriginal = parseFloat(v.price || 0);
            const pFinal = dCat > 0 ? pOriginal * (1 - dCat/100) : pOriginal;
            const pPix = pFinal * 0.95;
            const pParcela = pFinal / 3;

            grid.innerHTML += `
                <div class="card p-3">
                    ${dCat > 0 ? `
                        <div class="absolute top-3 right-3 bg-red-600 text-white text-[9px] px-2 py-1 rounded-full font-bold shadow-md z-10 animate-pulse">
                            ${dCat}% OFF
                        </div>
                    ` : ''}

                    <div class="aspect-square rounded-xl overflow-hidden mb-3 bg-gray-50">
                        <img src="${v.image}" class="object-cover w-full h-full hover:scale-110 transition-transform duration-500">
                    </div>

                    <span class="text-[8px] text-gray-400 font-bold uppercase tracking-widest">REF: ${v.sku}</span>
                    <h3 class="text-[11px] font-bold text-gray-800 leading-tight mb-2 h-7 overflow-hidden">${v.name}</h3>

                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[9px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded-md font-medium">${v.weight || '---'}</span>
                        <span class="text-[8px] text-gold font-bold uppercase italic">No Bruto</span>
                    </div>
                    
                    <div class="mt-auto border-t pt-3">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold gold">R$ ${pFinal.toFixed(2)}</span>
                            ${dCat > 0 ? `<span class="text-[9px] text-gray-400 line-through">R$ ${pOriginal.toFixed(2)}</span>` : ''}
                        </div>
                        <p class="text-[9px] text-green-600 font-bold mt-1 leading-none">R$ ${pPix.toFixed(2)} <span class="text-[7px] text-gray-400 uppercase font-normal">no PIX</span></p>
                        <p class="text-[8px] text-gray-400 mt-1 uppercase">ou 3x R$ ${pParcela.toFixed(2)}</p>
                    </div>

                    <button onclick="abrirModalCompra('${v.name}','${v.sku}',${pFinal},'${v.image}')"
                        class="w-full bg-black text-white py-3 rounded-xl text-[9px] font-bold uppercase tracking-[0.2em] mt-3 hover:bg-gold transition-all shadow-sm">
                        Adicionar
                    </button>
                </div>`;
        });
    });
}

let prodAdd = null;
function abrirModalCompra(nome, sku, preco, imagem) {
    prodAdd = { nome, sku, preco, imagem };
    document.getElementById('mFoto').src = imagem;
    document.getElementById('modalNome').innerText = nome;
    document.getElementById('modalSku').innerText = 'REF: ' + sku;
    document.getElementById('modalQtd').value = 1;
    document.getElementById('modalCompra').style.display = 'flex';
}

function fecharModal() {
    document.getElementById('modalCompra').style.display = 'none';
}

document.getElementById('btnConfirmarAdd').onclick = () => {
    const qtd = parseInt(document.getElementById('modalQtd').value);
    let carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
    
    carrinho.push({ ...prodAdd, qtd });
    localStorage.setItem('carrinho', JSON.stringify(carrinho));
    
    atualizarContador();
    fecharModal();
};
</script>

</body>
</html>
