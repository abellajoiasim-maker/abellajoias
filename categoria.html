<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Produtos | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<style>
    body{font-family:'Poppins',sans-serif;background:#f8f6f2}
    .serif{font-family:'Cinzel',serif}
    .gold{color:#A68966}
    .card{ background:#fff; border-radius:16px; border:1px solid #eee; transition:.3s; }
    #modalCompra { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:100; align-items:center; justify-content:center; padding:20px; }
</style>
</head>
<body>

<header class="bg-white border-b sticky top-0 z-40">
  <div class="text-center py-8">
    <h1 class="serif text-3xl gold">Abella Joias</h1>
    <p class="text-[10px] tracking-[0.3em] text-gray-500 uppercase">Catálogo Atacado</p>
  </div>
</header>

<main class="max-w-7xl mx-auto p-6">
    <h2 id="tituloCategoria" class="serif text-xl text-center mb-10 text-gray-700 uppercase tracking-widest font-bold"></h2>
    <div id="gridProdutos" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
</main>

<div id="modalCompra">
    <div class="bg-white p-6 rounded-2xl w-full max-w-sm text-center relative">
        <button onclick="fecharModal()" class="absolute top-4 right-4 text-gray-400 text-xl">&times;</button>
        <div class="aspect-square w-32 mx-auto mb-4 border rounded-xl overflow-hidden bg-gray-50">
            <img id="mImg" src="" class="w-full h-full object-contain">
        </div>
        <h3 id="mNome" class="font-bold gold text-sm uppercase"></h3>
        <p id="mSku" class="text-[10px] text-gray-400 mb-4 font-bold"></p>
        
        <div class="mb-6">
            <label class="text-[10px] block mb-2 font-bold text-gray-500 uppercase">Quantidade</label>
            <div class="flex items-center justify-center gap-4">
                <button onclick="mQtd.value = Math.max(1, parseInt(mQtd.value)-1)" class="w-10 h-10 border rounded-full font-bold">-</button>
                <input type="number" id="mQtd" value="1" min="1" class="w-16 text-center text-xl font-bold bg-transparent">
                <button onclick="mQtd.value = parseInt(mQtd.value)+1" class="w-10 h-10 border rounded-full font-bold">+</button>
            </div>
        </div>
        
        <button id="btnConfirmar" class="w-full bg-black text-white py-4 rounded-xl font-bold text-xs uppercase tracking-widest">Adicionar ao Carrinho</button>
    </div>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY", databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com" };
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const params = new URLSearchParams(window.location.search);
const catSlug = params.get('cat');
let itemSelecionado = null;

// Configurações de exibição (ajuste conforme seu negócio)
const DESC_PIX = 0.05; // 5% de desconto no PIX
const MAX_PARCELAS = 6;

if(!catSlug) location.href = 'index.html';

db.ref('categories/' + catSlug).once('value', s => { 
    if(s.exists()) document.getElementById('tituloCategoria').innerText = s.val().name; 
});

db.ref('products').orderByChild('category').equalTo(catSlug).on('value', snap => {
    const grid = document.getElementById('gridProdutos');
    grid.innerHTML = '';

    snap.forEach(p => {
        const prod = p.val();
        if(prod.paused) return;

        const preco = parseFloat(prod.price);
        const precoPix = preco * (1 - DESC_PIX);
        const valorParcela = preco / MAX_PARCELAS;

        grid.innerHTML += `
            <div class="card p-4 shadow-sm flex flex-col justify-between">
                <div>
                    <div class="aspect-square flex items-center justify-center mb-4 bg-white rounded-lg">
                        <img src="${prod.image || 'https://via.placeholder.com/400'}" class="object-contain max-h-full">
                    </div>
                    <p class="text-[9px] text-gray-400 font-bold uppercase tracking-tighter">SKU: ${prod.sku}</p>
                    <h3 class="text-[11px] font-bold uppercase mb-2 leading-tight">${prod.name}</h3>
                    
                    <div class="border-t pt-2 mt-auto">
                        <p class="text-xs font-bold text-gray-900">R$ ${preco.toFixed(2)}</p>
                        <p class="text-[10px] text-green-600 font-medium">R$ ${precoPix.toFixed(2)} no PIX</p>
                        <p class="text-[9px] text-gray-400">${MAX_PARCELAS}x de R$ ${valorParcela.toFixed(2)}</p>
                        <p class="text-[9px] text-gray-400 italic">Peso: ${prod.weight}g</p>
                    </div>
                </div>
                
                <button onclick="abrirModal('${p.key}')" class="w-full bg-black text-white py-2 rounded-full text-[10px] font-bold mt-4 uppercase tracking-widest">
                    Comprar
                </button>
            </div>
        `;
    });
});

async function abrirModal(id) {
    const snap = await db.ref('products/' + id).once('value');
    const p = snap.val();
    itemSelecionado = { ...p, id: id };

    document.getElementById('mImg').src = p.image || 'https://via.placeholder.com/400';
    document.getElementById('mNome').innerText = p.name;
    document.getElementById('mSku').innerText = "SKU: " + p.sku;
    document.getElementById('mQtd').value = 1;
    document.getElementById('modalCompra').style.display = 'flex';
}

function fecharModal() { document.getElementById('modalCompra').style.display = 'none'; }

document.getElementById('btnConfirmar').onclick = () => {
    let carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
    const qtd = parseInt(document.getElementById('mQtd').value);
    
    carrinho.push({
        id: itemSelecionado.id,
        nome: itemSelecionado.name,
        sku: itemSelecionado.sku,
        preco: parseFloat(itemSelecionado.price),
        qtd: qtd,
        image: itemSelecionado.image,
        peso: itemSelecionado.weight
    });

    localStorage.setItem('carrinho', JSON.stringify(carrinho));
    fecharModal();
    atualizarContador();
    alert("Adicionado ao carrinho!");
};

function atualizarContador() {
    const carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
    document.getElementById('cartCount').innerText = carrinho.length;
}
atualizarContador();
</script>
</body>
</html>
