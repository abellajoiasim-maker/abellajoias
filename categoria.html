<script>
const db = firebase.database();
const params = new URLSearchParams(location.search);
const catKey = params.get("cat");

let VARIACOES = {};

db.ref("categories/"+catKey).once("value").then(snap=>{
  VARIACOES = snap.val().variacoes || {};
  document.getElementById("tituloCat").innerText = snap.val().name;
});

db.ref("products").orderByChild("category").equalTo(catKey).on("value", snap=>{
  const grid = document.getElementById("gridProdutos");
  grid.innerHTML = "";

  const produtos = [];
  snap.forEach(p=>produtos.push({...p.val(), id:p.key}));

  produtos.sort((a,b)=>a.sku.localeCompare(b.sku));

  produtos.forEach(p=>{
    if(p.paused) return;

    grid.innerHTML += `
      <div class="produto-card">
        <img src="${p.image || 'placeholder.jpg'}">
        <h4>${p.name}</h4>
        <p>SKU ${p.sku}</p>
        <strong>R$ ${p.price.toFixed(2)}</strong>
        <button onclick="abrirProduto('${p.id}')">Comprar</button>
      </div>
    `;
  });
});

function abrirProduto(id){
  db.ref("products/"+id).once("value").then(snap=>{
    const p = snap.val();
    window.PROD_ATUAL = {...p, id};

    const sel = document.getElementById("selectVariacao");
    sel.innerHTML = "";

    Object.values(VARIACOES).forEach(v=>{
      if(v.active){
        sel.innerHTML += `<option value="${v.name}">${v.name}</option>`;
      }
    });

    document.getElementById("modalProduto").style.display="flex";
    document.getElementById("mNome").innerText=p.name;
    document.getElementById("mImg").src=p.image || "placeholder.jpg";
    document.getElementById("mPreco").innerText="R$ "+p.price.toFixed(2);
  });
}

function addCarrinho(){
  const v = document.getElementById("selectVariacao").value;
  const q = Number(document.getElementById("qtd").value);

  let cart = JSON.parse(localStorage.getItem("cart")||"[]");

  cart.push({
    id: PROD_ATUAL.id,
    name: PROD_ATUAL.name,
    sku: PROD_ATUAL.sku,
    price: PROD_ATUAL.price,
    weight: PROD_ATUAL.weight,
    category: PROD_ATUAL.category,
    variacao: v,
    qtd: q
  });

  localStorage.setItem("cart",JSON.stringify(cart));
  alert("Adicionado ao carrinho");
  fecharModal();
}
</script>
