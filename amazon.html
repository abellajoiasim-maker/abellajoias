<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abella Joias | Portal de Atacado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8f9fa; color: #333; }
        .sticky-cart { position: sticky; bottom: 0; background: white; border-top: 2px solid #e2e8f0; z-index: 50; }
        .qty-input::-webkit-inner-spin-button { opacity: 1; }
        .promo-tag { background: #fee2e2; color: #dc2626; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

<header class="bg-white border-b p-4 sticky top-0 z-50">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
        <h1 class="text-xl font-bold tracking-tighter" onclick="location.reload()">ABELLA <span class="text-amber-600">ATACADO</span></h1>
        <div class="text-right">
            <p class="text-[10px] text-gray-500 uppercase">Pedido Mínimo: R$ 500,00</p>
            <div class="w-32 h-2 bg-gray-200 rounded-full mt-1">
                <div id="min-order-bar" class="h-full bg-green-500 rounded-full transition-all" style="width: 0%"></div>
            </div>
        </div>
    </div>
</header>

<main class="max-w-6xl mx-auto p-4 pb-32">
    <div id="cat-nav" class="flex gap-2 overflow-x-auto pb-4 mb-6 scrollbar-hide"></div>

    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        </div>
</main>

<footer class="sticky-cart p-4 shadow-2xl">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
        <div>
            <p class="text-sm text-gray-600"><span id="items-count">0</span> itens selecionados</p>
            <p class="text-xl font-bold text-gray-900" id="cart-total">R$ 0,00</p>
        </div>
        <button onclick="enviarPedido()" id="btn-finalizar" disabled 
            class="bg-gray-400 text-white px-8 py-3 rounded-lg font-bold transition-all">
            Finalizar Pedido
        </button>
    </div>
</footer>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let carrinho = {};
    const PEDIDO_MINIMO = 500.00;

    const fM = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    // Iniciar Sistema
    function init() {
        carregarCategorias();
        carregarTodosProdutos();
    }

    function carregarCategorias() {
        db.ref('categories').once('value', snap => {
            const nav = document.getElementById('cat-nav');
            nav.innerHTML = `<button onclick="carregarTodosProdutos()" class="whitespace-nowrap px-4 py-2 bg-black text-white rounded-full text-sm">Todos</button>`;
            snap.forEach(s => {
                const cat = s.val();
                nav.innerHTML += `<button onclick="filtrarCategoria('${s.key}')" class="whitespace-nowrap px-4 py-2 bg-white border rounded-full text-sm hover:bg-gray-50">${cat.name}</button>`;
            });
        });
    }

    function carregarTodosProdutos() {
        db.ref('products').once('value', snap => renderizarProdutos(snap));
    }

    function filtrarCategoria(catId) {
        db.ref('products').orderByChild('category').equalTo(catId).once('value', snap => renderizarProdutos(snap));
    }

    function renderizarProdutos(snap) {
        const grid = document.getElementById('product-grid');
        grid.innerHTML = '';
        snap.forEach(s => {
            const p = s.val();
            const id = s.key;
            const temPromo = p.promoPct > 0;

            grid.innerHTML += `
                <div class="bg-white border rounded-xl p-4 flex items-center gap-4 hover:border-amber-300 transition">
                    <img src="${p.image}" class="w-20 h-20 object-contain bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <h3 class="font-semibold text-sm leading-tight">${p.name}</h3>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-lg font-bold">${fM(p.price)}</span>
                            ${temPromo ? `<span class="promo-tag">-${p.promoPct}%</span>` : ''}
                        </div>
                        <p class="text-[10px] text-gray-400 uppercase mt-1">Preço Sugerido: ${fM(p.price * 2)}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" min="0" value="${carrinho[id]?.qtd || 0}" 
                            onchange="atualizarQtd('${id}', this.value, ${p.price}, '${p.name}')"
                            class="w-16 p-2 border rounded-md text-center font-bold focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>`;
        });
    }

    function atualizarQtd(id, qtd, preco, nome) {
        qtd = parseInt(qtd);
        if (qtd > 0) {
            carrinho[id] = { qtd, preco, nome };
        } else {
            delete carrinho[id];
        }
        calcularTotais();
    }

    function calcularTotais() {
        let total = 0;
        let itens = 0;
        for (let key in carrinho) {
            total += carrinho[key].qtd * carrinho[key].preco;
            itens += carrinho[key].qtd;
        }

        document.getElementById('cart-total').innerText = fM(total);
        document.getElementById('items-count').innerText = itens;

        // Barra de progresso
        const perc = Math.min((total / PEDIDO_MINIMO) * 100, 100);
        document.getElementById('min-order-bar').style.width = perc + '%';

        // Habilitar botão
        const btn = document.getElementById('btn-finalizar');
        if (total >= PEDIDO_MINIMO) {
            btn.disabled = false;
            btn.classList.replace('bg-gray-400', 'bg-green-600');
        } else {
            btn.disabled = true;
            btn.classList.replace('bg-green-600', 'bg-gray-400');
        }
    }

    function enviarPedido() {
        let texto = `*NOVO PEDIDO ATACADO - ABELLA JOIAS*\n\n`;
        let totalGeral = 0;
        
        for (let key in carrinho) {
            const item = carrinho[key];
            const sub = item.qtd * item.preco;
            texto += `• ${item.qtd}x ${item.nome} - ${fM(sub)}\n`;
            totalGeral += sub;
        }

        texto += `\n*TOTAL DO PEDIDO: ${fM(totalGeral)}*`;
        
        const fone = "5511999999999";
        window.open(`https://wa.me/${fone}?text=${encodeURIComponent(texto)}`, '_blank');
    }

    window.onload = init;
</script>
</body>
</html>
