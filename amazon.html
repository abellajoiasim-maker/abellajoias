<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abella Joias | Atacado Premium</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; background: #f4f7f6; color: #1a1a1a; }
        .serif { font-family: 'Cinzel', serif; }
        .gold-brand { color: #b89552; }
        .bg-gold { background: #b89552; }
        
        /* Enterprise Light Cards */
        .card-enterprise { 
            background: #ffffff; 
            border-radius: 20px;
            border: 1px solid #e5e7eb; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        .card-enterprise:hover { 
            transform: translateY(-5px); 
            border-color: #b89552; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05);
        }
        
        .img-box {
            width: 100%;
            aspect-ratio: 1/1;
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .img-box img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .card-enterprise:hover img { transform: scale(1.08); }

        /* Sidebar Clean */
        .sidebar-nav { position: sticky; top: 100px; max-height: calc(100vh - 120px); overflow-y: auto; }
        .cat-btn { 
            text-align: left; padding: 10px 15px; border-radius: 12px; font-size: 13px; 
            font-weight: 500; color: #6b7280; transition: 0.3s;
        }
        .cat-btn:hover, .cat-btn.active { background: white; color: #b89552; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }

        /* Modal Light */
        .modal-overlay { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .modal-content { background: white; border-radius: 30px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1); border: 1px solid #f3f4f6; }

        .btn-qty { width: 45px; height: 45px; border-radius: 15px; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-qty:hover { background: #1a1a1a; color: white; border-color: #1a1a1a; }
    </style>
</head>
<body>

<header class="sticky top-0 z-[100] bg-white/80 backdrop-blur-md border-b border-gray-100">
    <div class="max-w-[1600px] mx-auto px-6 py-4 flex items-center justify-between">
        <div>
            <h1 class="serif text-xl font-bold tracking-tighter uppercase">ABELLA <span class="gold-brand">ATACADO</span></h1>
            <p class="text-[9px] font-bold text-gray-400 tracking-[3px] uppercase">Joias no Bruto Premium</p>
        </div>

        <div class="flex items-center gap-6">
            <div class="hidden md:flex flex-col items-end border-r pr-6 border-gray-100">
                <span class="text-[9px] font-bold text-gray-400 uppercase">Status do Carrinho</span>
                <span id="resumoTotal" class="text-sm font-black text-gray-900">R$ 0,00</span>
            </div>
            <button onclick="window.location.href='carrinho.html'" class="bg-black text-white px-6 py-3 rounded-2xl font-bold text-xs flex items-center gap-3 hover:bg-amber-700 transition shadow-lg shadow-gray-200">
                <i class="fas fa-shopping-bag"></i>
                <span class="hidden sm:inline">FINALIZAR</span>
            </button>
        </div>
    </div>
</header>

<div class="max-w-[1600px] mx-auto flex flex-col lg:flex-row p-6 gap-8">
    <aside class="w-full lg:w-64 sidebar-nav hidden lg:block">
        <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-4">Categorias</h3>
        <nav id="menuLateral" class="flex flex-col gap-1">
            </nav>
    </aside>

    <main class="flex-1">
        <div class="bg-white p-4 rounded-2xl mb-8 border border-gray-100 flex items-center justify-between">
            <div class="flex-1 pr-8">
                <div class="flex justify-between text-[10px] font-bold mb-1 uppercase tracking-tighter">
                    <span>Progresso Pedido Mínimo</span>
                    <span id="txtFalta">Faltam R$ 800,00</span>
                </div>
                <div class="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden">
                    <div id="barraMin" class="h-full bg-gold-brand transition-all duration-700 w-0" style="background-color: #b89552;"></div>
                </div>
            </div>
            <i class="fas fa-info-circle text-gray-300"></i>
        </div>

        <div id="gridLoja" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-6">
            </div>
    </main>
</div>

<div id="modalCompra" class="fixed inset-0 z-[200] modal-overlay hidden flex items-center justify-center p-4">
    <div class="modal-content w-full max-w-sm p-8 text-center animate-in fade-in zoom-in duration-300">
        <div id="mImg" class="w-40 h-40 mx-auto rounded-3xl bg-gray-50 overflow-hidden mb-6 border border-gray-100"></div>
        <h3 id="mNome" class="serif text-lg font-bold text-gray-900 uppercase">Nome do Produto</h3>
        <p id="mPreco" class="text-amber-600 font-bold text-xl mt-1">R$ 0,00</p>
        
        <div class="flex items-center justify-center gap-6 my-8">
            <button onclick="mudarQtd(-1)" class="btn-qty text-xl"><i class="fas fa-minus"></i></button>
            <span id="mVal" class="text-3xl font-black w-10">1</span>
            <button onclick="mudarQtd(1)" class="btn-qty text-xl"><i class="fas fa-plus"></i></button>
        </div>
        
        <div class="flex flex-col gap-3">
            <button id="btnAdd" class="w-full bg-black text-white py-4 rounded-2xl font-bold uppercase tracking-widest text-xs hover:bg-amber-600 transition shadow-xl shadow-gray-200">Adicionar ao Pedido</button>
            <button onclick="fecharModal()" class="text-gray-400 text-[10px] uppercase font-bold mt-2">Voltar ao catálogo</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
    const fM = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const firebaseConfig = {
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let produtosBase = [];
    let itemSelecionado = null;
    const MIN_VAL = 800.00;

    // --- FORÇA BRUTA DE CARREGAMENTO ---
    function iniciar() {
        console.log("Iniciando varredura Abella Joias...");
        
        // Categorias
        db.ref('categories').on('value', snap => {
            const menu = document.getElementById('menuLateral');
            menu.innerHTML = `<button onclick="renderizar(produtosBase)" class="cat-btn active">Todos os Brutos</button>`;
            snap.forEach(s => {
                const c = s.val();
                if(!c.paused) {
                    menu.innerHTML += `<button onclick="filtrarCat('${s.key}')" class="cat-btn">${c.name}</button>`;
                }
            });
        });

        // Produtos
        db.ref('products').on('value', snap => {
            produtosBase = [];
            snap.forEach(s => {
                produtosBase.push({id: s.key, ...s.val()});
            });
            renderizar(produtosBase);
            atualizarContadores();
        });
    }

    function renderizar(lista) {
        const grid = document.getElementById('gridLoja');
        grid.innerHTML = ''; // Força a limpeza
        
        if(lista.length === 0) {
            grid.innerHTML = `<div class="col-span-full py-20 text-center text-gray-400">Nenhum produto encontrado nesta coleção.</div>`;
            return;
        }

        lista.map(p => {
            grid.innerHTML += `
                <div class="card-enterprise flex flex-col cursor-pointer" onclick="abrirCompra('${p.id}')">
                    <div class="img-box relative">
                        ${p.promoPct > 0 ? `<span class="absolute top-3 right-3 bg-red-500 text-white text-[9px] px-2 py-1 rounded-lg font-bold">-${p.promoPct}% OFF</span>` : ''}
                        <img src="${p.image}" loading="lazy">
                    </div>
                    <div class="p-5 text-center flex-1">
                        <p class="text-[9px] text-gray-300 font-bold mb-1">REF: ${p.id.substring(0,6)}</p>
                        <h3 class="text-[11px] font-bold text-gray-700 uppercase leading-tight h-8 overflow-hidden mb-4">${p.name}</h3>
                        <div class="flex flex-col items-center">
                            <span class="text-lg font-black text-gray-900 tracking-tighter">${fM(p.price)}</span>
                            <span class="text-[9px] text-gray-400 font-medium">PREÇO NO BRUTO</span>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    // --- DINÂMICA DE COMPRA ---
    function abrirCompra(id) {
        const p = produtosBase.find(x => x.id === id);
        itemSelecionado = p;
        document.getElementById('mNome').innerText = p.name;
        document.getElementById('mPreco').innerText = fM(p.price);
        document.getElementById('mImg').innerHTML = `<img src="${p.image}" class="w-full h-full object-cover">`;
        document.getElementById('mVal').innerText = "1";
        
        document.getElementById('btnAdd').onclick = () => confirmarInclusao(p);
        document.getElementById('modalCompra').classList.remove('hidden');
    }

    function mudarQtd(v) {
        let el = document.getElementById('mVal');
        let n = parseInt(el.innerText) + v;
        el.innerText = Math.max(1, n);
    }

    function fecharModal() {
        document.getElementById('modalCompra').classList.add('hidden');
    }

    function confirmarInclusao(p) {
        const qtd = parseInt(document.getElementById('mVal').innerText);
        let cart = JSON.parse(localStorage.getItem('carrinho') || '[]');
        const idx = cart.findIndex(i => i.id === p.id);
        
        if(idx > -1) cart[idx].quantidade += qtd;
        else cart.push({...p, quantidade: qtd});
        
        localStorage.setItem('carrinho', JSON.stringify(cart));
        fecharModal();
        atualizarContadores();
    }

    function atualizarContadores() {
        const cart = JSON.parse(localStorage.getItem('carrinho') || '[]');
        const total = cart.reduce((acc, i) => acc + (i.price * i.quantidade), 0);
        
        document.getElementById('resumoTotal').innerText = fM(total);
        
        const falta = Math.max(0, MIN_VAL - total);
        const perc = Math.min((total / MIN_VAL) * 100, 100);
        
        document.getElementById('barraMin').style.width = perc + '%';
        document.getElementById('txtFalta').innerText = falta > 0 ? `Faltam ${fM(falta)}` : 'Pedido Mínimo Atingido!';
        document.getElementById('txtFalta').style.color = falta > 0 ? '#ef4444' : '#10b981';
    }

    function filtrarCat(id) {
        const filtrados = produtosBase.filter(p => p.category === id);
        renderizar(filtrados);
        // Atualiza estilo dos botões
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    window.onload = iniciar;
</script>
</body>
</html>
