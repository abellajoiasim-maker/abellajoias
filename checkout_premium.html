<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Finalizar Pedido | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<style>
    body{font-family:'Poppins',sans-serif;background:#f8f6f2;color:#333}
    .serif{font-family:'Cinzel',serif}
    .gold{color:#A68966}
    .item-card { background:#fff; border-radius:12px; border:1px solid #eee; padding: 15px; margin-bottom: 10px;}
    .btn-pagamento { border: 2px solid #eee; transition: 0.3s; cursor: pointer; background: #fdfdfd; border-radius: 12px; padding: 15px; text-align: center; font-size: 12px; font-weight: bold;}
    .btn-pagamento.active { border-color: #A68966; background: #fffcf9; color: #A68966; }
    input { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 10px; outline: none; }
    input:focus { border-color: #A68966; }
    label { font-size: 10px; font-weight: bold; text-transform: uppercase; color: #999; margin-left: 5px; }
</style>
</head>
<body class="pb-10">

<header class="p-6 bg-white border-b border-gray-100 sticky top-0 z-50 flex items-center gap-4">
    <button onclick="history.back()" class="p-2 bg-gray-50 rounded-full">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <h1 class="serif text-lg gold tracking-widest uppercase">Finalizar Pedido</h1>
</header>

<main class="max-w-2xl mx-auto p-4">
    <div id="listaItens" class="mb-8"></div>

    <div class="bg-white p-6 rounded-2xl shadow-sm mb-6">
        <h2 class="serif gold mb-4 border-b pb-2">Seus Dados</h2>
        <label>Nome Completo</label>
        <input type="text" id="nomeCliente" placeholder="Como podemos te chamar?">
        
        <label>WhatsApp</label>
        <input type="tel" id="contatoCliente" placeholder="(00) 00000-0000">
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-sm mb-6">
        <h2 class="serif gold mb-4 border-b pb-2">Endere√ßo de Entrega</h2>
        <label>Rua / Logradouro</label>
        <input type="text" id="rua" placeholder="Ex: Av. Brasil">
        
        <div class="grid grid-cols-3 gap-3">
            <div class="col-span-1">
                <label>N√∫mero</label>
                <input type="text" id="numero" placeholder="123">
            </div>
            <div class="col-span-2">
                <label>Bairro</label>
                <input type="text" id="bairro" placeholder="Ex: Centro">
            </div>
        </div>

        <label>Cidade</label>
        <input type="text" id="cidade" placeholder="Sua Cidade - UF">
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-sm mb-6">
        <h2 class="serif gold mb-4 border-b pb-2">Forma de Pagamento</h2>
        <div class="grid grid-cols-2 gap-3">
            <div class="btn-pagamento" onclick="setPagamento('PIX', this)">PIX</div>
            <div class="btn-pagamento" onclick="setPagamento('Cart√£o', this)">CART√ÉO</div>
            <div class="btn-pagamento" onclick="setPagamento('Boleto', this)">BOLETO</div>
            <div class="btn-pagamento" onclick="setPagamento('Link de Pagamento', this)">LINK / OUTROS</div>
        </div>
    </div>

    <div class="p-6 bg-black text-white rounded-3xl text-center">
        <p class="text-gray-400 text-sm mb-1 uppercase tracking-widest">Total do Pedido</p>
        <h3 id="valorTotalFinal" class="text-3xl font-bold mb-6 gold">R$ 0,00</h3>
        <button onclick="enviarPedido()" class="w-full bg-[#A68966] text-white py-5 rounded-2xl font-bold uppercase tracking-widest shadow-lg active:scale-95 transition-all">
            ENVIAR PEDIDO VIA WHATSAPP
        </button>
    </div>
</main>

<script>
// CONFIG FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    authDomain: "catalogo-abella-joias.firebaseapp.com",
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
    projectId: "catalogo-abella-joias"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let formaPagamento = "";
let totalGeral = 0;

function setPagamento(tipo, el) {
    formaPagamento = tipo;
    document.querySelectorAll('.btn-pagamento').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
}

function carregarResumo() {
    const carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
    const container = document.getElementById('listaItens');
    totalGeral = 0;

    if (carrinho.length === 0) {
        container.innerHTML = "<p class='text-center p-10'>Seu carrinho est√° vazio.</p>";
        return;
    }

    carrinho.forEach(item => {
        const subtotal = item.preco * item.qtd;
        totalGeral += subtotal;
        container.innerHTML += `
            <div class="item-card flex gap-4 items-center">
                <img src="${item.image}" class="w-16 h-16 object-cover rounded-lg">
                <div class="flex-1">
                    <h4 class="font-bold text-sm">${item.nome}</h4>
                    <p class="text-xs text-gray-500">${item.qtd}x R$ ${item.preco.toFixed(2)}</p>
                </div>
                <div class="text-right">
                    <p class="font-bold gold text-sm">R$ ${subtotal.toFixed(2)}</p>
                </div>
            </div>`;
    });

    document.getElementById('valorTotalFinal').innerText = `R$ ${totalGeral.toFixed(2)}`;
}

async function enviarPedido() {
    const nome = document.getElementById('nomeCliente').value;
    const contato = document.getElementById('contatoCliente').value;
    const rua = document.getElementById('rua').value;
    const num = document.getElementById('numero').value;
    const bairro = document.getElementById('bairro').value;
    const cidade = document.getElementById('cidade').value;
    const carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');

    if (!nome || !contato || !formaPagamento || !rua || !cidade) {
        alert("Por favor, preencha seus dados, endere√ßo e selecione o pagamento.");
        return;
    }

    // 1. SALVAR NO FIREBASE COM O OBJETO PARA O ROMANEIO
    const novoPedidoRef = db.ref('orders').push();
    await novoPedidoRef.set({
        cliente: nome,
        whatsapp: contato,
        total: totalGeral,
        pagamento: formaPagamento,
        status: "Novo",
        data: new Date().toLocaleString('pt-BR'),
        endereco_detalhado: {
            rua: rua,
            num: num,
            bairro: bairro,
            cidade: cidade
        },
        itens: carrinho 
    });

    // 2. MONTAR WHATSAPP
    let msg = `*NOVO PEDIDO - ABELLA JOIAS*\\n\\n`;
    msg += `üë§ *Cliente:* ${nome}\\n`;
    msg += `üìç *Entrega:* ${rua}, ${num} - ${bairro}, ${cidade}\\n`;
    msg += `üí≥ *Pagamento:* ${formaPagamento}\\n`;
    msg += `üí∞ *Total:* R$ ${totalGeral.toFixed(2)}\\n\\n`;
    msg += `*ITENS:*\\n`;
    
    carrinho.forEach(i => {
        msg += `- ${i.qtd}x ${i.nome} (R$ ${i.preco.toFixed(2)})\\n`;
    });

    // Pega o Whats da Empresa nos Ajustes
    db.ref('settings/whatsapp').once('value').then(snap => {
        const whatsEmpresa = snap.val() || "5500000000000";
        const link = `https://api.whatsapp.com/send?phone=${whatsEmpresa}&text=${encodeURIComponent(msg)}`;
        
        localStorage.removeItem('carrinho');
        window.location.href = link;
    });
}

carregarResumo();
</script>

</body>
</html>
