<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Finalizar Pedido | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-[#f8f6f2] pb-40">

<header class="bg-white border-b py-6 text-center shadow-sm">
    <h1 id="nomeLojaHead" class="font-serif text-2xl text-[#A68966] font-bold uppercase tracking-widest">Abella Joias</h1>
</header>

<main class="max-w-2xl mx-auto p-4 mt-6">
    <div id="listaItens" class="space-y-4 mb-8"></div>

    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 space-y-4 mb-8">
        <div class="flex justify-between border-b pb-2">
            <span class="text-sm text-gray-400 font-bold uppercase">Subtotal:</span>
            <span id="subtotalBruto" class="font-bold">R$ 0,00</span>
        </div>
        <div class="flex justify-between border-b pb-2 text-green-600">
            <span id="labelDescontoPixResumo" class="text-sm font-bold uppercase">Desconto PIX:</span>
            <span id="valorDescontoPix">- R$ 0,00</span>
        </div>
        <div class="flex justify-between text-lg">
            <span class="font-serif text-[#A68966] font-bold">TOTAL:</span>
            <span id="valorTotalFinal" class="font-bold text-[#A68966]">R$ 0,00</span>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        <div id="optPix" onclick="setPagamento('Pix')" class="bg-white p-5 rounded-xl border-2 border-transparent cursor-pointer hover:border-[#A68966] transition-all">
            <p class="font-bold text-sm uppercase">PIX</p>
            <p id="labelPixBotao" class="text-[10px] text-green-600 font-bold uppercase">Carregando...</p>
            <p id="totalNoPix" class="font-bold text-green-600 text-lg mt-2">R$ 0,00</p>
        </div>
        <div id="optCartao" onclick="setPagamento('Cartão')" class="bg-white p-5 rounded-xl border-2 border-transparent cursor-pointer hover:border-[#A68966] transition-all">
            <p class="font-bold text-sm uppercase">Cartão</p>
            <p id="labelParcelasBotao" class="text-[10px] text-gray-400 font-bold uppercase">Carregando...</p>
            <p id="valorParcelaRef" class="font-bold text-gray-700 text-lg mt-2">R$ 0,00</p>
        </div>
    </div>
</main>

<div class="fixed bottom-0 inset-x-0 bg-white border-t p-6 shadow-lg z-50 text-center">
    <button id="btnFinalizar" onclick="enviarWhatsApp()" class="bg-green-600 text-white px-12 py-4 rounded-xl font-bold uppercase tracking-widest disabled:opacity-50" disabled>
        Aguardando Sincronização...
    </button>
</div>

<script>
const firebaseConfig = { 
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY", 
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com" 
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let configEmpresa = { whatsapp: "", nome: "", desconto_pix: 0, parcelas: 1 };
let formaPagamento = "";

// SINCRONIZAÇÃO REAL COM O SEU PAINEL (Foto 1)
db.ref('empresa').on('value', snap => {
    if(snap.exists()){
        const d = snap.val();
        configEmpresa.whatsapp = d.whatsapp?.replace(/\D/g, '') || "";
        configEmpresa.nome = d.nome_fantasia || d.nome || "Abella Joias";
        
        // Aqui está o segredo: convertendo os campos da sua Foto 1
        configEmpresa.desconto_pix = parseFloat(d.desconto_pix) || 0;
        configEmpresa.parcelas = parseInt(d.parcelas_sem_juros) || 1;
        
        // Atualiza os textos dos botões na hora
        document.getElementById('labelDescontoPixResumo').innerText = `Desconto PIX (${configEmpresa.desconto_pix}%):`;
        document.getElementById('labelPixBotao').innerText = `${configEmpresa.desconto_pix}% de desconto`;
        document.getElementById('labelParcelasBotao').innerText = `${configEmpresa.parcelas}x sem acréscimo`;
        
        carregarCarrinho();
        
        const btn = document.getElementById('btnFinalizar');
        btn.innerText = "Enviar para WhatsApp";
        btn.disabled = false;
    }
});

function carregarCarrinho() {
    const carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
    let totalBruto = 0;

    carrinho.forEach(item => {
        totalBruto += (parseFloat(item.preco) * item.qtd);
    });

    const vDesconto = totalBruto * (configEmpresa.desconto_pix / 100);
    const totalPix = totalBruto - vDesconto;

    document.getElementById('subtotalBruto').innerText = `R$ ${totalBruto.toFixed(2)}`;
    document.getElementById('valorDescontoPix').innerText = `- R$ ${vDesconto.toFixed(2)}`;
    document.getElementById('valorTotalFinal').innerText = `R$ ${totalBruto.toFixed(2)}`;
    document.getElementById('totalNoPix').innerText = `R$ ${totalPix.toFixed(2)}`;
    document.getElementById('valorParcelaRef').innerText = `${configEmpresa.parcelas}x de R$ ${(totalBruto / configEmpresa.parcelas).toFixed(2)}`;
}

function setPagamento(tipo) {
    formaPagamento = tipo;
    // Estética dos botões
    document.querySelectorAll('.border-2').forEach(el => el.style.borderColor = 'transparent');
    document.getElementById(tipo === 'Pix' ? 'optPix' : 'optCartao').style.borderColor = '#A68966';
}

function enviarWhatsApp() {
    if(!formaPagamento) return alert("Selecione o pagamento!");
    // ... lógica de envio ...
    alert("Pedido enviado para " + configEmpresa.whatsapp);
}
</script>
</body>
</html>
