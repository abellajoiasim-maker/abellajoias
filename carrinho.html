<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Finalizar Pedido • Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

<style>
body{font-family:'Poppins',sans-serif;background:#0b0b0b;color:#eee;margin:0}
.serif{font-family:'Cinzel',serif}
.gold-text{color:#caa85c}
.gold-bg{background:#caa85c}
.card{background:#141414;border-radius:18px;border:1px solid #2a2a2a;padding:20px;margin-bottom:20px}
input{background:#000!important;border:1px solid #333!important;color:#fff!important;padding:12px;border-radius:10px;width:100%;outline:none;margin-bottom:12px;font-size:14px}
.pay-btn{border:1px solid #333;border-radius:14px;padding:16px;text-align:center;cursor:pointer;transition:.3s}
.pay-btn.active{border-color:#caa85c;background:rgba(202,168,92,.05)}
.price-anchor-highlight{text-decoration:line-through;color:#ff4d4d;font-size:1.5rem;font-weight:bold}
.promo-tag{color:#ff4d4d;font-weight:bold;font-size:10px;text-transform:uppercase}
.btn-remove{color:#ff4d4d;opacity:.6;transition:.3s;padding:5px}
.btn-remove:hover{opacity:1;transform:scale(1.1)}
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
input[type=number]{-moz-appearance:textfield}
</style>
</head>

<body>

<header class="sticky top-0 z-50 bg-black/95 backdrop-blur-md border-b border-[#222]">
<div class="max-w-xl mx-auto p-4 flex justify-between items-center">
<button onclick="history.back()" class="text-[10px] font-bold uppercase gold-text">← Voltar</button>
<h1 class="serif gold-text uppercase text-sm tracking-widest">Finalizar Pedido</h1>
</div>
</header>

<main class="max-w-xl mx-auto p-4 pb-40">

<div class="card">
<h2 class="serif gold-text uppercase text-[10px] mb-4 tracking-widest opacity-70 text-center">Itens no Carrinho</h2>
<div id="listaItens" class="space-y-4"></div>

<div class="grid grid-cols-3 gap-2 mt-6 pt-6 border-t border-[#222]">
<div class="bg-black p-3 rounded-xl border border-[#222] text-center">
<span class="block text-[8px] uppercase text-gray-500 font-bold mb-1">Modelos</span>
<b id="totalSkus">0</b>
</div>
<div class="bg-black p-3 rounded-xl border border-[#222] text-center">
<span class="block text-[8px] uppercase text-gray-500 font-bold mb-1">Peças</span>
<b id="totalPecas">0</b>
</div>
<div class="bg-black p-3 rounded-xl border border-[#caa85c]/20 text-center">
<span class="block text-[8px] uppercase gold-text font-bold mb-1">Peso Total</span>
<b id="pesoTotal" class="text-xs">0,00g</b>
</div>
</div>
</div>

<div class="card">
<h2 class="serif gold-text uppercase text-[10px] mb-4 tracking-widest border-b border-[#222] pb-2">Identificação</h2>
<input id="nomeCliente" placeholder="Seu Nome Completo *">
<input id="telefoneCliente" placeholder="WhatsApp (DDD + Número) *">
</div>

<div class="card">
<h2 class="serif gold-text uppercase text-[10px] mb-4 tracking-widest border-b border-[#222] pb-2">Local de Entrega</h2>
<input id="nomeEntrega" placeholder="Nome do Destinatário">
<input id="rua" placeholder="Rua / Avenida">
<div class="grid grid-cols-4 gap-2">
<input id="num" placeholder="Nº">
<input id="bairro" placeholder="Bairro" class="col-span-3">
</div>
<input id="cidade" placeholder="Cidade">
<input id="cepEntrega" placeholder="CEP">
</div>

<div class="card">
<h2 class="serif gold-text uppercase text-[10px] mb-4 tracking-widest border-b border-[#222] pb-2">Forma de Pagamento</h2>
<div class="grid grid-cols-2 gap-4">
<div class="pay-btn" onclick="setPagamento('Pix',this)">
<span class="block font-bold">PIX</span>
<span class="text-[10px] text-green-500 font-bold uppercase">Com Desconto</span>
</div>
<div class="pay-btn" onclick="setPagamento('Cartão',this)">
<span class="block font-bold">CARTÃO</span>
<span class="text-[10px] text-blue-400 font-bold uppercase">Até 3x</span>
</div>
</div>
</div>

<div class="card">
<h2 class="serif gold-text uppercase text-[10px] mb-6 tracking-widest text-center border-b border-[#222] pb-2">Resumo Financeiro</h2>

<div class="space-y-4">
<div class="flex justify-between text-gray-500 text-sm">
<span>Subtotal Bruto</span>
<b id="subtotalTxt">R$ 0,00</b>
</div>

<div id="linhaDescontoPromo" class="flex justify-between text-emerald-500 italic text-sm hidden">
<span id="labelPromo"></span>
<b id="valorDescontoPromo"></b>
</div>

<div id="linhaCondicao" class="flex justify-between text-blue-300 italic text-sm hidden">
<span id="labelCondicao"></span>
<b id="valorCondicao"></b>
</div>

<div class="mt-6 pt-6 border-t-2 border-[#caa85c] flex flex-col items-end">
<div id="precoBrutoRiscado" class="price-anchor-highlight hidden"></div>
<div class="flex justify-between w-full items-center mt-2">
<span class="serif gold-text text-xl">TOTAL</span>
<span id="totalTxt" class="text-3xl font-bold gold-text">R$ 0,00</span>
</div>
</div>
</div>
</div>

</main>

<footer class="fixed bottom-0 left-0 right-0 p-4 bg-black/90 border-t border-[#222]">
<button onclick="finalizarPedido()" class="w-full gold-bg text-black py-5 rounded-2xl font-bold uppercase">
Finalizar via WhatsApp
</button>
</footer>

<script>
if(!firebase.apps.length){
firebase.initializeApp({
apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com"
});
}
const db=firebase.database();
let carrinho=JSON.parse(localStorage.getItem('carrinho')||'[]');
let pagamento='';
let foneLoja='';
let configEmpresa={descontoPix:0,parcelas:3,nomePromo:"OFERTA"};

const fM=v=>v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const fP=v=>v.toLocaleString('pt-BR',{minimumFractionDigits:2})+'g';

db.ref('settings').on('value',s=>{
const d=s.val()||{};
foneLoja=d.empresa?.whats?.replace(/\D/g,'')||'';
configEmpresa.descontoPix=parseFloat(d.empresa?.descontoPix)||0;
configEmpresa.parcelas=parseInt(d.empresa?.parcelas)||3;
configEmpresa.nomePromo=(d.promocoes?.nome||d.empresa?.nomePromo||'OFERTA').toUpperCase();
carregarCarrinho();
});

function carregarCarrinho(){
let bruto=0,comPromo=0,peso=0,pecas=0;
document.getElementById('listaItens').innerHTML='';
carrinho.forEach((i,idx)=>{
let q=parseInt(i.quantidade)||1;
let pO=parseFloat(i.price||i.precoFinal)||0;
let pP=parseFloat(i.precoFinal||i.price)||0;
bruto+=pO*q; comPromo+=pP*q; pecas+=q;
let p=parseFloat((i.peso||'0').toString().replace(',','.'))||0;
peso+=p*q;
});

const descPromo=bruto-comPromo;
const descPix=(pagamento==='Pix')?comPromo*(configEmpresa.descontoPix/100):0;
const total=comPromo-descPix;

document.getElementById('subtotalTxt').innerText=fM(bruto);
document.getElementById('totalTxt').innerText=fM(total);
document.getElementById('pesoTotal').innerText=fP(peso);
document.getElementById('totalSkus').innerText=carrinho.length;
document.getElementById('totalPecas').innerText=pecas;

window.resumoFinal={
total:Number(total.toFixed(2)),
descontoPromo:Number(descPromo.toFixed(2)),
descontoPix:Number(descPix.toFixed(2)),
pesoTotal:Number(peso.toFixed(2))
};
}

function setPagamento(p,el){
pagamento=p;
document.querySelectorAll('.pay-btn').forEach(b=>b.classList.remove('active'));
el.classList.add('active');
carregarCarrinho();
}

async function finalizarPedido(){
if(!pagamento||!document.getElementById('nomeCliente').value)return alert("Preencha os dados.");
await db.ref('orders').push({
cliente:{nome:nomeCliente.value,telefone:telefoneCliente.value},
entrega:{nomeEntrega:nomeEntrega.value,rua:rua.value,num:num.value,bairro:bairro.value,cidade:cidade.value,cep:cepEntrega.value},
pagamento,
itens:carrinho,
pesoTotal:window.resumoFinal.pesoTotal,
descontoPromo:window.resumoFinal.descontoPromo,
descontoPix:window.resumoFinal.descontoPix,
total:window.resumoFinal.total,
data:new Date().toLocaleString('pt-BR'),
status:"Novo"
});
localStorage.removeItem('carrinho');
window.location.href=`https://api.whatsapp.com/send?phone=${foneLoja}&text=Pedido realizado`;
}
</script>

</body>
</html>
