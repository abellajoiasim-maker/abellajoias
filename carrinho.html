<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Finalizar Pedido ‚Ä¢ Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

<style>
    body { font-family: 'Poppins', sans-serif; background: #0b0b0b; color: #eee; margin:0; }
    .serif { font-family: 'Cinzel', serif; }
    .gold-text { color: #caa85c; }
    .gold-bg { background: #caa85c; }
    header { background: #000; border-bottom: 1px solid #222; }
    .card { background: #141414; border-radius: 18px; border: 1px solid #2a2a2a; padding: 20px; margin-bottom: 20px; }
    .item { display: flex; gap: 14px; border: 1px solid #222; border-radius: 14px; padding: 12px; align-items: center; background: #0d0d0d; margin-bottom: 10px;}
    .item img { width: 60px; height: 60px; object-fit: cover; border-radius: 10px; border: 1px solid #333; }
    .qtd-btn { background: #222; color: #caa85c; border: 1px solid #caa85c; width: 28px; height: 28px; border-radius: 6px; font-weight: bold; }
    .remove-btn { color: #ff4444; font-size: 10px; font-weight: bold; margin-top: 8px; cursor: pointer; text-transform: uppercase; }
    .pay-btn { border: 1px solid #333; border-radius: 14px; padding: 16px; text-align: center; cursor: pointer; font-weight: bold; text-transform: uppercase; color: #888; }
    .pay-btn.active { border-color: #caa85c; color: #caa85c; background: #1a1610; }
    input { background: #000 !important; border: 1px solid #333 !important; color: #fff !important; padding: 12px; border-radius: 10px; width: 100%; outline: none; margin-bottom: 12px; }
    input:focus { border-color: #caa85c !important; }
</style>
</head>

<body>

<header class="sticky top-0 z-50">
    <div class="max-w-xl mx-auto p-4 flex justify-between items-center">
        <button onclick="history.back()" class="text-[10px] font-bold uppercase gold-text">‚Üê Voltar</button>
        <h1 class="serif gold-text uppercase text-sm tracking-widest">Finalizar Pedido</h1>
    </div>
</header>

<main class="max-w-xl mx-auto p-4 pb-40">
    <div class="card">
        <h2 class="serif gold-text uppercase text-xs mb-4 tracking-widest">Itens do Pedido</h2>
        <div id="listaItens"></div>
    </div>

    <div class="card">
        <h2 class="serif gold-text uppercase text-xs mb-4 tracking-widest">Dados do Cliente</h2>
        <input id="nomeCliente" placeholder="Seu Nome Completo *">
        <input id="telefoneCliente" placeholder="WhatsApp (DDD + N√∫mero) *">
        <input id="rua" placeholder="Endere√ßo Completo (Rua, N¬∫, Bairro, Cidade)">
    </div>

    <div class="card">
        <h2 class="serif gold-text uppercase text-xs mb-4 tracking-widest">Forma de Pagamento</h2>
        <div class="grid grid-cols-2 gap-4">
            <div class="pay-btn" onclick="setPagamento('Pix', this)">Pix</div>
            <div class="pay-btn" onclick="setPagamento('Cart√£o', this)">Cart√£o</div>
        </div>
    </div>

    <div class="card text-sm space-y-3">
        <div class="flex justify-between text-gray-400 font-light">
            <span>Peso Total:</span>
            <b id="pesoTotal" class="text-white">0.00g</b>
        </div>
        <div class="flex justify-between text-gray-400 font-light">
            <span>Subtotal:</span>
            <b id="subtotalTxt" class="text-white">R$ 0,00</b>
        </div>
        <div class="flex justify-between text-red-500 font-light">
            <span>Descontos Totais:</span>
            <b id="descontoTxt">R$ 0,00</b>
        </div>
        <div class="flex justify-between text-gray-300 border-t border-[#222] pt-2 italic">
            <span id="labelParcelas">Parcelamento:</span>
            <b id="parcelasTxt">R$ 0,00</b>
        </div>
        <div class="flex justify-between text-xl font-bold gold-text mt-2 pt-2 border-t border-[#caa85c]">
            <span>TOTAL:</span>
            <span id="totalTxt">R$ 0,00</span>
        </div>
    </div>
</main>

<footer class="fixed bottom-0 left-0 right-0 p-4 bg-black/80 backdrop-blur-lg">
    <div class="max-w-xl mx-auto">
        <button onclick="finalizarPedido()" class="w-full gold-bg text-black py-4 rounded-xl font-bold uppercase tracking-widest shadow-lg">
            Finalizar via WhatsApp
        </button>
    </div>
</footer>

<div class="card">
    <h2 class="serif gold-text uppercase text-xs mb-4 tracking-widest">Dados do Cliente</h2>
    <input id="nomeCliente" placeholder="Seu Nome Completo *">
    <input id="telefoneCliente" placeholder="WhatsApp (DDD + N√∫mero) *">

    <p class="mt-2 text-[10px] uppercase gold-text font-bold mb-2">Endere√ßo de Entrega (Opcional)</p>
    <input id="nomeEntrega" placeholder="Nome do Destinat√°rio">
    <input id="cepEntrega" placeholder="CEP">
    <input id="rua" placeholder="Rua / Avenida">
    <div class="grid grid-cols-3 gap-2">
        <input id="num" placeholder="N¬∫">
        <input id="bairro" placeholder="Bairro" class="col-span-2">
    </div>
    <input id="cidade" placeholder="Cidade">
</div>

<script>
// ... (mantenha as fun√ß√µes de carregarCarrinho e setPagamento enviadas anteriormente)

async function finalizarPedido(){
    const nome = document.getElementById('nomeCliente').value;
    const totalF = document.getElementById('totalTxt').innerText;

    if(!nome || !pagamento) return alert("Por favor, preencha seu Nome e a Forma de Pagamento.");
    if(carrinho.length === 0) return alert("Carrinho vazio.");

    // Captura detalhada dos dados de entrega que estavam ocultos
    const enderecoDB = {
        destinatario: document.getElementById('nomeEntrega').value || 'N√£o informado',
        cep: document.getElementById('cepEntrega').value || 'N√£o informado',
        rua: document.getElementById('rua').value || '',
        num: document.getElementById('num').value || '',
        bairro: document.getElementById('bairro').value || '',
        cidade: document.getElementById('cidade').value || ''
    };

    try {
        // Guarda no Firebase com os dados de entrega completos e o peso
        await db.ref('orders').push({
            cliente: nome,
            whats: document.getElementById('telefoneCliente').value,
            total: totalF,
            pagamento: pagamento,
            peso: window.pesoTotalFinal + 'g',
            itens: carrinho,
            endereco: enderecoDB,
            data: new Date().toLocaleString('pt-BR')
        });

        // Monta a mensagem para o WhatsApp incluindo a cidade para facilitar o frete
        let msg = `*NOVO PEDIDO - ABELLA JOIAS*\n\n`;
        msg += `üë§ *Cliente:* ${nome}\n`;
        msg += `üìç *Cidade:* ${enderecoDB.cidade || 'N√£o informada'}\n`;
        msg += `‚öñÔ∏è *Peso Total:* ${window.pesoTotalFinal}g\n`;
        msg += `üí≥ *Pagamento:* ${pagamento}\n`;
        msg += `üí∞ *TOTAL FINAL:* ${totalF}\n\n`;
        msg += `*Itens:* ${carrinho.length} produtos.\n\n`;
        msg += `Aguardando confirma√ß√£o de stock!`;

        localStorage.removeItem('carrinho');
        window.location.href = `https://api.whatsapp.com/send?phone=${foneLoja}&text=${encodeURIComponent(msg)}`;
    } catch(e) { 
        console.error(e);
        alert("Erro ao salvar o pedido."); 
    }
}
</script>
</body>
</html>
