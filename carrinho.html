<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Finalizar Pedido ‚Ä¢ Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

<style>
    body { font-family: 'Poppins', sans-serif; background: #0b0b0b; color: #eee; margin:0; }
    .serif { font-family: 'Cinzel', serif; }
    .gold-text { color: #caa85c; }
    .gold-bg { background: #caa85c; }
    header { background: #000; border-bottom: 1px solid #222; }
    .card { background: #141414; border-radius: 18px; border: 1px solid #2a2a2a; padding: 20px; margin-bottom: 20px; }
    .item { display: flex; gap: 14px; border-bottom: 1px solid #222; padding: 12px 0; align-items: center; }
    .item img { width: 60px; height: 60px; object-fit: cover; border-radius: 10px; border: 1px solid #333; }
    .qtd-btn { background: #222; color: #caa85c; border: 1px solid #caa85c; width: 28px; height: 28px; border-radius: 6px; font-weight: bold; }
    .pay-btn { border: 1px solid #333; border-radius: 14px; padding: 16px; text-align: center; cursor: pointer; font-weight: bold; text-transform: uppercase; color: #888; transition: all 0.3s; }
    .pay-btn.active { border-color: #caa85c; color: #caa85c; background: #1a1610; transform: scale(1.02); }
    input { background: #000 !important; border: 1px solid #333 !important; color: #fff !important; padding: 12px; border-radius: 10px; width: 100%; outline: none; margin-bottom: 12px; font-size: 14px; }
    input:focus { border-color: #caa85c !important; }
    .price-old { text-decoration: line-through; color: #777; font-size: 0.85em; }
    .promo-highlight { color: #ff4d94; font-weight: 600; } /* Cor para promo√ß√µes de cat√°logo */
</style>
</head>

<body>

<header class="sticky top-0 z-50 bg-black/90 backdrop-blur-md">
    <div class="max-w-xl mx-auto p-4 flex justify-between items-center">
        <button onclick="history.back()" class="text-[10px] font-bold uppercase gold-text">‚Üê Voltar</button>
        <h1 class="serif gold-text uppercase text-sm tracking-widest">Finalizar Pedido</h1>
    </div>
</header>

<main class="max-w-xl mx-auto p-4 pb-40">

    <div class="card">
        <h2 class="serif gold-text uppercase text-xs mb-2 tracking-widest border-b border-[#222] pb-2">Seus Itens</h2>
        <div id="listaItens"></div>

        <div class="mt-6 pt-4 border-t border-[#222]">
            <div class="grid grid-cols-3 gap-2">
                <div class="bg-[#000] p-3 rounded-xl border border-[#222] text-center">
                    <span class="block text-[8px] uppercase text-gray-500 font-bold mb-1">Modelos</span>
                    <b id="totalSkus" class="text-lg text-white font-mono">0</b>
                </div>
                <div class="bg-[#000] p-3 rounded-xl border border-[#222] text-center">
                    <span class="block text-[8px] uppercase text-gray-500 font-bold mb-1">Pe√ßas</span>
                    <b id="totalPecas" class="text-lg text-white font-mono">0</b>
                </div>
                <div class="bg-[#000] p-3 rounded-xl border border-[#caa85c]/30 text-center">
                    <span class="block text-[8px] uppercase gold-text font-bold mb-1">Peso Total</span>
                    <b id="pesoTotal" class="text-lg text-white font-mono">0,00g</b>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 class="serif gold-text uppercase text-xs mb-4 tracking-widest border-b border-[#222] pb-2">Identifica√ß√£o</h2>
        <input id="nomeCliente" placeholder="Seu Nome Completo *">
        <input id="telefoneCliente" placeholder="WhatsApp (DDD + N√∫mero) *">
        
        <p class="mt-4 text-[10px] uppercase gold-text font-bold mb-2 text-center opacity-60 italic tracking-widest">Endere√ßo de Envio (Opcional)</p>
        <input id="nomeEntrega" placeholder="Nome do Destinat√°rio">
        <input id="cepEntrega" placeholder="CEP">
        <input id="rua" placeholder="Rua / Avenida">
        <div class="grid grid-cols-3 gap-2">
            <input id="num" placeholder="N¬∫">
            <input id="bairro" placeholder="Bairro" class="col-span-2">
        </div>
        <input id="cidade" placeholder="Cidade">
    </div>

    <div class="card">
        <h2 class="serif gold-text uppercase text-xs mb-4 tracking-widest border-b border-[#222] pb-2">Forma de Pagamento</h2>
        <div class="grid grid-cols-2 gap-4">
            <div class="pay-btn" onclick="setPagamento('Pix', this)">
                <span class="block text-lg">Pix</span>
                <span class="text-[9px] text-green-500 font-bold">Desconto Ativo</span>
            </div>
            <div class="pay-btn" onclick="setPagamento('Cart√£o', this)">
                <span class="block text-lg">Cart√£o</span>
                <span class="text-[9px] text-blue-400 font-bold">At√© 3x s/ Juros</span>
            </div>
        </div>
    </div>

    <div class="card space-y-4">
        <h2 class="serif gold-text uppercase text-xs mb-2 tracking-widest border-b border-[#222] pb-2">Resumo Financeiro</h2>
        
        <div class="space-y-3 text-sm">
            <div class="flex justify-between text-gray-400 px-1">
                <span>Subtotal dos Itens:</span>
                <b id="subtotalTxt" class="text-white">R$ 0,00</b>
            </div>

            <div id="blocoPromoCatalogo" class="hidden space-y-2 border-t border-[#222] pt-2">
                <div class="flex justify-between promo-highlight italic">
                    <span id="nomePromoCatalogo">Desconto Promocional:</span>
                    <b id="valorDescontoPromo">- R$ 0,00</b>
                </div>
                <div class="flex justify-between text-gray-300 font-medium">
                    <span>Pre√ßo de Cat√°logo:</span>
                    <b id="subtotalComPromo">R$ 0,00</b>
                </div>
            </div>

            <div id="infoBeneficios" class="space-y-2 border-t border-[#222] pt-2 hidden">
                <div id="linhaDescontoPix" class="flex justify-between text-green-500 italic">
                    <span>B√¥nus Extra (Pix):</span>
                    <b id="valorDescontoPix">- R$ 0,00</b>
                </div>
                <div id="linhaParcelas" class="flex justify-between text-blue-400 italic">
                    <span>Parcelamento:</span>
                    <b id="valorParcelas">3x sem juros</b>
                </div>
            </div>

            <div class="flex flex-col items-end mt-4 pt-3 border-t-2 border-[#caa85c]">
                <span id="precoBrutoRiscado" class="price-old hidden">R$ 0,00</span>
                <div class="flex justify-between w-full items-center">
                    <span class="text-xl font-bold gold-text uppercase">Total a Pagar:</span>
                    <span id="totalTxt" class="text-2xl font-bold gold-text">R$ 0,00</span>
                </div>
            </div>
        </div>
    </div>

</main>

<footer class="fixed bottom-0 left-0 right-0 p-4 bg-black/80 backdrop-blur-lg border-t border-[#222] z-50">
    <div class="max-w-xl mx-auto">
        <button onclick="finalizarPedido()" class="w-full gold-bg text-black py-4 rounded-xl font-bold uppercase tracking-widest shadow-lg active:scale-95 transition">
            Finalizar via WhatsApp
        </button>
    </div>
</footer>

<script>
if (!firebase.apps.length) {
    firebase.initializeApp({
        apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com"
    });
}
const db = firebase.database();

let carrinho = JSON.parse(localStorage.getItem('carrinho')||'[]');
let pagamento = '';
let foneLoja = '';
let configEmpresa = { descontoPix: 0, parcelas: 3 };

const fM = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
const fP = (v) => v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + 'g';

db.ref('settings/empresa').once('value', s => { 
    const v = s.val();
    if(v) {
        foneLoja = v.whats ? v.whats.replace(/\D/g,'') : '';
        configEmpresa.descontoPix = parseFloat(v.descontoPix) || 0;
        configEmpresa.parcelas = parseInt(v.parcelas) || 3;
    }
    carregarCarrinho();
});

function carregarCarrinho(){
    let box = document.getElementById('listaItens');
    box.innerHTML = '';
    let subtotalBrutoSemNada = 0;
    let subtotalComPromoCatalogo = 0;
    let pesoTotal = 0;
    let somaPecas = 0;
    let nomePromoDetectado = "Desconto Promocional";

    carrinho.forEach((i, index) => {
        let q = parseInt(i.quantidade) || 1;
        let pOriginal = parseFloat(i.price || i.precoFinal || 0);
        let pFinalCat = parseFloat(i.precoFinal || i.price || 0);
        
        // Tenta capturar o nome da categoria ou promo√ß√£o se existir no item
        if(i.category && pOriginal > pFinalCat) nomePromoDetectado = "Desconto " + i.category;

        subtotalBrutoSemNada += (pOriginal * q);
        subtotalComPromoCatalogo += (pFinalCat * q);
        
        let pUnitPeso = i.peso || i.weight || 0;
        if(typeof pUnitPeso === 'string') pUnitPeso = parseFloat(pUnitPeso.replace(',', '.')) || 0;
        pesoTotal += (pUnitPeso * q);
        somaPecas += q;

        box.innerHTML += `
            <div class="item">
                <img src="${i.image || ''}">
                <div class="flex-1">
                    <b class="text-[12px] uppercase text-white">${i.name}</b><br>
                    <small class="text-gray-500 text-[10px]">Peso: ${fP(pUnitPeso)}</small>
                    <div class="flex items-center gap-3 mt-2">
                        <button class="qtd-btn" onclick="alterarQtd(${index},-1)">-</button>
                        <span class="font-bold text-sm">${q}</span>
                        <button class="qtd-btn" onclick="alterarQtd(${index},1)">+</button>
                    </div>
                </div>
                <div class="text-right">
                    ${pOriginal > pFinalCat ? `<span class="price-old block text-[10px]">${fM(pOriginal * q)}</span>` : ''}
                    <b class="gold-text text-sm">${fM(pFinalCat * q)}</b>
                </div>
            </div>`;
    });

    const economiaCatalogo = subtotalBrutoSemNada - subtotalComPromoCatalogo;
    const economiaPix = (pagamento === 'Pix') ? subtotalComPromoCatalogo * (configEmpresa.descontoPix / 100) : 0;
    const valorFinalReal = subtotalComPromoCatalogo - economiaPix;

    // UI Updates
    document.getElementById('totalSkus').innerText = carrinho.length;
    document.getElementById('totalPecas').innerText = somaPecas;
    document.getElementById('pesoTotal').innerText = fP(pesoTotal);
    document.getElementById('subtotalTxt').innerText = fM(subtotalBrutoSemNada);
    document.getElementById('totalTxt').innerText = fM(valorFinalReal);
    
    // Logica de Exibi√ß√£o do Bloco de Promo√ß√£o de Cat√°logo
    const blocoPromo = document.getElementById('blocoPromoCatalogo');
    const precoRiscadoFinal = document.getElementById('precoBrutoRiscado');
    
    if(economiaCatalogo > 0) {
        blocoPromo.classList.remove('hidden');
        document.getElementById('nomePromoCatalogo').innerText = nomePromoDetectado + ":";
        document.getElementById('valorDescontoPromo').innerText = `- ${fM(economiaCatalogo)}`;
        document.getElementById('subtotalComPromo').innerText = fM(subtotalComPromoCatalogo);
        precoRiscadoFinal.classList.remove('hidden');
        precoRiscadoFinal.innerText = fM(subtotalBrutoSemNada);
    } else {
        blocoPromo.classList.add('hidden');
        precoRiscadoFinal.classList.add('hidden');
    }

    // L√≥gica de Pagamento
    const infoPag = document.getElementById('infoBeneficios');
    if(pagamento !== ''){
        infoPag.classList.remove('hidden');
        if(pagamento === 'Pix'){
            document.getElementById('linhaDescontoPix').classList.remove('hidden');
            document.getElementById('linhaParcelas').classList.add('hidden');
            document.getElementById('valorDescontoPix').innerText = `- ${fM(economiaPix)}`;
        } else {
            document.getElementById('linhaParcelas').classList.remove('hidden');
            document.getElementById('linhaDescontoPix').classList.add('hidden');
            document.getElementById('valorParcelas').innerText = `${configEmpresa.parcelas}x de ${fM(valorFinalReal/configEmpresa.parcelas)}`;
        }
    }

    window.resumoTotal = { peso: pesoTotal, skus: carrinho.length, pecas: somaPecas, economia: economiaCatalogo + economiaPix, total: valorFinalReal };
}

function setPagamento(p, el){
    pagamento = p;
    document.querySelectorAll('.pay-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    carregarCarrinho();
}

function alterarQtd(index, delta){
    carrinho[index].quantidade = (carrinho[index].quantidade || 1) + delta;
    if(carrinho[index].quantidade < 1) {
        if(confirm("Remover item?")) carrinho.splice(index, 1);
        else carrinho[index].quantidade = 1;
    }
    localStorage.setItem('carrinho', JSON.stringify(carrinho));
    carregarCarrinho();
}

async function finalizarPedido(){
    const nome = document.getElementById('nomeCliente').value;
    if(!nome || !pagamento) return alert("Preencha Nome e Pagamento.");

    try {
        await db.ref('orders').push({
            cliente: nome,
            total: fM(window.resumoTotal.total),
            pagamento: pagamento,
            pesoTotal: fP(window.resumoTotal.peso),
            quantidadePecas: window.resumoTotal.pecas,
            itens: carrinho,
            data: new Date().toLocaleString('pt-BR')
        });

        let msg = `Ol√°, meu nome √© *${nome}*!\n\n`;
        msg += `Fiz um pedido na Abella Joias:\n\n`;
        msg += `üì¶ *Pe√ßas:* ${window.resumoTotal.pecas}\n`;
        msg += `‚öñÔ∏è *Peso:* ${fP(window.resumoTotal.peso)}\n`;
        msg += `üí∞ *Total:* ${fM(window.resumoTotal.total)}\n`;
        msg += `üí≥ *Pagamento:* ${pagamento}\n`;
        if(window.resumoTotal.economia > 0) msg += `‚ú® *Economia Total:* ${fM(window.resumoTotal.economia)}\n`;
        msg += `\nAguardando seu retorno!`;

        localStorage.removeItem('carrinho');
        window.location.href = `https://api.whatsapp.com/send?phone=${foneLoja}&text=${encodeURIComponent(msg)}`;
    } catch(e) { alert("Erro ao enviar pedido."); }
}
</script>
</body>
</html>
