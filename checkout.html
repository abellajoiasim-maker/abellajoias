<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checkout | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>

<body class="bg-neutral-50 p-6 max-w-xl mx-auto">

<h1 class="text-xl font-serif mb-4 text-center">Finalizar Pedido</h1>

<input id="cliente" placeholder="Nome" class="border p-3 w-full mb-3">
<input id="whatsapp" placeholder="WhatsApp" class="border p-3 w-full mb-4">

<button onclick="finalizar()"
  class="bg-black text-white w-full py-3 tracking-widest">
ENVIAR PEDIDO
</button>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});
const db = firebase.database();

const cart = JSON.parse(localStorage.getItem("cart")) || [];
const pagamento = localStorage.getItem("payment") || "PIX";

function finalizar(){
  if(cart.length===0) return alert("Carrinho vazio");

  const nome = cliente.value.trim();
  const tel = whatsapp.value.trim();
  if(!nome || !tel) return alert("Preencha os dados");

  let total = 0;
  let peso = 0;

  cart.forEach(i=>{
    total += i.price * i.qty;
    peso += (i.weight||0) * i.qty;
  });

  const pedido = {
    cliente: nome,
    whatsapp: tel,
    data: new Date().toLocaleString("pt-BR"),
    total,
    peso,
    pagamento,
    status: "Novo",
    itens: cart
  };

  db.ref("orders").push(pedido);

  let msg = `âœ¨ Pedido Abella Joias âœ¨%0A%0ACliente: ${nome}%0A%0A`;
  cart.forEach(i=>{
    msg += `${i.qty}x ${i.name}%0A`;
  });

  msg += `%0ATotal: R$ ${total.toFixed(2)}`;
  msg += `%0APeso total: ${peso}g`;
  msg += `%0A%0ARecebemos seu pedido! Em breve entraremos em contato para finalizar ðŸ’Ž`;

  localStorage.removeItem("cart");

  window.open(`https://wa.me/55${tel}?text=${msg}`);
}
</script>

</body>
</html>
