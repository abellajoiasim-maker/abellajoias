<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checkout | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.font-serif{font-family:'Cinzel',serif}
.gold{color:#A68966}
</style>
</head>

<body class="max-w-xl mx-auto p-6 space-y-6">

<h1 class="font-serif text-2xl text-center gold">Finalizar Pedido</h1>

<!-- DADOS CLIENTE -->
<div class="bg-white border p-4 space-y-3">
  <input id="nome" placeholder="Seu nome" class="border p-3 w-full">
  <input id="whats" placeholder="WhatsApp (somente nÃºmeros)" class="border p-3 w-full">
</div>

<!-- PAGAMENTO -->
<div class="bg-white border p-4 space-y-3">
  <p class="font-semibold">Forma de pagamento</p>

  <label class="flex items-center gap-2">
    <input type="radio" name="pagamento" value="PIX" checked>
    PIX (com desconto)
  </label>

  <label class="flex items-center gap-2">
    <input type="radio" name="pagamento" value="CARTAO">
    CartÃ£o
  </label>
</div>

<!-- RESUMO -->
<div class="bg-white border p-4 space-y-2 text-sm">
  <p>Subtotal: R$ <span id="subtotal">0.00</span></p>
  <p id="linhaDesconto" class="text-green-600 hidden">
    Desconto PIX: -R$ <span id="descontoPix">0.00</span>
  </p>
  <p>Peso total: <span id="pesoTotal">0</span> g</p>
  <p class="text-lg font-semibold">
    Total: R$ <span id="total">0.00</span>
  </p>
</div>

<button onclick="finalizar()"
  class="bg-black text-white w-full py-4 tracking-widest text-xs">
FINALIZAR NO WHATSAPP
</button>

<script>
/* ðŸ”¥ FIREBASE â€” ABELLA JOIAS */
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});

const db = firebase.database();

/* ðŸ”§ CONFIGURAÃ‡Ã•ES */
const descontoPixPerc = 5;       // % desconto PIX
const parcelas = 3;              // parcelamento cartÃ£o
const whatsappLoja = "5511999999999"; // <<< TROQUE AQUI

/* ðŸ›’ CARRINHO */
const carrinho = JSON.parse(localStorage.getItem('cart')) || [];

const subtotalEl = document.getElementById('subtotal');
const descontoEl = document.getElementById('descontoPix');
const linhaDesconto = document.getElementById('linhaDesconto');
const totalEl = document.getElementById('total');
const pesoTotalEl = document.getElementById('pesoTotal');

function calcular(){
  let subtotal = 0;
  let peso = 0;

  carrinho.forEach(i=>{
    subtotal += i.price * i.qty;
    peso += (i.weight||0) * i.qty;
  });

  subtotalEl.textContent = subtotal.toFixed(2);
  pesoTotalEl.textContent = peso;

  const pagamento = document.querySelector('[name=pagamento]:checked').value;

  if(pagamento==='PIX'){
    const desc = subtotal * (descontoPixPerc/100);
    descontoEl.textContent = desc.toFixed(2);
    linhaDesconto.classList.remove('hidden');
    totalEl.textContent = (subtotal-desc).toFixed(2);
  }else{
    linhaDesconto.classList.add('hidden');
    totalEl.textContent = subtotal.toFixed(2);
  }
}

document.querySelectorAll('[name=pagamento]').forEach(r=>{
  r.onchange = calcular;
});

calcular();

/* âœ… FINALIZAR PEDIDO */
function finalizar(){
  const nome = document.getElementById('nome').value.trim();
  const whatsCliente = document.getElementById('whats').value.trim();
  const pagamento = document.querySelector('[name=pagamento]:checked').value;

  if(!nome || !whatsCliente){
    alert('Preencha nome e WhatsApp');
    return;
  }

  let subtotal = 0;
  let pesoTotal = 0;
  let msg = `ðŸ›ï¸ *NOVO PEDIDO â€” ABELLA JOIAS*%0A%0A`;
  msg += `ðŸ‘¤ *Cliente:* ${nome}%0A`;
  msg += `ðŸ“± *WhatsApp:* ${whatsCliente}%0A%0A`;
  msg += `ðŸ“¦ *Itens:*%0A`;

  carrinho.forEach(i=>{
    subtotal += i.price * i.qty;
    pesoTotal += (i.weight||0) * i.qty;
    msg += `â€¢ ${i.qty}x ${i.name}%0A`;
  });

  let totalFinal = subtotal;

  if(pagamento==='PIX'){
    const desc = subtotal * (descontoPixPerc/100);
    totalFinal = subtotal-desc;
    msg += `%0AðŸ’¸ *Desconto PIX (${descontoPixPerc}%):* -R$ ${desc.toFixed(2)}%0A`;
  }else{
    msg += `%0AðŸ’³ *CartÃ£o:* ${parcelas}x de R$ ${(subtotal/parcelas).toFixed(2)}%0A`;
  }

  msg += `âš–ï¸ *Peso total:* ${pesoTotal}g%0A`;
  msg += `ðŸ’° *Total:* R$ ${totalFinal.toFixed(2)}%0A%0A`;
  msg += `âœ¨ Obrigado por comprar na *Abella Joias*!%0A`;
  msg += `Em breve nossa equipe entrarÃ¡ em contato para finalizar seu pedido.`;

  const pedido = {
    cliente: nome,
    whatsapp: whatsCliente,
    data: new Date().toLocaleString('pt-BR'),
    itens: carrinho,
    pagamento,
    total: totalFinal,
    pesoTotal,
    status:'Novo'
  };

  db.ref('orders').push(pedido).then(()=>{
    localStorage.removeItem('cart');
    window.open(`https://wa.me/${whatsappLoja}?text=${msg}`, '_blank');
    alert('Pedido enviado com sucesso ðŸ’›');
    window.location.href = 'index.html';
  });
}
</script>

</body>
</html>
