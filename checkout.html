<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checkout | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.gold{color:#A68966}
.font-serif{font-family:'Cinzel',serif}
</style>
</head>

<body class="max-w-xl mx-auto p-4">

<h1 class="font-serif gold text-xl mb-4 text-center">Finalizar Pedido</h1>

<!-- CLIENTE -->
<div class="bg-white border p-4 space-y-2 mb-4">
  <input id="nome" placeholder="Nome completo" class="border p-2 w-full">
  <input id="whats" placeholder="WhatsApp (somente n√∫meros)" class="border p-2 w-full">
</div>

<!-- CARRINHO -->
<div id="listaCarrinho" class="space-y-3"></div>

<!-- TOTAIS -->
<div class="bg-white border p-4 mt-4 space-y-1 text-sm">
  <p>Subtotal: R$ <span id="subtotal">0.00</span></p>
  <p id="linhaPix" class="hidden text-green-600"></p>
  <p>Peso total: <strong><span id="pesoTotal">0</span>g</strong></p>
  <p class="text-lg font-bold">Total: R$ <span id="total">0.00</span></p>
</div>

<!-- PAGAMENTO -->
<div class="bg-white border p-4 mt-4">
  <select id="pagamento" class="border p-2 w-full">
    <option value="PIX">PIX</option>
    <option id="opCartao" value="CARTAO">Cart√£o</option>
  </select>
</div>

<button onclick="finalizarPedido()" class="bg-black text-white w-full py-3 mt-4 tracking-widest text-xs">
FINALIZAR NO WHATSAPP
</button>

<script>
/* üî• FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});
const db = firebase.database();

/* ELEMENTOS */
const subtotalEl = document.getElementById('subtotal');
const totalEl = document.getElementById('total');
const pesoTotalEl = document.getElementById('pesoTotal');
const linhaPix = document.getElementById('linhaPix');
const pagamento = document.getElementById('pagamento');
const listaCarrinho = document.getElementById('listaCarrinho');

let carrinho = JSON.parse(localStorage.getItem('cart')) || [];
let pixDesconto = 0;
let parcelas = 1;
let whatsappLoja = "";

/* CONFIG EMPRESA */
db.ref('settings').once('value').then(s=>{
  if(!s.val()) return;
  pixDesconto = Number(s.val().pix || 0);
  parcelas = Number(s.val().parcelas || 1);
  whatsappLoja = s.val().whatsapp || '';
  document.getElementById('opCartao').textContent =
    `Cart√£o (${parcelas}x sem acr√©scimo)`;
  calcularTotais();
});

/* RENDER CARRINHO */
function renderCarrinho(){
  listaCarrinho.innerHTML='';
  carrinho.forEach((i,idx)=>{
    listaCarrinho.innerHTML+=`
      <div class="bg-white border p-3 flex gap-3 items-center">
        <img src="${i.image}" class="w-16 h-16 object-cover border rounded">
        <div class="flex-1">
          <p class="font-medium">${i.name}</p>
          <p class="text-xs">SKU: ${i.sku} ‚Ä¢ ${i.weight}g</p>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="alterarQtd(${idx},-1)" class="border px-2">-</button>
          <span>${i.qty}</span>
          <button onclick="alterarQtd(${idx},1)" class="border px-2">+</button>
        </div>
      </div>`;
  });
}

/* ALTERAR QTD */
function alterarQtd(i,delta){
  carrinho[i].qty+=delta;
  if(carrinho[i].qty<=0) carrinho.splice(i,1);
  localStorage.setItem('cart',JSON.stringify(carrinho));
  renderCarrinho();
  calcularTotais();
}

/* CALCULAR */
function calcularTotais(){
  let sub=0,peso=0;
  carrinho.forEach(i=>{
    sub+=i.price*i.qty;
    peso+=i.weight*i.qty;
  });

  subtotalEl.textContent=sub.toFixed(2);
  pesoTotalEl.textContent=peso;

  let total=sub;
  linhaPix.classList.add('hidden');

  if(pagamento.value==='PIX' && pixDesconto>0){
    const d=sub*(pixDesconto/100);
    total=sub-d;
    linhaPix.textContent=`Desconto PIX (${pixDesconto}%): -R$ ${d.toFixed(2)}`;
    linhaPix.classList.remove('hidden');
  }

  totalEl.textContent=total.toFixed(2);
}

/* FINALIZAR */
function finalizarPedido(){
  if(carrinho.length===0) return alert('Carrinho vazio');
  if(!nome.value||!whats.value) return alert('Preencha os dados');

  const pedido={
    cliente: nome.value,
    customer: nome.value, // compatibilidade painel
    whatsapp: whats.value,
    data: new Date().toLocaleString('pt-BR'),
    status: 'Novo',
    pagamento: pagamento.value,
    parcelas: pagamento.value==='CARTAO'
      ? `${parcelas}x sem acr√©scimo`
      : '√Ä vista',
    peso: Number(pesoTotalEl.textContent),
    total: Number(totalEl.textContent),
    itens: carrinho.map(i=>({
      nome: i.name,
      sku: i.sku,
      qtd: i.qty,
      valor: i.price,
      peso: i.weight
    }))
  };

  db.ref('orders').push(pedido);
  localStorage.removeItem('cart');

  let msg=`Pedido de *${pedido.cliente}*:%0A`;
  pedido.itens.forEach(i=>{
    msg+=`${i.qtd}x ${i.nome}%0A`;
  });
  msg+=`%0ATotal: R$ ${pedido.total}%0APagamento: ${pedido.pagamento}`;

  window.open(`https://wa.me/55${whatsappLoja}?text=${msg}`);
}

/* INIT */
pagamento.onchange = calcularTotais;
renderCarrinho();
calcularTotais();
</script>

</body>
</html>
