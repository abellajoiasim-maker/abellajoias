<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Finalizar Pedido | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.gold{color:#A68966}
.font-serif{font-family:'Cinzel',serif}
</style>
</head>

<body class="max-w-xl mx-auto p-4 relative">

<!-- BOTÃƒO VOLTAR -->
<a href="index.html"
 class="fixed bottom-6 left-6 bg-black text-white px-4 py-2 rounded-full shadow-lg z-50">
â¬… Voltar
</a>

<h1 class="font-serif text-xl gold mb-4 text-center">Finalizar Pedido</h1>

<div class="space-y-4" id="cartItens"></div>

<div class="bg-white p-4 border mt-4 space-y-2 text-sm">
  <p>Total cheio: R$ <span id="totalCheio">0.00</span></p>
  <p class="text-green-700">PIX (<span id="pixPerc">0</span>% OFF):  
     R$ <span id="totalPix">0.00</span></p>
  <p>CartÃ£o: <span id="parcelasTxt"></span></p>
  <p class="font-semibold">Peso total: <span id="pesoTotal">0</span> g</p>
  <p class="font-bold text-lg">Total final: R$ <span id="totalFinal">0.00</span></p>
</div>

<input id="nome" placeholder="Nome completo"
 class="border p-3 w-full mt-4">

<input id="whats" placeholder="WhatsApp (somente nÃºmeros)"
 class="border p-3 w-full mt-2">

<select id="pagamento" class="border p-3 w-full mt-2">
  <option value="PIX">PIX</option>
  <option value="CARTAO">CartÃ£o</option>
</select>

<button onclick="finalizarPedido()"
 class="bg-black text-white w-full py-4 mt-4 text-sm tracking-widest">
FINALIZAR PEDIDO
</button>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});
const db = firebase.database();

let cart = JSON.parse(localStorage.getItem("cart")) || [];
let settings = {};
const cartItens = document.getElementById("cartItens");

db.ref("settings").once("value").then(s=>{
  settings = s.val() || {};
  document.getElementById("pixPerc").textContent = settings.pix || 0;
  document.getElementById("parcelasTxt").textContent =
    `${settings.parcelas || 1}x sem acrÃ©scimo`;
  render();
});

function render(){
  cartItens.innerHTML="";
  let total=0, peso=0;

  cart.forEach((i,idx)=>{
    total += i.price * i.qty;
    peso += (i.weight||0) * i.qty;

    cartItens.innerHTML += `
    <div class="bg-white border p-3 flex gap-3">
      <img src="${i.image}" class="w-20 h-20 object-cover">
      <div class="flex-1">
        <p class="font-semibold">${i.name}</p>
        <p class="text-xs">SKU: ${i.sku}</p>
        <p class="text-xs">${i.weight||0}g</p>
        <div class="flex items-center gap-2 mt-1">
          <button onclick="alterar(${idx},-1)">â€“</button>
          <span>${i.qty}</span>
          <button onclick="alterar(${idx},1)">+</button>
        </div>
      </div>
      <strong>R$ ${(i.price*i.qty).toFixed(2)}</strong>
    </div>`;
  });

  const pixDesc = total * ((settings.pix||0)/100);
  document.getElementById("totalCheio").textContent = total.toFixed(2);
  document.getElementById("totalPix").textContent = (total-pixDesc).toFixed(2);
  document.getElementById("totalFinal").textContent =
    (pagamento.value==="PIX" ? total-pixDesc : total).toFixed(2);
  document.getElementById("pesoTotal").textContent = peso;
}

function alterar(i,q){
  cart[i].qty += q;
  if(cart[i].qty<=0) cart.splice(i,1);
  localStorage.setItem("cart",JSON.stringify(cart));
  render();
}

function finalizarPedido(){
  if(!nome.value || !whats.value || cart.length===0){
    alert("Preencha os dados corretamente.");
    return;
  }

  let total=0,peso=0;
  cart.forEach(i=>{
    total+=i.price*i.qty;
    peso+=(i.weight||0)*i.qty;
  });

  const totalFinal = pagamento.value==="PIX"
    ? total-(total*(settings.pix||0)/100)
    : total;

  const pedido={
    cliente:nome.value,
    whatsapp:whats.value,
    pagamento:pagamento.value,
    data:new Date().toLocaleString("pt-BR"),
    itens:cart,
    peso,
    total:totalFinal,
    status:"Novo"
  };

  db.ref("orders").push(pedido);

  let msg=`ðŸ›ï¸ *Pedido Abella Joias*%0A%0A`;
  cart.forEach(i=>{
    msg+=`${i.qty}x ${i.name} (${i.sku})%0A`;
  });
  msg+=`%0AðŸ’³ ${pedido.pagamento}%0AðŸ’° R$ ${totalFinal.toFixed(2)}`;

  window.open(`https://wa.me/${settings.whatsapp}?text=${msg}`);

  alert("âœ… Pedido enviado com sucesso! Em instantes a Abella Joias entrarÃ¡ em contato.");

  localStorage.removeItem("cart");
  window.location.href="index.html";
}
</script>

</body>
</html>
