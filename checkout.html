<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Finalizar Pedido | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.font-serif{font-family:'Cinzel',serif}
.gold{color:#A68966}
</style>
</head>

<body class="max-w-xl mx-auto p-6">

<h1 class="font-serif text-2xl gold text-center mb-6">
Finalizar Pedido
</h1>

<!-- CLIENTE -->
<div class="bg-white border p-4 mb-6 space-y-3">
  <input id="nome" placeholder="Nome completo" class="border p-2 w-full">
  <input id="whats" placeholder="WhatsApp (somente n√∫meros)" class="border p-2 w-full">
</div>

<!-- RESUMO -->
<div class="bg-white border p-4 mb-6">
  <h2 class="font-serif text-lg gold mb-3">Resumo do Pedido</h2>
  <div id="listaItens" class="space-y-2 text-sm"></div>

  <div class="border-t mt-4 pt-4 space-y-1 text-sm">
    <p>Peso total: <strong><span id="pesoTotal">0</span> g</strong></p>
    <p>Subtotal: R$ <span id="subtotal">0.00</span></p>
    <p class="text-green-700">
      Desconto PIX (<span id="pixPerc">0</span>%): - R$ <span id="descontoPix">0.00</span>
    </p>
    <p class="font-bold text-lg">
      Total no PIX: R$ <span id="totalPix">0.00</span>
    </p>
    <p id="parcelamento" class="text-gray-500 text-xs"></p>
  </div>
</div>

<!-- PAGAMENTO -->
<div class="bg-white border p-4 mb-6 space-y-2">
  <label class="flex items-center gap-2">
    <input type="radio" name="pagamento" value="PIX" checked>
    PIX (desconto)
  </label>

  <label class="flex items-center gap-2">
    <input type="radio" name="pagamento" value="CARTAO">
    Cart√£o
  </label>
</div>

<!-- FINALIZAR -->
<button onclick="finalizar()"
  class="bg-black text-white w-full py-3 uppercase tracking-widest text-sm">
Finalizar Pedido
</button>

<script>
/* üî• FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});
const db = firebase.database();

/* DADOS */
const carrinho = JSON.parse(localStorage.getItem('cart')) || [];
let descontoPixPerc = 0;
let parcelas = 1;

/* ELEMENTOS */
const listaItens = document.getElementById('listaItens');

/* CARREGAR CONFIGURA√á√ïES */
db.ref('settings').once('value').then(s=>{
  if(!s.val()) return;
  descontoPixPerc = s.val().pix || 0;
  parcelas = s.val().parcelas || 1;
  document.getElementById('pixPerc').textContent = descontoPixPerc;
  calcular();
});

/* RESUMO */
function calcular(){
  let subtotal=0, peso=0;

  listaItens.innerHTML='';
  carrinho.forEach(i=>{
    subtotal += i.price * i.qty;
    peso += (i.weight||0) * i.qty;

    listaItens.innerHTML+=`
      <div class="flex justify-between">
        <span>${i.qty}x ${i.name}</span>
        <span>R$ ${(i.price*i.qty).toFixed(2)}</span>
      </div>`;
  });

  const descontoPix = subtotal * (descontoPixPerc/100);
  const totalPix = subtotal - descontoPix;

  document.getElementById('pesoTotal').textContent = peso;
  document.getElementById('subtotal').textContent = subtotal.toFixed(2);
  document.getElementById('descontoPix').textContent = descontoPix.toFixed(2);
  document.getElementById('totalPix').textContent = totalPix.toFixed(2);
  document.getElementById('parcelamento').textContent =
    `${parcelas}x de R$ ${(subtotal/parcelas).toFixed(2)} no cart√£o`;
}

calcular();

/* FINALIZAR */
function finalizar(){
  const nome = document.getElementById('nome').value;
  const whats = document.getElementById('whats').value;
  const pagamento = document.querySelector('input[name=pagamento]:checked').value;

  if(!nome || !whats){
    alert('Preencha nome e WhatsApp');
    return;
  }

  const pedido = {
    cliente: nome,
    whatsapp: whats,
    data: new Date().toLocaleString('pt-BR'),
    itens: carrinho,
    pagamento,
    status: 'Novo',
    total: pagamento==='PIX'
      ? Number(document.getElementById('totalPix').textContent)
      : Number(document.getElementById('subtotal').textContent),
    pesoTotal: Number(document.getElementById('pesoTotal').textContent)
  };

  db.ref('orders').push(pedido).then(()=>{
    localStorage.removeItem('cart');
    alert('Pedido registrado! Em breve entraremos em contato.');
    window.location.href='index.html';
  });
}
</script>

</body>
</html>
