<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checkout | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.gold{color:#A68966}
</style>
</head>

<body class="max-w-xl mx-auto p-4">

<h1 class="text-xl font-serif gold text-center mb-4">Finalizar Pedido</h1>

<!-- DADOS CLIENTE -->
<div class="bg-white border p-4 space-y-2 mb-4">
  <input id="clienteNome" placeholder="Nome completo" class="border p-2 w-full">
  <input id="clienteWhats" placeholder="WhatsApp (DDD + n√∫mero)" class="border p-2 w-full">
</div>

<!-- CARRINHO -->
<div class="bg-white border p-4 mb-4">
  <h2 class="font-semibold mb-2">Itens do carrinho</h2>
  <div id="listaCarrinho" class="space-y-3 text-sm"></div>
</div>

<!-- PAGAMENTO -->
<div class="bg-white border p-4 space-y-2 mb-4">
  <h2 class="font-semibold">Forma de pagamento</h2>

  <label class="block">
    <input type="radio" name="pagamento" value="PIX" checked>
    PIX <span id="pixInfo" class="text-xs text-green-700"></span>
  </label>

  <label class="block">
    <input type="radio" name="pagamento" value="CARTAO">
    Cart√£o <span id="cartaoInfo" class="text-xs"></span>
  </label>
</div>

<!-- TOTAL -->
<div class="bg-white border p-4 mb-4 text-sm space-y-1">
  <p>Peso total: <strong><span id="pesoTotal">0</span> g</strong></p>
  <p>Total produtos: R$ <span id="totalProdutos">0.00</span></p>
  <p class="gold font-semibold">Total final: R$ <span id="totalFinal">0.00</span></p>
</div>

<button onclick="finalizarPedido()" class="bg-black text-white w-full py-3">
Finalizar Pedido no WhatsApp
</button>

<script>
/* üî• FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});
const db = firebase.database();

/* üõí CARRINHO */
let carrinho = JSON.parse(localStorage.getItem("cart")) || [];
let settings = {};
let total = 0;
let peso = 0;

/* üîÑ CARREGAR CONFIG EMPRESA */
db.ref('settings').once('value').then(s=>{
  settings = s.val() || {};
  pixInfo.textContent = settings.pix ? `(${settings.pix}% OFF)` : '';
  cartaoInfo.textContent = settings.parcelas
    ? `(${settings.parcelas}x sem acr√©scimo)`
    : '';
  renderCarrinho();
});

/* üßæ RENDER CARRINHO */
function renderCarrinho(){
  listaCarrinho.innerHTML='';
  total=0; peso=0;

  carrinho.forEach((i,idx)=>{
    total += i.price * i.qty;
    peso  += (i.weight||0) * i.qty;

    listaCarrinho.innerHTML+=`
    <div class="flex gap-3 border-b pb-2">
      <img src="${i.image}" class="w-16 h-16 object-cover border">
      <div class="flex-1">
        <p>${i.name}</p>
        <p class="text-xs">${i.sku || ''}</p>
        <input type="number" min="1" value="${i.qty}"
          onchange="atualizarQtd(${idx},this.value)"
          class="border w-16 text-xs p-1 mt-1">
      </div>
      <p>R$ ${(i.price*i.qty).toFixed(2)}</p>
    </div>`;
  });

  totalProdutos.textContent = total.toFixed(2);
  pesoTotal.textContent = peso;
  atualizarTotal();
}

function atualizarQtd(i,q){
  carrinho[i].qty = Number(q);
  localStorage.setItem("cart",JSON.stringify(carrinho));
  renderCarrinho();
}

/* üí∞ TOTAL FINAL */
function atualizarTotal(){
  const pag = document.querySelector('input[name=pagamento]:checked').value;
  let final = total;
  if(pag==='PIX' && settings.pix){
    final -= total * (settings.pix/100);
  }
  totalFinal.textContent = final.toFixed(2);
  return final;
}

document.querySelectorAll('input[name=pagamento]').forEach(i=>{
  i.onchange=atualizarTotal;
});

/* ‚úÖ FINALIZAR */
function finalizarPedido(){
  if(!carrinho.length) return alert('Carrinho vazio');
  if(!clienteNome.value || !clienteWhats.value) return alert('Preencha seus dados');

  const pagamento = document.querySelector('input[name=pagamento]:checked').value;
  const totalFinalCalc = atualizarTotal();

  const pedido = {
    cliente: clienteNome.value,
    whatsapp: clienteWhats.value,
    pagamento,
    parcelas: pagamento==='CARTAO'?settings.parcelas||1:1,
    descontoPix: pagamento==='PIX'?settings.pix||0:0,
    total: totalFinalCalc,
    peso,
    status: 'Novo',
    data: new Date().toLocaleString('pt-BR'),
    itens: carrinho
  };

  db.ref('orders').push(pedido);

  localStorage.removeItem("cart");

  let msg = `üõçÔ∏è *Pedido Abella Joias*%0A%0A`;
  carrinho.forEach(i=>{
    msg+=`${i.qty}x ${i.name} - R$ ${(i.price*i.qty).toFixed(2)}%0A`;
  });
  msg+=`%0Aüí≥ Pagamento: ${pagamento}`;
  if(pagamento==='PIX') msg+=` (com desconto)`;
  msg+=`%0A‚öñÔ∏è Peso: ${peso}g`;
  msg+=`%0Aüí∞ Total: R$ ${totalFinalCalc.toFixed(2)}`;
  msg+=`%0A%0AObrigado! A Abella Joias entrar√° em contato para finalizar üíé`;

  window.open(`https://wa.me/${settings.whatsapp}?text=${msg}`);
}
</script>

</body>
</html>
