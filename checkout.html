<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checkout | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.gold{color:#A68966}
.font-serif{font-family:'Cinzel',serif}
</style>
</head>

<body class="p-6 max-w-xl mx-auto">

<h1 class="font-serif gold text-xl text-center mb-6">Finalizar Pedido</h1>

<input id="nome" placeholder="Nome completo" class="border p-3 w-full mb-2">
<input id="whats" placeholder="WhatsApp (DDD + n√∫mero)" class="border p-3 w-full mb-4">

<select id="pagamento" class="border p-3 w-full mb-4">
  <option value="PIX">PIX (desconto)</option>
  <option value="CARTAO">Cart√£o</option>
</select>

<div id="resumo" class="bg-white border p-4 space-y-2 text-sm"></div>

<button onclick="finalizarPedido()"
  class="bg-black text-white w-full py-3 mt-4 text-sm">
Enviar pedido no WhatsApp
</button>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});
const db=firebase.database();

/* DADOS */
const carrinho=JSON.parse(localStorage.getItem('carrinho')||'[]');
let descontoPix=0;
let parcelas=1;
let telefoneLoja='';

/* CONFIG */
db.ref('settings').once('value').then(s=>{
  if(!s.val())return;
  descontoPix=Number(s.val().pix||0);
  parcelas=Number(s.val().parcelas||1);
  telefoneLoja=s.val().whatsapp;
  calcularResumo();
});

function calcularResumo(){
  let total=0;
  let peso=0;
  carrinho.forEach(i=>{
    total+=i.price*i.qty;
    peso+=(i.weight||0)*i.qty;
  });

  const totalPix=(total*(1-descontoPix/100)).toFixed(2);
  const parcela=(total/parcelas).toFixed(2);

  resumo.innerHTML=`
    <p>Itens: ${carrinho.length}</p>
    <p>Peso total: <strong>${peso}g</strong></p>
    <p>Total: <strong>R$ ${total.toFixed(2)}</strong></p>
    <p class="text-green-700">PIX (${descontoPix}%): <strong>R$ ${totalPix}</strong></p>
    <p>Cart√£o: ${parcelas}x R$ ${parcela}</p>
  `;
}

/* FINALIZAR */
function finalizarPedido(){
  if(!nome.value||!whats.value){
    alert('Preencha nome e WhatsApp');
    return;
  }

  const pagamento=pagamento.value;
  let total=0;
  let peso=0;

  let msg=`üõçÔ∏è *Pedido Abella Joias*%0A%0A`;
  carrinho.forEach(i=>{
    total+=i.price*i.qty;
    peso+=(i.weight||0)*i.qty;
    msg+=`${i.qty}x ${i.name} ‚Äî R$ ${(i.price*i.qty).toFixed(2)}%0A`;
  });

  let totalFinal=total;
  if(pagamento==='PIX'){
    totalFinal=total*(1-descontoPix/100);
    msg+=`%0A‚ö° *PIX (${descontoPix}%)*`;
  }else{
    msg+=`%0Aüí≥ *Cart√£o (${parcelas}x)*`;
  }

  msg+=`%0Aüì¶ Peso: ${peso}g`;
  msg+=`%0Aüí∞ *Total: R$ ${totalFinal.toFixed(2)}*`;
  msg+=`%0A%0Aüôè Obrigado pela prefer√™ncia!%0AEm breve a Abella Joias entrar√° em contato para finalizar seu pedido.`;

  /* SALVAR NO PAINEL */
  db.ref('orders').push({
    cliente:nome.value,
    whatsapp:whats.value,
    itens:carrinho,
    pagamento,
    peso,
    total:totalFinal,
    status:'Novo',
    data:new Date().toLocaleString()
  });

  localStorage.removeItem('carrinho');

  window.open(`https://wa.me/${telefoneLoja}?text=${msg}`,'_blank');
}
</script>

</body>
</html>
