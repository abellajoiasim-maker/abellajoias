<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo ‚Ä¢ Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body {
  background:#0b0b0b;
  color:#eee;
  font-family:Inter,Arial,sans-serif;
  margin:0;
}

nav button.active {
  border-bottom:2px solid #caa85c;
  color:#caa85c;
}

section { display:none; min-height:300px; }
section.active { display:block; }

.card {
  background:#141414;
  border:1px solid #2a2a2a;
  border-radius:16px;
  padding:14px;
}

.btn {
  background:#222;
  border:1px solid #444;
  padding:8px 12px;
  border-radius:8px;
  font-size:12px;
  cursor:pointer;
}

.btn-gold {
  background:#caa85c;
  color:#000;
  font-weight:700;
  padding:10px;
  border-radius:8px;
  cursor:pointer;
}

input, select {
  background:#111;
  border:1px solid #333;
  padding:8px;
  border-radius:8px;
  width:100%;
  margin-bottom:8px;
  color:#fff;
  outline:none;
}

#mainModal.active { display:flex; }

.custom-scroll::-webkit-scrollbar { width:4px; }
.custom-scroll::-webkit-scrollbar-thumb {
  background:#caa85c;
  border-radius:10px;
}

/* √ÅREA DE IMPRESS√ÉO */
#print-area { display:none; }

/* AJUSTE CR√çTICO DE IMPRESS√ÉO (SEM FOLHA EM BRANCO) */
@media print {
  @page {
    size: A4;
    margin: 10mm;
  }

  body * {
    visibility: hidden;
  }

  #print-area, #print-area * {
    visibility: visible;
  }

  #print-area {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    display: block;
    background: #fff;
    color: #000;
    page-break-after: avoid;
    page-break-before: avoid;
  }
}
</style>
</head>

<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222] text-[#caa85c] tracking-widest uppercase">
  Abella Joias ‚Ä¢ Painel de Controlo
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
  <button class="btn active" onclick="showTab('empresa', this)">Empresa</button>
  <button class="btn" onclick="showTab('categorias', this)">Categorias</button>
  <button class="btn" onclick="showTab('produtos', this)">Produtos</button>
  <button class="btn" onclick="showTab('promocoes', this)">Promo√ß√µes</button>
  <button class="btn" onclick="showTab('pedidos', this)">Pedidos</button>
</nav>

<main class="p-6 max-w-4xl mx-auto">

<!-- EMPRESA -->
<section id="empresa" class="active">
  <div class="card space-y-3">
    <h2 class="text-[#caa85c] font-bold uppercase text-sm">Configura√ß√£o da Loja</h2>
    <input id="empNome" placeholder="Nome da Empresa">
    <input id="empSub" placeholder="Slogan / Subt√≠tulo">
    <input id="empWhats" placeholder="WhatsApp da Loja">
    <div class="grid grid-cols-2 gap-2">
      <input id="empDesc" type="number" placeholder="Desc. PIX %">
      <input id="empParc" type="number" placeholder="Parcelas M√°x">
    </div>
    <button class="btn-gold w-full" onclick="salvarEmpresa()">GUARDAR ALTERA√á√ïES</button>
  </div>
</section>

<!-- CATEGORIAS -->
<section id="categorias">
  <div class="card mb-4">
    <input id="newCatName" placeholder="Nome da Nova Categoria">
    <button class="btn-gold w-full" onclick="novaCategoria()">+ CADASTRAR CATEGORIA</button>
  </div>
  <div id="listaCategorias" class="grid gap-2"></div>
</section>

<!-- PRODUTOS -->
<section id="produtos">
  <div id="listaProdutos" class="grid gap-2"></div>
</section>

<!-- PROMO√á√ïES -->
<section id="promocoes">
  <div class="card mb-4 text-center">
    <h2 class="uppercase text-sm mb-4 tracking-widest text-[#caa85c] font-bold">
      Configura√ß√µes de Promo√ß√£o
    </h2>

    <button class="btn-gold w-full py-4 uppercase"
      onclick="abrirPainelPromocoes()">
      üé® Configurar Etiquetas e Descontos
    </button>
  </div>
  <div id="listaPromocoes" class="grid gap-2"></div>
</section>

<!-- PEDIDOS -->
<section id="pedidos">
  <div id="listaPedidos" class="grid gap-4"></div>
</section>

</main>

<!-- MODAL PADR√ÉO -->
<div id="mainModal" class="fixed inset-0 bg-black/90 z-[100] hidden items-center justify-center p-4">
  <div class="bg-[#141414] border border-[#2a2a2a] w-full max-w-lg rounded-2xl overflow-hidden shadow-2xl">
    <div class="p-4 border-b border-[#222] flex justify-between items-center">
      <h3 id="modalTitle" class="uppercase text-sm text-[#caa85c] font-bold">T√≠tulo</h3>
      <button onclick="fecharModal()" class="text-gray-500 hover:text-white">&times;</button>
    </div>
    <div id="modalBody" class="p-6 max-h-[70vh] overflow-y-auto"></div>
    <div class="p-4 border-t border-[#222] flex gap-3">
      <button onclick="fecharModal()" class="flex-1 py-3 text-xs uppercase text-gray-500">Cancelar</button>
      <button id="modalSaveBtn" class="flex-1 btn-gold py-3 text-xs uppercase font-bold">
        Guardar Altera√ß√µes
      </button>
    </div>
  </div>
</div>

<!-- EDITOR DE PEDIDO -->
<div id="editorPedido" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
  <div class="bg-[#111] w-full max-w-4xl rounded-2xl p-5 overflow-auto max-h-[90vh] border border-[#333]">

    <h2 class="text-[#caa85c] font-bold text-lg mb-3 uppercase">
      Editar Pedido (Atacado)
    </h2>

    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <input id="edClienteNome" placeholder="Nome do Cliente">
        <input id="edClienteTel" placeholder="WhatsApp">
      </div>
      <div>
        <input id="edRua" placeholder="Rua">
        <div class="grid grid-cols-2 gap-2">
          <input id="edNum" placeholder="N¬∫">
          <input id="edBairro" placeholder="Bairro">
        </div>
        <input id="edCidade" placeholder="Cidade">
      </div>
    </div>

    <h3 class="font-bold mt-4 mb-2 text-xs text-[#caa85c]">ITENS DO PEDIDO</h3>
    <div id="edItens" class="space-y-2"></div>
    <button class="btn w-full mt-2 border-dashed border-gray-600"
      onclick="adicionarItemEditor()">
      + Adicionar Item
    </button>

    <div class="grid md:grid-cols-2 gap-4 mt-6 p-4 bg-black/20 rounded-xl border border-[#222]">
      <div>
        <input id="edFreteNome" placeholder="Tipo de Frete">
        <input id="edFreteValor" type="number" placeholder="Valor do Frete">
      </div>
      <div>
        <input id="edDescPromo" type="number" placeholder="Desconto Promo (R$)">
        <input id="edDescPix" type="number" placeholder="Desconto PIX (R$)">
      </div>
    </div>

    <div class="flex flex-wrap gap-2 justify-between mt-6 pt-4 border-t border-[#222]">
      <button class="btn" onclick="fecharEditorPedido()">CANCELAR</button>
      <div class="flex gap-2">
        <button class="btn" onclick="gerarRomaneio(pedidoEditando)">ROMANEIO</button>
        <button class="btn-gold px-10" onclick="salvarPedidoEditado()">SALVAR</button>
      </div>
    </div>

  </div>
</div>

<!-- √ÅREA DE IMPRESS√ÉO -->
<div id="print-area"></div>

<script>
/* ===============================
   üî• FIREBASE CONFIG
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias",
  storageBucket: "catalogo-abella-joias.firebasestorage.app",
  messagingSenderId: "727568435294",
  appId: "1:727568435294:web:442c0179ecf0686dff4ccf"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===============================
   üîÄ NAVEGA√á√ÉO
================================ */
function showTab(tab, btn){
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

/* ===============================
   ü™ü MODAL
================================ */
function abrirModal(titulo, conteudo, onSave){
  modalTitle.innerText = titulo;
  modalBody.innerHTML = conteudo;
  mainModal.classList.add('active');
  modalSaveBtn.onclick = onSave;
}
function fecharModal(){
  mainModal.classList.remove('active');
}

/* ===============================
   üè™ EMPRESA
================================ */
function salvarEmpresa(){
  const data = {
    nome: empNome.value,
    sub: empSub.value,
    whats: empWhats.value,
    descPix: Number(empDesc.value || 0),
    parcelas: Number(empParc.value || 1)
  };
  db.ref('empresa').set(data);
  alert('Empresa salva');
}

db.ref('empresa').on('value', snap=>{
  if(!snap.exists()) return;
  const d = snap.val();
  empNome.value = d.nome || '';
  empSub.value = d.sub || '';
  empWhats.value = d.whats || '';
  empDesc.value = d.descPix || 0;
  empParc.value = d.parcelas || 1;
});

/* ===============================
   üóÇÔ∏è CATEGORIAS
================================ */
function novaCategoria(){
  if(!newCatName.value) return;
  db.ref('categorias').push({ nome:newCatName.value });
  newCatName.value='';
}

db.ref('categorias').on('value', snap=>{
  listaCategorias.innerHTML='';
  snap.forEach(cat=>{
    listaCategorias.innerHTML+=`
      <div class="card flex justify-between items-center">
        <span>${cat.val().nome}</span>
        <button class="btn" onclick="removerCategoria('${cat.key}')">Excluir</button>
      </div>`;
  });
});

function removerCategoria(id){
  if(confirm('Excluir categoria?')){
    db.ref('categorias/'+id).remove();
  }
}

/* ===============================
   üíç PRODUTOS
================================ */
db.ref('produtos').on('value', snap=>{
  listaProdutos.innerHTML='';
  snap.forEach(p=>{
    const pr = p.val();
    listaProdutos.innerHTML+=`
      <div class="card">
        <b>${pr.nome}</b>
        <div class="text-xs text-gray-400">R$ ${pr.valor}</div>
      </div>`;
  });
});

/* ===============================
   üéØ PROMO√á√ïES
================================ */
function abrirPainelPromocoes(){
  abrirModal(
    'Promo√ß√µes',
    `
    <input id="promoTexto" placeholder="Texto da Etiqueta">
    <input id="promoDesc" type="number" placeholder="Desconto %">
    `,
    ()=>{
      db.ref('promocao').set({
        texto: promoTexto.value,
        desconto: Number(promoDesc.value||0)
      });
      fecharModal();
    }
  );
}

db.ref('promocao').on('value', snap=>{
  listaPromocoes.innerHTML='';
  if(!snap.exists()) return;
  const p = snap.val();
  listaPromocoes.innerHTML=`
    <div class="card">
      <b>${p.texto}</b>
      <div>${p.desconto}%</div>
    </div>`;
});

/* ===============================
   üì¶ PEDIDOS
================================ */
let pedidoEditando = null;

db.ref('pedidos').on('value', snap=>{
  listaPedidos.innerHTML='';
  snap.forEach(p=>{
    const d = p.val();
    listaPedidos.innerHTML+=`
      <div class="card">
        <b>${d.cliente?.nome || 'Cliente'}</b>
        <div class="text-xs">Total: R$ ${d.total || 0}</div>
        <button class="btn mt-2" onclick="abrirPedido('${p.key}')">Abrir</button>
      </div>`;
  });
});

function abrirPedido(id){
  pedidoEditando = id;
  db.ref('pedidos/'+id).once('value').then(snap=>{
    const p = snap.val();
    edClienteNome.value = p.cliente?.nome || '';
    edClienteTel.value = p.cliente?.tel || '';
    edDescPromo.value = p.descPromo || 0;
    edDescPix.value = p.descPix || 0;
    edItens.innerHTML='';
    (p.itens||[]).forEach(addItemEditor);
    editorPedido.classList.remove('hidden');
  });
}

function fecharEditorPedido(){
  editorPedido.classList.add('hidden');
}

function adicionarItemEditor(item={}){
  edItens.innerHTML+=`
    <div class="flex gap-2">
      <input placeholder="Produto" value="${item.nome||''}">
      <input type="number" placeholder="Qtd" value="${item.qtd||1}">
      <input type="number" placeholder="Valor" value="${item.valor||0}">
    </div>`;
}

function salvarPedidoEditado(){
  const itens = [...edItens.children].map(div=>{
    const i = div.querySelectorAll('input');
    return {
      nome:i[0].value,
      qtd:Number(i[1].value),
      valor:Number(i[2].value)
    };
  });

  const subtotal = itens.reduce((s,i)=>s+(i.qtd*i.valor),0);
  const total = subtotal - Number(edDescPromo.value||0) - Number(edDescPix.value||0);

  db.ref('pedidos/'+pedidoEditando).update({
    cliente:{
      nome:edClienteNome.value,
      tel:edClienteTel.value
    },
    itens,
    descPromo:Number(edDescPromo.value||0),
    descPix:Number(edDescPix.value||0),
    total
  });

  fecharEditorPedido();
}

/* ===============================
   üñ®Ô∏è ROMANEIO (BASE)
================================ */
function gerarRomaneio(id){
  db.ref('pedidos/'+id).once('value').then(snap=>{
    const p = snap.val();
    let html = `<h2>ROMANEIO</h2>`;
    html+= `<p>${p.cliente.nome}</p>`;
    p.itens.forEach(i=>{
      html+= `<div>${i.qtd}x ${i.nome} - R$ ${i.valor}</div>`;
    });
    html+= `<b>Total: R$ ${p.total}</b>`;
    print-area.innerHTML = html;
    window.print();
  });
}
/* =====================================================
   üß† FUN√á√ïES UTILIT√ÅRIAS
===================================================== */
function calcularSubtotal(itens){
  return itens.reduce((s,i)=>s+(i.qtd*i.valor),0);
}

function lerItensEditor(){
  return [...edItens.children].map(div=>{
    const i = div.querySelectorAll('input');
    return {
      nome: i[0].value,
      qtd: Number(i[1].value||0),
      valor: Number(i[2].value||0)
    };
  });
}

/* =====================================================
   üîÅ REC√ÅLCULO AUTOM√ÅTICO (AO EDITAR ITENS)
===================================================== */
edItens.addEventListener('input', ()=>{
  if(!pedidoEditando) return;
  const itens = lerItensEditor();
  const subtotal = calcularSubtotal(itens);

  // mant√©m descontos fixos (n√£o recalcula desconto)
  const descPromo = Number(edDescPromo.value||0);
  const descPix   = Number(edDescPix.value||0);

  const total = subtotal - descPromo - descPix;

  // preview silencioso no Firebase (sem salvar)
  db.ref('pedidos/'+pedidoEditando+'/preview').set({
    subtotal,
    total
  });
});

/* =====================================================
   üîê TRAVAR DESCONTOS AP√ìS SALVAR
===================================================== */
function travarDescontos(){
  edDescPromo.setAttribute('disabled', true);
  edDescPix.setAttribute('disabled', true);
  edDescPromo.classList.add('opacity-50');
  edDescPix.classList.add('opacity-50');
}

function destravarDescontos(){
  edDescPromo.removeAttribute('disabled');
  edDescPix.removeAttribute('disabled');
  edDescPromo.classList.remove('opacity-50');
  edDescPix.classList.remove('opacity-50');
}

/* =====================================================
   üíæ SOBRESCREVE SALVAR PEDIDO (COM TRAVA)
===================================================== */
const salvarPedidoOriginal = salvarPedidoEditado;

salvarPedidoEditado = function(){
  const itens = lerItensEditor();
  const subtotal = calcularSubtotal(itens);

  const descPromo = Number(edDescPromo.value||0);
  const descPix   = Number(edDescPix.value||0);

  const total = subtotal - descPromo - descPix;

  db.ref('pedidos/'+pedidoEditando).update({
    itens,
    subtotal,
    descPromo,
    descPix,
    total,
    descontosTravados: true,
    atualizadoEm: Date.now()
  });

  travarDescontos();
  fecharEditorPedido();
};

/* =====================================================
   üì• VALIDAR PEDIDOS DO SITE
===================================================== */
db.ref('pedidos').on('child_added', snap=>{
  const p = snap.val();
  if(!p.origem){
    db.ref('pedidos/'+snap.key+'/origem').set('painel');
  }
  if(p.origem === 'site'){
    console.log('üõí Pedido vindo do site:', snap.key);
  }
});

/* =====================================================
   üìë DUPLICAR PEDIDO
===================================================== */
function duplicarPedido(id){
  db.ref('pedidos/'+id).once('value').then(snap=>{
    const p = snap.val();
    delete p.descontosTravados;
    delete p.atualizadoEm;
    p.status = 'duplicado';
    p.criadoEm = Date.now();

    db.ref('pedidos').push(p);
    alert('Pedido duplicado com sucesso');
  });
}

/* =====================================================
   üßæ BOT√ÉO DUPLICAR NO PAINEL
===================================================== */
const pedidosObserver = new MutationObserver(()=>{
  document.querySelectorAll('[data-dup]').forEach(btn=>{
    btn.onclick = ()=>duplicarPedido(btn.dataset.dup);
  });
});

pedidosObserver.observe(listaPedidos,{childList:true});

/* =====================================================
   üñ®Ô∏è ROMANEIO COM DESCONTOS REAIS
===================================================== */
function gerarRomaneio(id){
  db.ref('pedidos/'+id).once('value').then(snap=>{
    const p = snap.val();

    let html = `
      <div style="font-family:Arial">
        <h2>ROMANEIO</h2>
        <p><b>Cliente:</b> ${p.cliente?.nome||''}</p>
        <hr>
    `;

    p.itens.forEach(i=>{
      html += `<div>${i.qtd}x ${i.nome} ‚Äî R$ ${(i.qtd*i.valor).toFixed(2)}</div>`;
    });

    html += `
      <hr>
      <p>Subtotal: R$ ${p.subtotal?.toFixed(2)}</p>
      <p>Desc. Promo√ß√£o: R$ ${p.descPromo?.toFixed(2)}</p>
      <p>Desc. PIX: R$ ${p.descPix?.toFixed(2)}</p>
      <h3>Total: R$ ${p.total?.toFixed(2)}</h3>
      </div>
    `;

    document.getElementById('print-area').innerHTML = html;
    window.print();
  });
}
/* =====================================================
   üßæ CONFIGURA√á√ÉO DE IMPRESS√ÉO (ANTI FOLHA EM BRANCO)
===================================================== */
const stylePrint = document.createElement('style');
stylePrint.innerHTML = `
@media print {
  @page {
    size: A4;
    margin: 10mm;
  }
  body * {
    visibility: hidden;
  }
  #print-area, #print-area * {
    visibility: visible;
  }
  #print-area {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    page-break-after: avoid;
    page-break-before: avoid;
    page-break-inside: avoid;
  }
}
`;
document.head.appendChild(stylePrint);

/* =====================================================
   üìÑ GERAR ROMANEIO EM PDF AUTOM√ÅTICO
===================================================== */
function exportarRomaneioPDF(id){
  db.ref('pedidos/'+id).once('value').then(snap=>{
    const p = snap.val();
    if(!p) return alert('Pedido n√£o encontrado');

    let html = `
      <div style="font-family:Arial;font-size:12px">
        <h2 style="margin-bottom:4px">ROMANEIO</h2>
        <p><b>Cliente:</b> ${p.cliente?.nome||''}</p>
        <p><b>Telefone:</b> ${p.cliente?.telefone||''}</p>
        <hr>
        <table width="100%" cellspacing="0" cellpadding="4" border="0">
          <thead>
            <tr>
              <th align="left">Qtd</th>
              <th align="left">Produto</th>
              <th align="right">Valor</th>
            </tr>
          </thead>
          <tbody>
    `;

    p.itens.forEach(i=>{
      html += `
        <tr>
          <td>${i.qtd}</td>
          <td>${i.nome}</td>
          <td align="right">R$ ${(i.qtd*i.valor).toFixed(2)}</td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
        <hr>
        <p>Subtotal: <b>R$ ${Number(p.subtotal||0).toFixed(2)}</b></p>
        <p>Desc. Promo√ß√£o: <b>- R$ ${Number(p.descPromo||0).toFixed(2)}</b></p>
        <p>Desc. PIX: <b>- R$ ${Number(p.descPix||0).toFixed(2)}</b></p>
        <h3>Total: R$ ${Number(p.total||0).toFixed(2)}</h3>
      </div>
    `;

    const printArea = document.getElementById('print-area');
    printArea.innerHTML = html;

    // aguarda renderizar antes de imprimir
    setTimeout(()=>{
      window.print();
    },300);
  });
}

/* =====================================================
   ‚ûï BOT√ÉO EXPORTAR PDF NO PAINEL
===================================================== */
function inserirBotaoPDF(){
  document.querySelectorAll('[data-pdf]').forEach(btn=>{
    btn.onclick = ()=>exportarRomaneioPDF(btn.dataset.pdf);
  });
}

/* =====================================================
   üëÄ OBSERVA LISTA DE PEDIDOS (AUTO ATIVA BOT√ïES)
===================================================== */
const pdfObserver = new MutationObserver(()=>{
  inserirBotaoPDF();
});

pdfObserver.observe(listaPedidos,{childList:true});

/* =====================================================
   üìå EXEMPLO DE BOT√ïES NO CARD DO PEDIDO
   (SEU HTML J√Å EXISTE ‚Äî ISSO √â S√ì REFER√äNCIA)
===================================================== */
/*
<button data-pdf="ID_DO_PEDIDO">üìÑ PDF</button>
<button data-dup="ID_DO_PEDIDO">üìë DUPLICAR</button>
*/
</script>


</body>
</html>
