<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo ‚Ä¢ Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:#eee;font-family:Inter,Arial;margin:0}
nav button.active{border-color:#caa85c;color:#caa85c}
section{display:none;min-height:300px}
section.active{display:block}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
.btn{background:#222;border:1px solid #444;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer}
.btn-gold{background:#caa85c;color:#000;font-weight:700}
input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff}

#print-area{display:none}

@media print{
 body *{visibility:hidden}
 #print-area,#print-area *{visibility:visible}
 #print-area{position:absolute;top:0;left:0;width:100%;background:#fff;color:#000;display:block}
}
</style>
</head>

<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222]">
  Painel Administrativo ‚Ä¢ Abella Joias
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
  <button class="btn active" onclick="showTab('empresa',this)">Empresa</button>
  <button class="btn" onclick="showTab('categorias',this)">Categorias</button>
  <button class="btn" onclick="showTab('produtos',this)">Produtos</button>
  <button class="btn" onclick="showTab('promocoes',this)">Promo√ß√µes</button>
  <button class="btn" onclick="showTab('pedidos',this)">Pedidos</button>
</nav>

<main class="p-6">

<section id="empresa" class="active">
  <div class="card space-y-3">
    <h2 class="text-[#caa85c] font-bold">Configura√ß√µes da Loja</h2>
    <input id="empNome" placeholder="Nome da Empresa">
    <input id="empSub" placeholder="Subt√≠tulo">
    <input id="empWhats" placeholder="WhatsApp">
    <input id="empDesc" type="number" placeholder="Desconto PIX (%)">
    <input id="empParc" type="number" placeholder="Parcelas sem acr√©scimo">
    <button class="btn-gold w-full" onclick="salvarEmpresa()">Salvar</button>
  </div>
</section>

<section id="categorias">
  <button class="btn-gold mb-3" onclick="novaCategoria()">+ Nova Categoria</button>
  <div id="listaCategorias"></div>
</section>

<section id="produtos">
  <button class="btn-gold mb-3" onclick="novoProduto()">+ Novo Produto</button>
  <div id="listaProdutos"></div>
</section>

<section id="promocoes">
  <h2 class="text-[#caa85c] font-bold mb-4 text-center">Gest√£o de Promo√ß√µes Individual</h2>
  <div class="flex gap-2 mb-4">
    <button class="btn flex-1 bg-[#222] border-[#caa85c]/50 text-[#caa85c] font-bold py-3" onclick="listarPromos('categorias')">üè∑Ô∏è Por Categorias</button>
    <button class="btn flex-1 bg-[#222] border-[#caa85c]/50 text-[#caa85c] font-bold py-3" onclick="listarPromos('produtos')">üíé Por Produtos</button>
  </div>
  
  <div id="listaPromocoes" class="grid gap-2">
    <p class="text-center text-gray-500 mt-10">Selecione uma op√ß√£o acima para editar os descontos.</p>
  </div>
</section>

<section id="pedidos">
  <h2 class="text-[#caa85c] font-bold mb-4 text-center uppercase tracking-widest">Pedidos Recebidos</h2>
  <div id="listaPedidos" class="grid gap-4"></div>
</section>

<div id="print-area"></div>

</main>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
 apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
 databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com"
});
const db = firebase.database();

/* ================= HELPERS ================= */
const fMoeda = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);

/* ================= NAVEGA√á√ÉO (MENU) ================= */
function showTab(id, btn){
 document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
 document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));

 const target = document.getElementById(id);
 if(target) target.classList.add('active');
 if(btn) btn.classList.add('active');

 if(id==='categorias') carregarCategorias();
 if(id==='produtos') carregarProdutos();
 if(id==='pedidos') carregarPedidos();
 if(id==='promocoes') document.getElementById('listaPromocoes').innerHTML='';
}

/* ================= EMPRESA ================= */
function salvarEmpresa(){
 db.ref('settings/empresa').set({
  nome: empNome.value,
  subtitulo: empSub.value,
  whats: empWhats.value,
  descontoPix:+empDesc.value||0,
  parcelas:+empParc.value||0
 }).then(()=>alert('Salvo com sucesso!'));
}

function carregarEmpresaSeExistir(){
 db.ref('settings/empresa').once('value',s=>{
  const v=s.val(); if(!v) return;
  empNome.value=v.nome||'';
  empSub.value=v.subtitulo||'';
  empWhats.value=v.whats||'';
  empDesc.value=v.descontoPix||0;
  empParc.value=v.parcelas||0;
 });
}

/* ================= CATEGORIAS ================= */
function carregarCategorias(){
 const lista = document.getElementById('listaCategorias');
 db.ref('categories').once('value',s=>{
  lista.innerHTML='';
  let cats=[]; s.forEach(c=>cats.push({key:c.key,...c.val()}));
  cats.sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  cats.forEach(c=>{
   const temImg=c.image?'üñºÔ∏è':'<span class="opacity-20">üö´</span>';
   lista.innerHTML+=`
   <div class="card flex justify-between items-center py-2 px-3 text-xs">
    <div class="flex gap-2 items-center">${temImg}<b>${c.name}</b></div>
    <div class="flex gap-2">
      <button onclick="editarCategoria('${c.key}','${c.name}')" class="text-blue-400">‚úé</button>
      <button onclick="if(confirm('Excluir?')) db.ref('categories/${c.key}').remove().then(carregarCategorias)" class="text-red-500">X</button>
    </div>
   </div>`;
  });
 });
}

/* ================= PRODUTOS ================= */
let cacheProdutos=[];
function carregarProdutos(){
 const lista = document.getElementById('listaProdutos');
 lista.innerHTML='<p class="p-4 text-center">Sincronizando...</p>';
 db.ref('products').once('value',s=>{
  cacheProdutos=[]; s.forEach(p=>cacheProdutos.push({key:p.key,...p.val()}));
  renderizarEstruturaProdutos();
 });
}

function renderizarEstruturaProdutos(){
 const lista=document.getElementById('listaProdutos');
 lista.innerHTML='';

 const categorias=[...new Set(cacheProdutos.map(p=>p.category||"Sem Categoria"))]
  .sort((a,b)=>a.localeCompare(b));

 categorias.forEach(cat=>{
  const catId=cat.replace(/\s+/g,'-');
  const prods=cacheProdutos.filter(p=>(p.category||"Sem Categoria")===cat)
   .sort((a,b)=>(a.sku||"").localeCompare(b.sku||"",undefined,{numeric:true}));

  lista.innerHTML+=`
  <div class="mb-2">
   <div onclick="toggleCategoria('${cat}','${catId}')" class="flex justify-between bg-[#141414] p-2 rounded cursor-pointer border-l-4 border-[#caa85c]">
    <b class="text-[11px] uppercase">${cat} (${prods.length})</b>
    <span id="seta-${catId}">‚ñº</span>
   </div>
   <div id="cat-content-${catId}" class="hidden flex flex-col gap-1 mt-1 pl-2"></div>
  </div>`;
 });
}

function toggleCategoria(nomeCat,catId){
 const content=document.getElementById(`cat-content-${catId}`);
 const seta=document.getElementById(`seta-${catId}`);
 const isHidden=content.classList.contains('hidden');

 document.querySelectorAll('[id^="cat-content-"]').forEach(el=>el.classList.add('hidden'));
 document.querySelectorAll('[id^="seta-"]').forEach(el=>el.innerText='‚ñº');

 if(isHidden){
  content.classList.remove('hidden');
  seta.innerText='‚ñ≤';
  const prods=cacheProdutos.filter(p=>(p.category||"Sem Categoria")===nomeCat)
   .sort((a,b)=>(a.sku||"").localeCompare(b.sku||"",undefined,{numeric:true}));

  content.innerHTML=prods.map(p=>{
   const temImg=p.image?'üñºÔ∏è':'<span class="opacity-20">üö´</span>';
   return `<div class="card flex justify-between py-1 px-2 text-[11px] bg-[#0d0d0d]">
    <div>${temImg} <span class="text-gray-400">${p.sku||'---'}</span> <b>${p.name}</b></div>
    <div class="flex gap-2">
     <button onclick="editarProduto('${p.key}')" class="text-blue-400">‚úé</button>
     <button onclick="removerProduto('${p.key}')" class="text-red-500">X</button>
    </div></div>`;
  }).join('');
 }
}

/* ================= PROMO√á√ïES (MODAL) ================= */
function listarPromos(tipo){
 const container=document.getElementById('listaPromocoes');
 container.innerHTML='Carregando...';
 db.ref(tipo==='categorias'?'categories':'products').once('value',s=>{
  container.innerHTML='';
  let itens=[]; s.forEach(i=>itens.push({key:i.key,...i.val()}));
  itens.sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  itens.forEach(item=>{
   const nome=tipo==='categorias'?item.name:`[${item.sku||'---'}] ${item.name}`;
   container.innerHTML+=`
   <div class="card text-xs flex justify-between items-center">
    <div class="flex-1">
     <b>${nome}</b>
     <div class="flex gap-2 mt-1">
      <input type="number" value="${item.promoPct||0}" onchange="salvarPromo('${tipo}','${item.key}','promoPct',this.value)" class="w-14 bg-black border text-center">
      <input type="text" value="${item.promoTexto||'OFF'}" onchange="salvarPromo('${tipo}','${item.key}','promoTexto',this.value)" class="w-16 bg-black border text-center">
      <input type="color" value="${item.promoCor||'#caa85c'}" onchange="salvarPromo('${tipo}','${item.key}','promoCor',this.value)">
     </div>
    </div>
    <button class="text-red-500" onclick="limparPromo('${tipo}','${item.key}')">X</button>
   </div>`;
  });
 });
}

/* ================= PEDIDOS ================= */
function carregarPedidos(){
 const lista=document.getElementById('listaPedidos');
 db.ref('orders').on('value',snap=>{
  lista.innerHTML='';
  if(!snap.exists()) return;
  snap.forEach(ped=>{
   const p=ped.val(); const id=ped.key;
   lista.innerHTML+=`
   <div class="card mb-3 border-l-4 border-[#caa85c]">
    <div class="flex justify-between">
     <b>${p.cliente?.nome||p.cliente}</b>
     <span>${p.pagamento||''}</span>
    </div>
    <div class="grid grid-cols-3 gap-1 mt-2">
     <button onclick="gerarRomaneio('${id}',1)" class="btn text-[9px]">Simples</button>
     <button onclick="gerarRomaneio('${id}',2)" class="btn text-[9px]">Completo</button>
     <button onclick="gerarRomaneio('${id}',3)" class="btn text-[9px]">Completo+Foto</button>
    </div>
   </div>`;
  });
 });
}

function gerarRomaneio(id, tipo = 1) {
 db.ref('orders/'+id).once('value', s => {
  const p = s.val(); if(!p) return;
  db.ref('settings/empresa').once('value', e => {
   const emp = e.val() || {};
   let html = `
   <style>
    .print-body { font-family: 'Poppins', sans-serif; color:#000; padding:20px; font-size: 11px; }
    .lux-head { text-align:center; border-bottom:2px solid #A68966; padding-bottom:10px; margin-bottom:15px; }
    .lux-head h1 { font-family: 'Cinzel', serif; margin:0; color:#A68966; font-size:24px; }
    .grid-dados { display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:15px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:11px; }
    table th { background:#f9f9f9; text-align:left; border-bottom:1px solid #000; padding:5px; }
    table td { border-bottom:1px solid #eee; padding:5px; }
    .totais { text-align:right; margin-top:15px; font-size:12px; }
    .img-mini { width:40px; height:40px; object-fit:cover; border-radius:4px; }
   </style>
   <div class="print-body">
    <div class="lux-head">
     <h1>${emp.nome || 'Abella Joias'}</h1>
     <p>${emp.subtitulo || ''}<br>WhatsApp: ${emp.whats || ''}</p>
    </div>
    
    <div class="grid-dados">
     <div>
      <b>DADOS DO CLIENTE</b><br>
      Nome: ${p.cliente?.nome || p.cliente}<br>
      WhatsApp: ${p.cliente?.telefone || p.whatsapp || ''}
     </div>
     <div>
      <b>LOCAL DE ENTREGA</b><br>
      ${p.endereco?.nome || 'Residencial'}<br>
      ${p.endereco?.rua || ''}, ${p.endereco?.num || ''}<br>
      ${p.endereco?.bairro || ''} - ${p.endereco?.cidade || ''}
     </div>
    </div>

    <table>
     <thead>
      <tr>
       ${tipo === 3 ? '<th>Foto</th>' : ''}
       <th>SKU</th>
       <th>Produto</th>
       ${tipo > 1 ? '<th>Peso U.</th><th>Pre√ßo U.</th>' : ''}
       <th>Qtd</th>
       ${tipo > 1 ? '<th>Subtotal</th>' : ''}
      </tr>
     </thead>
     <tbody>`;

 p.itens.forEach(i => {
    const vPreco = Number(i.precoFinal || i.price || 0);
    const vPesoGramas = Number(i.peso || 0); // Assume-se que o banco guarda em gramas
    const vQtd = Number(i.quantidade || 1);
    
    // Converte peso unit√°rio para Kg (ex: 0.050 Kg)
    const vPesoKg = (vPesoGramas / 1000).toFixed(3);

    html += `<tr>
     ${tipo === 3 ? `<td><img src="${i.image}" class="img-mini"></td>` : ''}
     <td>${i.sku || '---'}</td>
     <td>${i.name}</td>
     ${tipo > 1 ? `<td>${vPesoKg} Kg</td><td>${fMoeda(vPreco)}</td>` : ''}
     <td>${vQtd}</td>
     ${tipo > 1 ? `<td>${fMoeda(vPreco * vQtd)}</td>` : ''}
    </tr>`;
  });

  html += `</tbody></table>`;

 if (tipo > 1) {
    // C√°lculo do peso em Kg com 2 casas decimais
    const pesoTotalKg = (Number(p.pesoTotal || 0) / 1000).toFixed(2);

    html += `
     <div class="totais" style="text-align:right; margin-top:15px; font-size:12px; line-height: 1.5;">
      <span>Subtotal: ${fMoeda(p.subtotal)}</span><br>
      <span style="color:#666">Peso Total: ${pesoTotalKg} Kg</span><br>
      <span style="color:#666">Descontos Aplicados: - ${fMoeda(p.descontos)}</span><br>
      
      ${p.ajustadoManualmente ? `
        <div style="color: #2e7d32; font-style: italic; margin-top: 4px;">
          ‚úì Ajuste de negocia√ß√£o aplicado
        </div>` : ''}
      
      ${p.obs ? `
        <div style="background: #fdfaf3; border: 1px solid #f0e6d2; padding: 5px; display: inline-block; margin-top: 5px; text-align: left; border-radius: 4px; font-size: 10px; max-width: 250px;">
          <b>Observa√ß√£o:</b> ${p.obs}
        </div><br>` : ''}

      <div style="margin-top:8px; border-top:2px solid #A68966; padding-top:8px;">
        <span style="font-size:10px; color:#666; text-transform:uppercase;">Valor Final a Pagar:</span><br>
        <b style="font-size:18px; color:#A68966">${fMoeda(p.total)}</b>
      </div>
     </div>`;
  }

  html += `</div>`; // Fecha a div print-body
  document.getElementById('print-area').innerHTML = html;
  
  // Pequeno delay para garantir que as fontes e imagens carreguem antes do print
  setTimeout(() => { window.print(); }, 500);
 }
});
}

  html += `</div>`;
  document.getElementById('print-area').innerHTML = html;
  window.print();
 });
});
}
/* ================= INIT ================= */
window.addEventListener('load',()=>{
 carregarEmpresaSeExistir();
});
</script>

</body>
</html>
