<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Admin • Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        body{background:#0b0b0b;color:#eee;font-family:Inter,Arial}
        nav button.active{border-color:#caa85c;color:#caa85c}
        section{display:none}
        section.active{display:block}
        .card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
        .grid{display:grid;gap:12px}
        @media(min-width:768px){.grid{grid-template-columns:repeat(4,1fr)}}
        input, select{background:#1a1a1a;border:1px solid #333;color:#fff;padding:8px;border-radius:8px;width:100%;font-size:14px;outline:none}
        input:focus{border-color:#caa85c}
        .btn{background:#caa85c;color:#000;font-weight:bold;padding:10px;border-radius:8px;cursor:pointer;text-align:center;display:inline-block;transition:0.2s;font-size:12px;text-transform:uppercase}
        .btn:hover{opacity:0.8}
        .btn-red{background:#ef4444;color:#fff}
        .badge-desconto{position:absolute;top:5px;right:5px;background:#22c55e;color:#fff;font-size:9px;padding:2px 6px;border-radius:4px;font-weight:bold}
        .preco-riscado{text-decoration:line-through;opacity:0.5;font-size:10px}
    </style>
</head>
<body>

<nav class="flex justify-around bg-[#111] p-4 border-b border-[#222] sticky top-0 z-40">
    <button onclick="showTab('tab-pedidos',this)" class="active font-bold text-xs uppercase">Pedidos</button>
    <button onclick="showTab('tab-produtos',this)" class="font-bold text-xs uppercase">Produtos</button>
    <button onclick="showTab('tab-categorias',this)" class="font-bold text-xs uppercase">Categorias</button>
    <button onclick="abrirModalConfig()" class="font-bold text-xs uppercase text-[#caa85c]">Config</button>
    <button onclick="abrirModalPromocao()" class="font-bold text-xs uppercase text-green-500">Promo</button>
</nav>

<main class="p-4 max-w-7xl mx-auto">
    <section id="tab-pedidos" class="active">
        <h2 class="text-[#caa85c] font-bold mb-4 uppercase tracking-widest text-xs">Gerenciar Pedidos</h2>
        <div id="listaPedidos" class="space-y-2"></div>
    </section>

    <section id="tab-produtos">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-[#caa85c] font-bold uppercase tracking-widest text-xs">Produtos</h2>
            <button class="btn" onclick="abrirModalProduto()">+ Novo Produto</button>
        </div>
        <div id="produtosPorCategoria"></div>
    </section>

    <section id="tab-categorias">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-[#caa85c] font-bold uppercase tracking-widest text-xs">Categorias</h2>
            <button class="btn" onclick="abrirModalCategoria()">+ Nova Categoria</button>
        </div>
        <div id="listaCategorias" class="grid"></div>
    </section>
</main>

<div id="modal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4">
    <div class="bg-[#141414] w-full max-w-md rounded-2xl border border-[#2a2a2a] overflow-hidden">
        <div class="p-4 border-b border-[#222] flex justify-between items-center">
            <h2 id="modalTitle" class="text-[#caa85c] font-bold uppercase text-xs"></h2>
            <button onclick="fecharModal()" class="text-gray-500">✕</button>
        </div>
        <div id="modalBody" class="p-6 max-h-[70vh] overflow-y-auto"></div>
        <div class="p-4 bg-[#0b0b0b] flex justify-end gap-2">
            <button onclick="fecharModal()" class="px-4 py-2 text-xs uppercase opacity-50">Cancelar</button>
            <button id="btnSalvar" class="btn">Salvar Alterações</button>
        </div>
    </div>
</div>

<script>
    firebase.initializeApp({
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        authDomain: "catalogo-abella-joias.firebaseapp.com",
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
        projectId: "catalogo-abella-joias"
    });
    const db = firebase.database();

    /* UTILS */
    function showTab(id,btn){
        document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
    }

    function abrirModal(t, b, cb) {
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('modalTitle').innerText = t;
        document.getElementById('modalBody').innerHTML = b;
        const btnS = document.getElementById('btnSalvar');
        if (cb) {
            btnS.style.display = 'block';
            btnS.onclick = () => { cb(); fecharModal(); };
        } else {
            btnS.style.display = 'none';
        }
    }

    function fecharModal() { document.getElementById('modal').style.display = 'none'; }

    /* EMPRESA (AJUSTE CIRÚRGICO) */
    function abrirModalConfig() {
        db.ref('settings/empresa').once('value', s => {
            const v = s.val() || {};
            const html = `
                <div class="space-y-4 text-left">
                    <div>
                        <label class="text-[10px] text-[#caa85c] font-bold uppercase">Nome da Loja</label>
                        <input id="confNome" value="${v.nome || ''}">
                    </div>
                    <div>
                        <label class="text-[10px] text-[#caa85c] font-bold uppercase">WhatsApp (Apenas números)</label>
                        <input id="confWhats" value="${v.fone || ''}">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] text-[#caa85c] font-bold uppercase">Desc. PIX (%)</label>
                            <input type="number" id="confPix" value="${v.descontoPix || 0}">
                        </div>
                        <div>
                            <label class="text-[10px] text-[#caa85c] font-bold uppercase">Min. Pedido (R$)</label>
                            <input type="number" id="confMin" value="${v.minPedido || 0}">
                        </div>
                    </div>
                </div>`;
            abrirModal('Configurações da Loja', html, () => {
                db.ref('settings/empresa').update({
                    nome: document.getElementById('confNome').value,
                    fone: document.getElementById('confWhats').value,
                    descontoPix: parseInt(document.getElementById('confPix').value) || 0,
                    minPedido: parseFloat(document.getElementById('confMin').value) || 0
                }).then(() => alert('Configurações salvas!'));
            });
        });
    }

    /* PROMOÇÕES (AJUSTE CIRÚRGICO) */
    function abrirModalPromocao() {
        db.ref().once('value', snapshot => {
            const data = snapshot.val();
            const promo = data.settings?.promocao || { ativa: false, porcentagem: 0 };
            const cats = data.categories || {};
            
            let listaCats = "";
            Object.entries(cats).forEach(([id, cat]) => {
                listaCats += `
                    <div class="flex justify-between items-center bg-[#0b0b0b] p-2 rounded mb-1 border border-[#222]">
                        <span class="text-[10px] uppercase font-bold text-gray-400">${cat.name}</span>
                        <div class="flex items-center gap-2">
                            <input type="number" id="promo-${id}" class="w-16 bg-[#1a1a1a] border border-[#333] text-center text-xs p-1 rounded text-white" value="${cat.discount || 0}">
                            <span class="text-[10px] text-gray-500">%</span>
                        </div>
                    </div>`;
            });

            const html = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <label class="text-[10px] text-[#caa85c] font-bold uppercase">Status da Promoção</label>
                        <button onclick="togglePromo()" class="px-3 py-1 rounded text-[10px] font-bold ${promo.ativa ? 'bg-green-600' : 'bg-red-600'}">
                            ${promo.ativa ? 'ATIVA' : 'INATIVA'}
                        </button>
                    </div>
                    <div>
                        <label class="text-[10px] text-[#caa85c] font-bold uppercase">Desconto Geral (%)</label>
                        <input type="number" id="promoPorcentagem" value="${promo.porcentagem || 0}">
                    </div>
                    <hr class="border-[#222]">
                    <label class="text-[10px] text-[#caa85c] font-bold uppercase tracking-widest">Descontos por Categoria</label>
                    <div class="max-h-60 overflow-y-auto pr-2">${listaCats}</div>
                </div>`;

            abrirModal('Gerenciar Promoções', html, () => {
                const updates = {};
                const pGeral = parseInt(document.getElementById('promoPorcentagem').value) || 0;
                updates['settings/promocao/porcentagem'] = pGeral;
                
                document.querySelectorAll('[id^="promo-"]').forEach(i => {
                    const catID = i.id.replace('promo-', '');
                    updates['categories/' + catID + '/discount'] = parseInt(i.value || 0);
                });
                
                db.ref().update(updates).then(() => alert('Descontos sincronizados!'));
            });
        });
    }

    function togglePromo() {
        db.ref('settings/promocao/ativa').once('value').then(s => {
            const statusAtual = s.val() || false;
            db.ref('settings/promocao/ativa').set(!statusAtual).then(() => fecharModal());
        });
    }

    /* CATEGORIAS E PRODUTOS (MANTER O QUE JÁ EXISTE) */
    db.ref('categories').on('value',s=>{
        const listaCategorias = document.getElementById('listaCategorias');
        listaCategorias.innerHTML='';
        s.forEach(c=>{
            const d=c.val();
            listaCategorias.innerHTML+=`<div class="card"><b>${d.name}</b><div class="flex gap-1 mt-2"><button class="btn" onclick="editarCategoria('${c.key}')">Editar</button></div></div>`;
        });
    });

    // O restante do seu código de listagem de produtos e pedidos continua aqui...
    // [Omitido para brevidade, mas você deve manter as funções de listagem de pedidos e produtos que já funcionam]
    
    // ABAIXO COLOQUE AS FUNÇÕES DE EDITAR PRODUTO E PEDIDO QUE JÁ TINHA.
</script>
</body>
</html>
