<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Abella Joias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f6f2; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .status-Novo { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }
        .status-Separação { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
        
        @media print {
            body * { visibility: hidden; }
            #romaneio-print, #romaneio-print * { visibility: visible; }
            #romaneio-print { position: absolute; top: 0; left: 0; width: 100%; padding: 30px; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #000; padding: 8px; text-align: left; }
        }
    </style>
</head>
<body>

    <header class="bg-black text-white p-6 border-b-4 border-[#d4af37]">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="font-bold">ABELLA JOIAS ADMIN</h1>
            <nav class="flex gap-4 text-xs font-bold uppercase">
                <button onclick="showTab('pedidos')">Pedidos</button>
                <button onclick="showTab('produtos')">Produtos</button>
                <button onclick="showTab('categorias')">Categorias</button>
                <button onclick="showTab('galvanicas')">Galvânicas</button>
                <button onclick="showTab('config')">Ajustes</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6">
        
        <section id="pedidos" class="tab-content active">
            <h2 class="text-xl font-bold mb-4">Pedidos Recebidos</h2>
            <div id="listaPedidos" class="space-y-4"></div>
        </section>

        <section id="produtos" class="tab-content">
            <div class="bg-white p-6 rounded-xl shadow-sm border mb-6">
                <h3 id="formProdTitle" class="font-bold mb-4 uppercase">Novo Produto</h3>
                <form id="formProduto" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="hidden" id="pId">
                    <input type="text" id="pNome" placeholder="Nome" class="border p-2 rounded" required>
                    <input type="text" id="pSku" placeholder="SKU" class="border p-2 rounded" required>
                    <input type="number" step="0.01" id="pPreco" placeholder="Preço (R$)" class="border p-2 rounded" required>
                    <input type="number" step="0.01" id="pPeso" placeholder="Peso (g)" class="border p-2 rounded" required>
                    <select id="pCat" class="border p-2 rounded"></select>
                    <input type="text" id="pImage" placeholder="URL Imagem" class="border p-2 rounded md:col-span-2">
                    <button type="submit" class="bg-black text-white p-2 rounded font-bold">SALVAR PRODUTO</button>
                    <button type="button" onclick="cancelarEdicaoProd()" class="bg-gray-200 p-2 rounded text-xs hidden" id="btnCancelProd">CANCELAR</button>
                </form>
            </div>
            <div id="gridProdutos" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
        </section>

        <section id="galvanicas" class="tab-content">
            <div class="bg-white p-6 rounded-xl border mb-6">
                <h3 class="font-bold mb-4">Nova Galvânica Parceira</h3>
                <form id="formGalv" class="grid gap-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="gNome" placeholder="Nome da Galvânica" class="border p-2 rounded">
                        <input type="text" id="gEnd" placeholder="Endereço" class="border p-2 rounded">
                        <input type="text" id="gTel" placeholder="Telefone" class="border p-2 rounded">
                        <input type="text" id="gWhats" placeholder="WhatsApp (55...)" class="border p-2 rounded">
                    </div>
                    <textarea id="gDesc" placeholder="Descrição dos serviços" class="border p-2 rounded"></textarea>
                    <input type="text" id="gLogo" placeholder="URL da Logo" class="border p-2 rounded">
                    <button type="submit" class="bg-[#d4af37] text-white p-3 rounded font-bold">CADASTRAR PARCEIRO</button>
                </form>
            </div>
            <div id="listaGalvAdmin" class="grid gap-4"></div>
        </section>

        <section id="config" class="tab-content">
            <div class="bg-white p-8 rounded-xl border max-w-md mx-auto">
                <h3 class="font-bold mb-4">Ajustes da Loja</h3>
                <div class="space-y-4">
                    <label class="block text-xs font-bold">WHATSAPP DE VENDAS</label>
                    <input type="text" id="confPhone" class="w-full border p-2 rounded">
                    
                    <label class="block text-xs font-bold">DESCONTO PIX (%)</label>
                    <input type="number" id="confPix" class="w-full border p-2 rounded">

                    <label class="block text-xs font-bold">PARCELAS SEM JUROS (Ex: 3)</label>
                    <input type="number" id="confParc" class="w-full border p-2 rounded">

                    <button onclick="salvarConfig()" class="w-full bg-black text-white p-3 rounded font-bold uppercase">Atualizar</button>
                </div>
            </div>
        </section>

        <section id="categorias" class="tab-content">
            <div class="bg-white p-6 border rounded-xl max-w-md">
                <h3 class="font-bold mb-4">Nova Categoria</h3>
                <input type="text" id="catNome" placeholder="Nome" class="w-full border p-2 mb-2">
                <input type="file" id="catFile" class="text-xs mb-4">
                <button onclick="salvarCategoria()" class="w-full bg-black text-white p-2 rounded">CRIAR</button>
            </div>
            <div id="listaCategorias" class="grid grid-cols-3 gap-4 mt-6"></div>
        </section>

    </main>

    <div id="romaneio-print" class="hidden">
        <h1 style="text-align:center; font-size:20px; font-weight:bold; margin-bottom:10px;">ABELLA JOIAS - ROMANEIO</h1>
        <div id="rom-header" class="mb-4 text-sm"></div>
        <table style="width:100%; border:1px solid #000;">
            <thead>
                <tr style="background:#eee;">
                    <th>SKU</th>
                    <th>Produto</th>
                    <th>Peso (g)</th>
                    <th>Preço Un.</th>
                </tr>
            </thead>
            <tbody id="rom-body"></tbody>
        </table>
        <div id="rom-footer" style="margin-top:20px; text-align:right;" class="font-bold"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
            authDomain: "catalogo-abella-joias.firebaseapp.com",
            databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
            projectId: "catalogo-abella-joias",
            storageBucket: "catalogo-abella-joias.appspot.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- PRODUTOS COM EDIÇÃO ---
        document.getElementById('formProduto').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('pId').value;
            const p = {
                name: document.getElementById('pNome').value,
                sku: document.getElementById('pSku').value,
                price: parseFloat(document.getElementById('pPreco').value),
                weight: parseFloat(document.getElementById('pPeso').value),
                category: document.getElementById('pCat').value,
                image: document.getElementById('pImage').value
            };
            if(id) db.ref('products/'+id).update(p);
            else db.ref('products').push(p);
            cancelarEdicaoProd();
        };

        function editarProduto(id, p) {
            document.getElementById('pId').value = id;
            document.getElementById('pNome').value = p.name;
            document.getElementById('pSku').value = p.sku;
            document.getElementById('pPreco').value = p.price;
            document.getElementById('pPeso').value = p.weight;
            document.getElementById('pCat').value = p.category;
            document.getElementById('pImage').value = p.image;
            document.getElementById('formProdTitle').innerText = "Editando Produto";
            document.getElementById('btnCancelProd').classList.remove('hidden');
        }

        function cancelarEdicaoProd() {
            document.getElementById('formProduto').reset();
            document.getElementById('pId').value = "";
            document.getElementById('formProdTitle').innerText = "Novo Produto";
            document.getElementById('btnCancelProd').classList.add('hidden');
        }

        db.ref('products').on('value', snap => {
            const grid = document.getElementById('gridProdutos'); grid.innerHTML = '';
            snap.forEach(s => {
                const p = s.val();
                grid.innerHTML += `
                    <div class="bg-white border p-2 rounded text-[10px] relative">
                        <img src="${p.image}" class="w-full aspect-square object-cover mb-1">
                        <b>${p.name}</b><br>SKU: ${p.sku} | ${p.weight}g<br>
                        <span class="text-[#b8860b]">R$ ${p.price.toFixed(2)}</span>
                        <div class="mt-2 flex gap-1">
                            <button onclick='editarProduto("${s.key}", ${JSON.stringify(p)})' class="bg-blue-500 text-white px-2 py-1 rounded">EDITAR</button>
                            <button onclick="db.ref('products/${s.key}').remove()" class="bg-red-500 text-white px-2 py-1 rounded">X</button>
                        </div>
                    </div>
                `;
            });
        });

        // --- PEDIDOS COM EDIÇÃO E ROMANEIO ---
        db.ref('orders').on('value', snap => {
            const list = document.getElementById('listaPedidos'); list.innerHTML = '';
            snap.forEach(s => {
                const o = s.val();
                list.innerHTML += `
                    <div class="bg-white border p-4 rounded-xl flex justify-between items-center shadow-sm">
                        <div class="text-xs">
                            <p class="font-bold text-sm uppercase">${o.cliente}</p>
                            <p>Total: <b>R$ ${parseFloat(o.total).toFixed(2)}</b> | Peso: ${o.peso || 0}g</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick='imprimirRomaneio(${JSON.stringify(o)})' class="bg-black text-white px-3 py-2 rounded text-[10px] font-bold uppercase">Romaneio</button>
                            <button onclick='editarPedido("${s.key}", ${o.total})' class="bg-blue-600 text-white px-3 py-2 rounded text-[10px] font-bold uppercase">Editar</button>
                            <button onclick="db.ref('orders/${s.key}').remove()" class="text-red-500 text-[10px]">Excluir</button>
                        </div>
                    </div>
                `;
            });
        });

        function editarPedido(id, totalAtual) {
            const novoTotal = prompt("Novo valor total do pedido:", totalAtual);
            if(novoTotal !== null) db.ref('orders/'+id).update({ total: parseFloat(novoTotal) });
        }

        function imprimirRomaneio(o) {
            document.getElementById('rom-header').innerHTML = `<p><b>CLIENTE:</b> ${o.cliente} | <b>DATA:</b> ${o.data}</p>`;
            const body = document.getElementById('rom-body'); body.innerHTML = '';
            let pesoT = 0;
            o.itens.forEach(i => {
                pesoT += (i.weight || 0);
                body.innerHTML += `<tr><td>${i.sku}</td><td>${i.name}</td><td>${i.weight || 0}g</td><td>R$ ${i.price.toFixed(2)}</td></tr>`;
            });
            document.getElementById('rom-footer').innerHTML = `<p>PESO TOTAL: ${pesoT.toFixed(2)}g</p><p style="font-size:18px">TOTAL: R$ ${parseFloat(o.total).toFixed(2)}</p>`;
            window.print();
        }

        // --- AJUSTES ---
        function salvarConfig() {
            db.ref('settings').update({
                phone: document.getElementById('confPhone').value,
                pix: document.getElementById('confPix').value,
                installments: document.getElementById('confParc').value
            });
            alert("Ajustes salvos!");
        }

        db.ref('settings').on('value', s => {
            const c = s.val(); if(c){
                document.getElementById('confPhone').value = c.phone || "";
                document.getElementById('confPix').value = c.pix || 0;
                document.getElementById('confParc').value = c.installments || 1;
            }
        });

        // --- CATEGORIAS & GALVANICAS (Simplificado para manter o foco) ---
        document.getElementById('formGalv').onsubmit = (e) => {
            e.preventDefault();
            const g = { nome: gNome.value, endereco: gEnd.value, telefone: gTel.value, whatsapp: gWhats.value, descricao: gDesc.value, logo: gLogo.value };
            db.ref('galvanicas').push(g); e.target.reset();
        };

        async function salvarCategoria() {
            const f = catFile.files[0]; if(!f) return;
            const ref = storage.ref('cat/'+f.name);
            await ref.put(f);
            const url = await ref.getDownloadURL();
            db.ref('categories').push({ name: catNome.value, image: url });
        }

        db.ref('categories').on('value', snap => {
            const list = document.getElementById('listaCategorias');
            const select = document.getElementById('pCat');
            list.innerHTML = ''; select.innerHTML = '';
            snap.forEach(s => {
                list.innerHTML += `<div class="bg-white border p-2 rounded text-center"><img src="${s.val().image}" class="h-16 w-full object-cover mb-1 text-[8px]">${s.val().name}</div>`;
                select.innerHTML += `<option value="${s.key}">${s.val().name}</option>`;
            });
        });

    </script>
</body>
</html>
