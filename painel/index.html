<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo ‚Ä¢ Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:#eee;font-family:Inter,Arial;margin:0}
nav button.active{border-color:#caa85c;color:#caa85c}
section{display:none;min-height:300px}
section.active{display:block}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
.btn{background:#222;border:1px solid #444;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer}
.btn-gold{background:#caa85c;color:#000;font-weight:700}
input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff}

#print-area{display:none}

@media print{
 body *{visibility:hidden}
 #print-area,#print-area *{visibility:visible}
 #print-area{position:absolute;top:0;left:0;width:100%;background:#fff;color:#000;display:block}
}
</style>
</head>

<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222]">
Painel Administrativo ‚Ä¢ Abella Joias
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50">
<button class="btn active" onclick="showTab('empresa',this)">Empresa</button>
<button class="btn" onclick="showTab('categorias',this)">Categorias</button>
<button class="btn" onclick="showTab('produtos',this)">Produtos</button>
<button class="btn" onclick="abrirPromocoes()">Promo√ß√µes</button>
<button class="btn" onclick="showTab('pedidos',this)">Pedidos</button>
</nav>

<main class="p-6">

<section id="empresa" class="active">
<div class="card space-y-3">
<h2 class="text-[#caa85c] font-bold">Configura√ß√µes da Loja</h2>
<input id="empNome" placeholder="Nome da Empresa">
<input id="empSub" placeholder="Subt√≠tulo">
<input id="empWhats" placeholder="WhatsApp">
<input id="empDesc" type="number" placeholder="Desconto PIX (%)">
<input id="empParc" type="number" placeholder="Parcelas sem acr√©scimo">
<button class="btn-gold w-full" onclick="salvarEmpresa()">Salvar</button>
</div>
</section>

<section id="categorias">
<button class="btn-gold mb-3" onclick="novaCategoria()">+ Nova Categoria</button>
<div id="listaCategorias"></div>
</section>

<section id="produtos">
<button class="btn-gold mb-3" onclick="novoProduto()">+ Novo Produto</button>
<div id="listaProdutos"></div>
</section>

<section id="pedidos">
<h2 class="text-[#caa85c] font-bold mb-4">Pedidos</h2>
<div id="listaPedidos" class="grid gap-4"></div>
</section>

<div id="print-area"></div>

</main>

<script>
/* FIREBASE */
firebase.initializeApp({
 apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
 databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com"
});
const db=firebase.database();

/* HELPERS */
const fMoeda=v=>new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);

/* NAVEGA√á√ÉO - AJUSTE CIR√öRGICO PARA VOLTAR A FUNCIONAR */
function showTab(id,btn){
 document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
 const target = document.getElementById(id);
 if(target) target.classList.add('active');

 document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
 if(btn) btn.classList.add('active');

 if(id==='categorias') carregarCategorias();
 if(id==='produtos') carregarProdutos();
 if(id==='pedidos') carregarPedidos();
}

/* EMPRESA */
function salvarEmpresa(){
 db.ref('settings/empresa').set({
  nome: document.getElementById('empNome').value,
  subtitulo: document.getElementById('empSub').value,
  whats: document.getElementById('empWhats').value,
  descontoPix: +document.getElementById('empDesc').value||0,
  parcelas: +document.getElementById('empParc').value||0
 });
 alert('Salvo');
}

/* CATEGORIAS - ORDEM ALFAB√âTICA E CARDS PEQUENOS */
function carregarCategorias() {
  db.ref('categories').once('value', s => {
    const lista = document.getElementById('listaCategorias');
    lista.innerHTML = '';
    let cats = [];
    s.forEach(c => { cats.push({ key: c.key, ...c.val() }); });

    // Ordena√ß√£o Alfab√©tica [Ajuste Cir√∫rgico]
    cats.sort((a, b) => a.name.localeCompare(b.name));

    cats.forEach(c => {
      // Verifica se existe campo de imagem na categoria (indicador)
      const temImg = c.image ? '<span title="Possui Imagem">üñºÔ∏è</span>' : '<span class="opacity-20">üö´</span>';
      
      lista.innerHTML += `
        <div class="card flex justify-between items-center mb-2 py-2 px-4 text-sm">
          <div class="flex items-center gap-3">
            ${temImg}
            <b class="uppercase">${c.name}</b>
          </div>
          <div class="flex gap-2">
            <button class="btn text-blue-400 hover:bg-blue-900/20" onclick="editarCategoria('${c.key}', '${c.name}')">‚úé</button>
            <button class="btn text-red-500 hover:bg-red-900/20" onclick="if(confirm('Excluir categoria?')) db.ref('categories/${c.key}').remove().then(()=>carregarCategorias())">X</button>
          </div>
        </div>`;
    });
  });
}

/* PRODUTOS - SEPARADOS POR CATEGORIA E ORDEM DE SKU */
function carregarProdutos() {
  db.ref('products').once('value', s => {
    const lista = document.getElementById('listaProdutos');
    lista.innerHTML = '';
    let prods = [];
    s.forEach(p => { prods.push({ key: p.key, ...p.val() }); });

    // Ordena√ß√£o: 1¬∫ Categoria (Alfab√©tica), 2¬∫ SKU (Crescente)
    prods.sort((a, b) => {
      let catA = (a.category || "Sem Categoria").toUpperCase();
      let catB = (b.category || "Sem Categoria").toUpperCase();
      if (catA !== catB) return catA.localeCompare(catB);
      return (a.sku || "").localeCompare(b.sku || "", undefined, {numeric: true});
    });

    let currentCat = "";
    prods.forEach(p => {
      // Criar cabe√ßalho de categoria se mudar
      if ((p.category || "Sem Categoria") !== currentCat) {
        currentCat = p.category || "Sem Categoria";
        lista.innerHTML += `<div class="text-[#caa85c] font-bold text-xs uppercase mt-4 mb-2 border-b border-[#caa85c]/30 pb-1">${currentCat}</div>`;
      }

      const temImg = p.image ? 'üñºÔ∏è' : '<span class="text-red-800">üö´</span>';
      
      lista.innerHTML += `
        <div class="card flex justify-between items-center mb-1 py-1 px-3 text-[12px]">
          <div class="flex-1">
            <span class="text-gray-500 font-mono text-[10px]">[${p.sku || 'S/ SKU'}]</span> 
            <b class="ml-1">${p.name}</b> ${temImg}
            <span class="ml-2 text-gray-400">${fMoeda(p.price)}</span>
          </div>
          <div class="flex gap-1">
            <button class="btn py-0 px-2 text-blue-400" onclick="editarProduto('${p.key}')">‚úé</button>
            <button class="btn py-0 px-2 text-red-500" onclick="if(confirm('Excluir produto?')) db.ref('products/${p.key}').remove().then(()=>carregarProdutos())">X</button>
          </div>
        </div>`;
    });
  });
}
function abrirPromocoes(){
 const tipo = confirm("OK para promo√ß√£o por CATEGORIA\nCANCELAR para promo√ß√£o por PRODUTO");
 const pct = prompt("Porcentagem de desconto (ex: 10)");
 if(!pct) return;

 if(tipo){
  const cat = prompt("Nome da Categoria exatamente como cadastrada:");
  db.ref('products').once('value', s => {
   s.forEach(p => {
    if(p.val().category === cat){
     const precoOriginal = p.val().price;
     const novoPreco = precoOriginal * (1 - pct/100);
     db.ref('products/'+p.key).update({ precoFinal: novoPreco, promoLabel: pct+'% OFF' });
    }
   });
   alert("Promo√ß√£o aplicada √† categoria!");
  });
 }
}

/* PEDIDOS - AJUSTE DEFINITIVO */
/* PEDIDOS - COM 3 TIPOS DE ROMANEIO */
function carregarPedidos() {
  const listaPedidos = document.getElementById('listaPedidos');
  listaPedidos.innerHTML = '<p class="p-4 text-center text-gray-500">Carregando pedidos...</p>';

  db.ref('orders').on('value', snapshot => {
    listaPedidos.innerHTML = '';
    if (!snapshot.exists()) {
      listaPedidos.innerHTML = '<p class="p-4 text-center text-gray-500">Nenhum pedido encontrado.</p>';
      return;
    }

    let pedidosHtml = [];
    snapshot.forEach(ped => {
      const p = ped.val();
      const id = ped.key;
      const nomeCliente = (p.cliente && typeof p.cliente === 'object') ? p.cliente.nome : (p.cliente || 'Cliente s/ nome');
      
      const html = `
        <div class="card mb-3 border-l-4 border-[#caa85c]">
          <div class="flex justify-between items-start mb-2">
            <div>
              <b class="text-[#caa85c] text-sm uppercase">${nomeCliente}</b>
              <p class="text-[10px] text-gray-400">${p.data || ''}</p>
            </div>
            <span class="bg-[#222] px-2 py-1 rounded text-[9px] font-bold uppercase">${p.pagamento || 'N/A'}</span>
          </div>
          <div class="grid grid-cols-3 gap-1 mt-2 border-t border-[#2a2a2a] pt-2">
            <button class="btn text-[9px] py-1" onclick="gerarRomaneio('${id}', 1)">Simples</button>
            <button class="btn text-[9px] py-1" onclick="gerarRomaneio('${id}', 2)">Completo</button>
            <button class="btn text-[9px] py-1" onclick="gerarRomaneio('${id}', 3)">Com Foto</button>
          </div>
          <div class="mt-2 text-right">
             <b class="text-white text-sm">${fMoeda(p.total)}</b>
          </div>
        </div>`;
      pedidosHtml.push(html);
    });
    listaPedidos.innerHTML = pedidosHtml.reverse().join('');
  });
}

function gerarRomaneio(id, tipo = 1) {
 db.ref('orders/'+id).once('value', s => {
  const p = s.val(); if(!p) return;
  db.ref('settings/empresa').once('value', e => {
   const emp = e.val() || {};
   let html = `
   <style>
    .print-body { font-family: 'Poppins', sans-serif; color:#000; padding:20px; font-size: 11px; }
    .lux-head { text-align:center; border-bottom:2px solid #A68966; padding-bottom:10px; margin-bottom:15px; }
    .lux-head h1 { font-family: 'Cinzel', serif; margin:0; color:#A68966; font-size:24px; }
    .grid-dados { display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:15px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:11px; }
    table th { background:#f9f9f9; text-align:left; border-bottom:1px solid #000; padding:5px; }
    table td { border-bottom:1px solid #eee; padding:5px; }
    .totais { text-align:right; margin-top:15px; font-size:12px; }
    .img-mini { width:40px; height:40px; object-fit:cover; border-radius:4px; }
   </style>
   <div class="print-body">
    <div class="lux-head">
     <h1>${emp.nome || 'Abella Joias'}</h1>
     <p>${emp.subtitulo || ''}<br>WhatsApp: ${emp.whats || ''}</p>
    </div>
    
    <div class="grid-dados">
     <div>
      <b>DADOS DO CLIENTE</b><br>
      Nome: ${p.cliente?.nome || p.cliente}<br>
      WhatsApp: ${p.cliente?.telefone || p.whatsapp || ''}
     </div>
     <div>
      <b>LOCAL DE ENTREGA</b><br>
      ${p.endereco?.nome || 'Residencial'}<br>
      ${p.endereco?.rua || ''}, ${p.endereco?.num || ''}<br>
      ${p.endereco?.bairro || ''} - ${p.endereco?.cidade || ''}
     </div>
    </div>

    <table>
     <thead>
      <tr>
       ${tipo === 3 ? '<th>Foto</th>' : ''}
       <th>SKU</th>
       <th>Produto</th>
       ${tipo > 1 ? '<th>Peso U.</th><th>Pre√ßo U.</th>' : ''}
       <th>Qtd</th>
       ${tipo > 1 ? '<th>Subtotal</th>' : ''}
      </tr>
     </thead>
     <tbody>`;

   p.itens.forEach(i => {
    const vPreco = Number(i.precoFinal || i.price || 0);
    const vPeso = Number(i.peso || 0);
    const vQtd = Number(i.quantidade || 1);
    
    html += `<tr>
     ${tipo === 3 ? `<td><img src="${i.image}" class="img-mini"></td>` : ''}
     <td>${i.sku || '---'}</td>
     <td>${i.name}</td>
     ${tipo > 1 ? `<td>${vPeso.toFixed(2)}g</td><td>${fMoeda(vPreco)}</td>` : ''}
     <td>${vQtd}</td>
     ${tipo > 1 ? `<td>${fMoeda(vPreco * vQtd)}</td>` : ''}
    </tr>`;
   });

   html += `</tbody></table>`;

   if(tipo > 1) {
    html += `
     <div class="totais">
      Subtotal: ${fMoeda(p.subtotal)}<br>
      Peso Total: ${p.pesoTotal?.toFixed(2)}g<br>
      Descontos: - ${fMoeda(p.descontos)}<br>
      <b style="font-size:16px; color:#A68966">TOTAL: ${fMoeda(p.total)}</b>
     </div>`;
   }

   html += `</div>`;
   document.getElementById('print-area').innerHTML = html;
   window.print();
  });
 });
}

/* START */
window.addEventListener('load',()=>{
 // Inicia na aba empresa
 carregarEmpresaSeExistir(); 
});

function carregarEmpresaSeExistir(){
    db.ref('settings/empresa').once('value', s => {
        const v = s.val();
        if(v){
            document.getElementById('empNome').value = v.nome || '';
            document.getElementById('empSub').value = v.subtitulo || '';
            document.getElementById('empWhats').value = v.whats || '';
            document.getElementById('empDesc').value = v.descontoPix || 0;
            document.getElementById('empParc').value = v.parcelas || 0;
        }
    });
}
</script>

</body>
</html>
