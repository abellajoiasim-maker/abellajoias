<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Admin ‚Ä¢ Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:#eee;font-family:Inter,Arial}
nav button.active{border-color:#caa85c;color:#caa85c}
section{display:none}
section.active{display:block}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
.grid{display:grid;gap:12px}
@media(min-width:768px){.grid{grid-template-columns:repeat(4,1fr)}}
@media(min-width:1200px){.grid{grid-template-columns:repeat(6,1fr)}}
.btn{background:#222;border:1px solid #444;padding:6px 10px;border-radius:8px;font-size:12px}
.btn-gold{background:#caa85c;color:#000;font-weight:700}
.btn-red{border-color:#c33;color:#f77}
.btn-pause{border-color:#caa85c;color:#caa85c}
.tag{font-size:10px;padding:3px 6px;border-radius:999px}
.ok{background:#1f3;color:#000}
.no{background:#c33}
#modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:100;align-items:center;justify-content:center}
.modal-box{background:#141414;border:1px solid #333;border-radius:20px;width:100%;max-width:520px;padding:20px;max-height:90vh;overflow-y:auto}
.modal-img{height:180px;object-fit:contain;background:#000;border-radius:12px;margin-bottom:12px}
input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px}
/* ... outros estilos ... */
input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px}

/* COLE AQUI (antes do fechamento do style) */
@media print {
    body * { visibility: hidden; }
    #romaneio-print, #romaneio-print * { visibility: visible; }
    #romaneio-print { 
        position: absolute; left: 0; top: 0; width: 100%; 
        color: #000 !important; background: #fff !important; 
        padding: 20px; font-size: 12px;
    }
    .no-print { display: none !important; }
}
</style>
</head>

<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222]">
Painel Administrativo ‚Ä¢ Abella Joias
</header>

<nav class="flex gap-2 p-2 bg-[#111]">
<button class="btn active" onclick="showTab('empresa',this)">Empresa</button>
<button class="btn" onclick="showTab('categorias',this)">Categorias</button>
<button class="btn" onclick="showTab('produtos',this)">Produtos</button>
<button class="btn" onclick="showTab('promocoes',this)">Promo√ß√µes</button>
<button class="btn" onclick="showTab('pedidos',this)">Pedidos</button>
</nav>

<main class="p-6">

<!-- EMPRESA -->
<section id="empresa" class="active">
<div class="card max-w-md">
<input id="empNome" placeholder="Nome da empresa">
<input id="empWhats" placeholder="WhatsApp">
<input id="empPix" type="number" placeholder="Desconto PIX %">
<input id="empParc" type="number" placeholder="Parcelas">
<button class="btn-gold w-full mt-2" onclick="salvarEmpresa()">Salvar</button>
</div>
</section>

<!-- CATEGORIAS -->
<section id="categorias">
<button class="btn-gold mb-3" onclick="novaCategoria()">+ Nova Categoria</button>
<div id="listaCategorias" class="grid"></div>
</section>

<!-- PRODUTOS -->
<section id="produtos">
<div id="produtosPorCategoria"></div>
</section>

<!-- PROMO√á√ïES -->
<section id="promocoes">
<div id="listaPromocoes" class="space-y-3 max-w-md"></div>
<button class="btn-gold mt-4" onclick="salvarPromos()">Aplicar promo√ß√µes</button>
</section>

<!-- PEDIDOS -->
<section id="pedidos">
<div id="listaPedidos" class="space-y-3"></div>
</section>

</main>

<!-- MODAL -->
<div id="modal">
<div class="modal-box">
<h3 id="modalTitle" class="font-bold mb-2"></h3>
<div id="modalBody"></div>
<button class="btn-gold w-full mt-3" id="btnSalvar">Salvar</button>
<button class="btn w-full mt-2" onclick="fecharModal()">Fechar</button>
</div>
</div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
 authDomain:"catalogo-abella-joias.firebaseapp.com",
 databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com",
 projectId:"catalogo-abella-joias"
});
const db=firebase.database();

/* NAV */
function showTab(id,btn){
 document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
 document.getElementById(id).classList.add('active');
 document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
 btn.classList.add('active');
}

/* EMPRESA */
db.ref('settings').on('value',s=>{
 const v=s.val()||{};
 empNome.value=v.nome||'';
 empWhats.value=v.whatsapp||'';
 empPix.value=v.pix||0;
 empParc.value=v.parcelas||1;
});
function salvarEmpresa(){
 db.ref('settings').update({
  nome:empNome.value,
  whatsapp:empWhats.value,
  pix:+empPix.value,
  parcelas:+empParc.value
 });
 alert('Empresa salva');
}

/* CATEGORIAS */
db.ref('categories').on('value',s=>{
 listaCategorias.innerHTML='';
 listaPromocoes.innerHTML='';
 s.forEach(c=>{
  const d=c.val();
  listaCategorias.innerHTML+=`
  <div class="card">
   <div class="flex justify-between">
    <b>${d.name}</b>
    <span class="tag ${d.image?'ok':'no'}">IMG</span>
   </div>
   <div class="text-xs opacity-60">${Object.keys(d.variacoes||{}).length} varia√ß√µes</div>
   <div class="flex gap-1 mt-2">
    <button class="btn" onclick="editarCategoria('${c.key}')">Editar</button>
    <button class="btn btn-pause" onclick="togglePause('categories','${c.key}')">Pausar</button>
    <button class="btn btn-red" onclick="excluir('categories','${c.key}')">Excluir</button>
   </div>
  </div>`;
  
  listaPromocoes.innerHTML+=`
  <div class="card flex justify-between items-center">
   <span>${d.name}</span>
   <input type="number" id="promo-${c.key}" value="${d.discount||0}" class="w-20">
  </div>`;
 });
});

/* VARIA√á√ïES NAS CATEGORIAS */
function editarCategoria(id){
 db.ref('categories/'+id).once('value').then(s=>{
  const d=s.val();
  abrirModal('Editar Categoria',`
   <img src="${d.image||''}" class="modal-img">
   <input id="catName" value="${d.name}">
   <input id="catImg" value="${d.image||''}">
   <h4 class="mt-3 font-bold">Varia√ß√µes</h4>
   <div id="vars"></div>
   <button class="btn mt-2" onclick="novaVariacao('${id}')">+ Nova Varia√ß√£o</button>
  `,()=>{
   db.ref('categories/'+id).update({
    name:catName.value,
    image:catImg.value
   });
  });
  
  const box=document.getElementById('vars');
  Object.entries(d.variacoes||{}).forEach(([k,v])=>{
   box.innerHTML+=`
   <div class="flex gap-2 mb-1 text-xs">
    <input value="${v.label||k}" onchange="updVar('${id}','${k}',this.value)">
    <button class="btn btn-red" onclick="delVar('${id}','${k}')">‚úï</button>
   </div>`;
  });
 });
}
function novaVariacao(cat){
 const k=prompt('Chave da varia√ß√£o (ex: A, DEUS)');
 if(!k) return;
 db.ref(`categories/${cat}/variacoes/${k}`).set({label:k,ativo:true});
}
function updVar(cat,key,val){
 db.ref(`categories/${cat}/variacoes/${key}`).update({label:val});
}
function delVar(cat,key){
 db.ref(`categories/${cat}/variacoes/${key}`).remove();
}

/* PRODUTOS */
db.ref('products').on('value',s=>{
 const map={};
 s.forEach(p=>{
  const v=p.val();v.id=p.key;
  if(!map[v.category]) map[v.category]=[];
  map[v.category].push(v);
 });
 produtosPorCategoria.innerHTML='';
 Object.keys(map).forEach(cat=>{
  produtosPorCategoria.innerHTML+=`<h3 class="text-[#caa85c] mt-6 mb-2">${cat}</h3><div class="grid"></div>`;
  const g=produtosPorCategoria.lastChild;
  map[cat].forEach(p=>{
   g.innerHTML+=`
   <div class="card">
    <div class="flex justify-between">
     <b>${p.sku||''}</b>
     <span class="tag ${p.image?'ok':'no'}">IMG</span>
    </div>
    <div class="text-xs">${p.name}</div>
    <div class="flex gap-1 mt-2">
     <button class="btn" onclick="editarProduto('${p.id}')">Editar</button>
     <button class="btn btn-pause" onclick="togglePause('products','${p.id}')">Pausar</button>
     <button class="btn btn-red" onclick="excluir('products','${p.id}')">Excluir</button>
    </div>
   </div>`;
  });
 });
});

/* PRODUTO MODAL COM VARIA√á√ïES CORRIGIDO */
function editarProduto(id){
  db.ref('products/'+id).once('value').then(s=>{
    const p = s.val();
    // Busca as varia√ß√µes da categoria correta deste produto
    db.ref('categories/'+p.category+'/variacoes').once('value').then(vs=>{
      let opts = '<option value="">Sem varia√ß√£o</option>'; // Op√ß√£o padr√£o
      
      if(vs.exists()){
        vs.forEach(child => {
          const varData = child.val();
          const varKey = child.key;
          const varLabel = varData.label || varKey;
          
          // Verifica se esta √© a varia√ß√£o que o produto j√° tem selecionada
          const selected = (p.variacao === varKey) ? 'selected' : '';
          
          opts += `<option value="${varKey}" ${selected}>${varLabel}</option>`;
        });
      }

      abrirModal('Editar Produto', `
        <img src="${p.image || ''}" class="modal-img">
        <label class="text-[10px] uppercase opacity-50">Nome do Produto</label>
        <input id="pName" value="${p.name}">
        <label class="text-[10px] uppercase opacity-50">SKU</label>
        <input id="pSku" value="${p.sku}">
        <label class="text-[10px] uppercase opacity-50">Pre√ßo</label>
        <input id="pPrice" type="number" step="0.01" value="${p.price}">
        <label class="text-[10px] uppercase opacity-50">Peso (g)</label>
        <input id="pWeight" value="${p.weight}">
        <label class="text-[10px] uppercase opacity-50">Varia√ß√£o da Categoria</label>
        <select id="pVar">${opts}</select>
        <label class="text-[10px] uppercase opacity-50">URL da Imagem</label>
        <input id="pImg" value="${p.image}">
      `, () => {
        db.ref('products/' + id).update({
          name: pName.value,
          sku: pSku.value,
          price: pPrice.value,
          weight: pWeight.value,
          variacao: pVar.value,
          image: pImg.value
        });
      });
    });
  });
}

/* PROMOS */
function salvarPromos(){
 document.querySelectorAll('[id^="promo-"]').forEach(i=>{
  db.ref('categories/'+i.id.replace('promo-','')).update({discount:+i.value});
 });
 alert('Promo√ß√µes atualizadas');
}

/* PEDIDOS - GEST√ÉO COMPLETA (ATUALIZADO: DETALHES T√âCNICOS E FINANCEIROS) */
db.ref('orders').on('value', s => {
    const lista = document.getElementById('listaPedidos');
    lista.innerHTML = '';
    if (!s.exists()) {
        lista.innerHTML = '<div class="p-10 text-center opacity-50">Nenhum pedido recebido.</div>';
        return;
    }
    s.forEach(o => {
        const pedido = o.val();
        const id = o.key;
        const totalNum = parseFloat(pedido.total) || 0;

        lista.innerHTML += `
        <div class="card flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
            <div>
                <div class="text-[10px] opacity-40 font-mono">${id}</div>
                <div class="font-bold text-[#caa85c]">${pedido.cliente || 'Cliente'}</div>
                <div class="text-[11px]">Total: R$ ${totalNum.toFixed(2)}</div>
            </div>
            <div class="flex gap-1">
                <button class="btn" onclick="verDetalhesPedido('${id}')">Ver / Imprimir</button>
                <button class="btn btn-gold" onclick="editarPedido('${id}')">Editar</button>
                <button class="btn btn-red" onclick="excluir('orders','${id}')">Excluir</button>
            </div>
        </div>`;
    });
});

function verDetalhesPedido(id) {
    db.ref('orders/' + id).once('value').then(s => {
        const p = s.val();
        if(!p) return;
        let itensHtml = '';
        if(p.itens) {
            Object.values(p.itens).forEach(item => {
                const sub = (parseFloat(item.preco || 0) * item.qtd).toFixed(2);
                itensHtml += `
                <div class="border-b border-[#222] py-2 text-[11px]">
                    <div class="flex justify-between">
                        <span class="font-bold">${item.qtd}x ${item.nome}</span>
                        <span class="text-[#caa85c]">R$ ${sub}</span>
                    </div>
                    <div class="opacity-50 text-[9px]">SKU: ${item.sku || 'N/A'} | Peso: ${item.peso || 0}g</div>
                </div>`;
            });
        }
        
        abrirModal('Detalhes do Pedido', `
            <div id="romaneio-area">
                <div class="grid grid-cols-2 gap-4 mb-4 text-[11px]">
                    <div>
                        <h4 class="text-[#caa85c] font-bold uppercase text-[9px]">Cliente</h4>
                        <p class="font-bold">${p.cliente || 'N/A'}</p>
                        <p class="opacity-60">${p.whatsapp || 'N/A'}</p>
                    </div>
                    <div>
                        <h4 class="text-[#caa85c] font-bold uppercase text-[9px]">Pagamento</h4>
                        <p>${p.pagamento || 'N/A'}</p>
                        <p class="text-green-500">Desconto: R$ ${parseFloat(p.descontoPix || 0).toFixed(2)}</p>
                    </div>
                </div>
                <div class="mb-4">
                    <h4 class="text-[#caa85c] font-bold uppercase text-[9px] mb-1">Itens do Pedido</h4>
                    ${itensHtml}
                </div>
                <div class="bg-[#1a1a1a] p-3 rounded-lg flex justify-between items-center mb-4">
                    <span class="font-bold text-xs">VALOR FINAL:</span>
                    <span class="font-bold text-lg text-green-500">R$ ${(parseFloat(p.total) || 0).toFixed(2)}</span>
                </div>
                <div class="grid grid-cols-2 gap-2 no-print">
                    <button onclick="gerarRomaneio('${id}', 'completo')" class="btn bg-blue-600 text-white border-none">üñ®Ô∏è Romaneio Completo</button>
                    <button onclick="gerarRomaneio('${id}', 'simples')" class="btn bg-gray-700 text-white border-none">üìÑ Romaneio Simples</button>
                </div>
            </div>
        `, null);
        document.getElementById('btnSalvar').style.display = 'none';
    });
}

function gerarRomaneio(id, tipo) {
    db.ref('orders/' + id).once('value').then(s => {
        const p = s.val();
        const dataAtual = new Date().toLocaleString('pt-BR');
        let pesoTotal = 0;
        let subtotalProdutos = 0;

        let romaneioHtml = `<div id="romaneio-print" style="font-family:sans-serif;color:#000;background:#fff;padding:10px;">
            <div style="text-align:center;border-bottom:2px solid #000;padding-bottom:10px;margin-bottom:15px;">
                <h2 style="margin:0">ABELLA JOIAS</h2>
                <p style="margin:0;font-size:11px;">Pedido: ${id.toUpperCase()} | Data: ${dataAtual}</p>
            </div>`;

        if (tipo === 'completo') {
            romaneioHtml += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;font-size:11px;border:1px solid #eee;padding:8px;">
                <div><strong>CLIENTE:</strong> ${p.cliente}<br><strong>WHATSAPP:</strong> ${p.whatsapp}<br><strong>ENDERE√áO:</strong> ${p.endereco || 'Retirada'}</div>
                <div><strong>PAGAMENTO:</strong> ${p.pagamento}<br><strong>DESCONTO APLICADO:</strong> R$ ${parseFloat(p.descontoPix || 0).toFixed(2)}</div>
            </div>`;
        }

        romaneioHtml += `<table style="width:100%;border-collapse:collapse;font-size:10px;">
            <thead><tr style="border-bottom:1px solid #000;text-align:left;">
                <th>SKU</th><th>Produto</th><th>Qtd</th>${tipo==='completo'?'<th>Peso U.</th><th>Pre√ßo U.</th>':''}<th>Subtotal</th>
            </tr></thead><tbody>`;

        Object.values(p.itens || {}).forEach(item => {
            const vUnit = parseFloat(item.preco || 0);
            const pUnit = parseFloat(item.peso || 0);
            const sub = vUnit * item.qtd;
            pesoTotal += pUnit * item.qtd;
            subtotalProdutos += sub;

            romaneioHtml += `<tr style="border-bottom:1px solid #eee;">
                <td style="padding:4px 0;">${item.sku || '-'}</td>
                <td>${item.nome} ${item.variacao ? '('+item.variacao+')' : ''}</td>
                <td>${item.qtd}</td>
                ${tipo==='completo'?`<td>${pUnit}g</td><td>R$ ${vUnit.toFixed(2)}</td>`:''}
                <td style="text-align:right;">R$ ${sub.toFixed(2)}</td>
            </tr>`;
        });

        romaneioHtml += `</tbody></table>
        <div style="margin-top:15px; border-top:1px solid #000; padding-top:10px; font-size:11px; text-align:right;">
            ${tipo==='completo'?`<p style="margin:2px 0;">Peso Total do Pedido: <strong>${pesoTotal.toFixed(2)}g</strong></p>`:''}
            <p style="margin:2px 0; font-size:14px;"><strong>TOTAL FINAL: R$ ${(parseFloat(p.total) || 0).toFixed(2)}</strong></p>
        </div></div>`;

        const divTemp = document.createElement('div');
        divTemp.innerHTML = romaneioHtml;
        document.body.appendChild(divTemp);
        window.print();
        document.body.removeChild(divTemp);
    });
}

/* PEDIDOS COM EDI√á√ÉO DE ITENS E SOMA AUTOM√ÅTICA */
function editarPedido(id) {
    db.ref('orders/' + id).once('value').then(s => {
        const p = s.val();
        if (!p) return;

        // Criamos uma estrutura para os itens edit√°veis
        let itensEditHtml = '';
        const itensIds = Object.keys(p.itens || {});
        
        itensIds.forEach(itemId => {
            const item = p.itens[itemId];
            itensEditHtml += `
            <div class="item-edit-row border-b border-[#222] py-2 mb-2" data-id="${itemId}">
                <div class="text-[10px] font-bold text-[#caa85c] mb-1">${item.nome}</div>
                <div class="flex gap-2">
                    <div class="w-20">
                        <label class="text-[9px] opacity-50 uppercase">Qtd</label>
                        <input type="number" class="edit-qtd" value="${item.qtd}" 
                            oninput="recalcularTotalEdicao()" 
                            data-preco="${item.preco}" 
                            style="margin-bottom:0">
                    </div>
                    <div class="flex-1">
                        <label class="text-[9px] opacity-50 uppercase">Pre√ßo Unit.</label>
                        <input type="number" class="edit-preco" value="${item.preco}" readonly 
                            style="margin-bottom:0; opacity:0.6">
                    </div>
                </div>
            </div>`;
        });

        abrirModal('Editar Pedido', `
            <div class="space-y-3">
                <label class="text-[10px] uppercase opacity-50">Nome do Cliente</label>
                <input id="editCli" value="${p.cliente || ''}">
                
                <label class="text-[10px] uppercase opacity-50">Endere√ßo de Entrega</label>
                <input id="editEnd" value="${p.endereco || ''}">

                <h4 class="text-[#caa85c] font-bold uppercase text-[10px] mt-4 border-b border-[#333] pb-1">Itens e Quantidades</h4>
                <div id="containerItensEdit" class="max-h-[200px] overflow-y-auto pr-2">
                    ${itensEditHtml}
                </div>

                <div class="bg-[#1a1a1a] p-3 rounded-lg mt-4">
                    <label class="text-[10px] uppercase opacity-50 text-green-500 font-bold">Valor Total Final (Edit√°vel)</label>
                    <input id="editTotal" type="number" step="0.01" value="${parseFloat(p.total) || 0}" 
                        style="font-size:18px; font-weight:bold; color:#22c55e;">
                    <p class="text-[9px] opacity-50 italic">* O total recalcula ao mudar a Qtd, mas voc√™ pode ajustar manualmente se quiser.</p>
                </div>
            </div>
        `, () => {
            // SALVAR AS ALTERA√á√ïES
            const novosItens = { ...p.itens };
            document.querySelectorAll('.item-edit-row').forEach(row => {
                const itemId = row.getAttribute('data-id');
                const novaQtd = parseInt(row.querySelector('.edit-qtd').value) || 0;
                if (novaQtd > 0) {
                    novosItens[itemId].qtd = novaQtd;
                } else {
                    delete novosItens[itemId]; // Se a qtd for 0, remove o item
                }
            });

            db.ref('orders/' + id).update({
                cliente: document.getElementById('editCli').value,
                endereco: document.getElementById('editEnd').value,
                total: parseFloat(document.getElementById('editTotal').value) || 0,
                itens: novosItens
            }).then(() => alert("Pedido atualizado!"));
        });
    });
}

// Fun√ß√£o auxiliar que soma tudo em tempo real enquanto voc√™ digita no modal
function recalcularTotalEdicao() {
    let novaSoma = 0;
    document.querySelectorAll('.item-edit-row').forEach(row => {
        const qtd = parseInt(row.querySelector('.edit-qtd').value) || 0;
        const preco = parseFloat(row.querySelector('.edit-qtd').getAttribute('data-preco')) || 0;
        novaSoma += (qtd * preco);
    });
    
    // Atualiza o campo de valor total automaticamente
    document.getElementById('editTotal').value = novaSoma.toFixed(2);
}
function abrirModal(t, b, cb) {
    modal.style.display = 'flex';
    modalTitle.innerText = t;
    modalBody.innerHTML = b;
    if (cb) {
        btnSalvar.style.display = 'block';
        btnSalvar.onclick = () => { cb(); fecharModal(); };
    } else {
        btnSalvar.style.display = 'none';
    }
}
function fecharModal() { modal.style.display = 'none'; }
function excluir(p, id) { if (confirm('Excluir permanentemente?')) db.ref(p + '/' + id).remove(); }
function togglePause(p, id) { db.ref(p + '/' + id + '/paused').transaction(v => !v); }
</script>
</body>
</html>
