<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Abella | Sistema Inteligente</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body { background:#f4f4f4; font-family: sans-serif; }
.tab { display:none }
.tab.active { display:block }
.card { background:white; border-radius:10px; padding:10px; border:1px solid #ddd; cursor:pointer }
.dot { width:8px; height:8px; border-radius:50%; display:inline-block }
</style>
</head>

<body>

<!-- NAV -->
<nav class="flex bg-white shadow sticky top-0 z-50">
  <button class="flex-1 p-3 font-bold" onclick="tab('empresa')">EMPRESA</button>
  <button class="flex-1 p-3 font-bold" onclick="tab('categorias')">CATEGORIAS</button>
  <button class="flex-1 p-3 font-bold" onclick="tab('produtos')">PRODUTOS</button>
  <button class="flex-1 p-3 font-bold" onclick="tab('promos')">PROMO√á√ïES</button>
  <button class="flex-1 p-3 font-bold" onclick="tab('pedidos')">PEDIDOS</button>
</nav>

<main class="p-4 max-w-6xl mx-auto">

<!-- EMPRESA -->
<div id="empresa" class="tab active bg-white p-4 rounded">
<h2 class="font-bold mb-3">Empresa</h2>
<input id="empNome" placeholder="Nome" class="input">
<input id="empWhats" placeholder="WhatsApp" class="input">
<input id="empPix" type="number" placeholder="Desconto PIX %" class="input">
<input id="empParc" type="number" placeholder="Parcelas" class="input">
<button onclick="saveEmpresa()" class="btn-green">Salvar</button>
</div>

<!-- CATEGORIAS -->
<div id="categorias" class="tab">
<button onclick="novaCategoria()" class="mb-3 btn-black">+ Nova Categoria</button>
<div id="listaCategorias" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
</div>

<!-- PRODUTOS -->
<div id="produtos" class="tab">
<button onclick="novoProduto()" class="mb-3 btn-black">+ Novo Produto</button>
<div id="listaProdutos" class="grid grid-cols-2 md:grid-cols-5 gap-2"></div>
</div>

<!-- PROMOS -->
<div id="promos" class="tab bg-white p-4 rounded">
<h2 class="font-bold mb-3">Promo√ß√µes por Categoria</h2>
<div id="listaPromos"></div>
<button onclick="salvarPromos()" class="btn-green mt-4">Salvar Promo√ß√µes</button>
</div>

<!-- PEDIDOS -->
<div id="pedidos" class="tab bg-white p-4 rounded">
<h2 class="font-bold mb-3">Pedidos</h2>
<div id="listaPedidos"></div>
</div>

</main>

<!-- MODAL -->
<div id="modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4">
<div class="bg-white p-4 rounded max-w-md w-full max-h-[90vh] overflow-y-auto">
<h2 id="mTitle" class="font-bold mb-2"></h2>
<div id="mBody"></div>
<button onclick="salvarModal()" class="btn-green mt-4">Salvar</button>
<button onclick="fechar()" class="btn-gray mt-2">Fechar</button>
</div>
</div>

<script>
// üî• FIREBASE
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias",
  storageBucket: "catalogo-abella-joias.firebasestorage.app",
  messagingSenderId: "727568435294",
  appId: "1:727568435294:web:442c0179ecf0686dff4ccf"
});
const db = firebase.database();

let ctx = {};

// UTIL
function tab(id){
 document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
 document.getElementById(id).classList.add('active');
}
function abrir(){ modal.classList.remove('hidden'); }
function fechar(){ modal.classList.add('hidden'); }

// EMPRESA
db.ref('settings').on('value',s=>{
 const v=s.val()||{};
 empNome.value=v.nome||'';
 empWhats.value=v.whatsapp||'';
 empPix.value=v.pix||0;
 empParc.value=v.parcelas||1;
});
function saveEmpresa(){
 db.ref('settings').update({
  nome:empNome.value,
  whatsapp:empWhats.value,
  pix:+empPix.value,
  parcelas:+empParc.value
 });
 alert('Salvo');
}

// CATEGORIAS + VARIA√á√ïES
db.ref('categories').on('value',s=>{
 listaCategorias.innerHTML='';
 listaPromos.innerHTML='';
 s.forEach(c=>{
  const v=c.val();
  listaCategorias.innerHTML+=`
  <div class="card" onclick="editarCategoria('${c.key}')">
   <b>${v.name}</b>
   <div class="text-xs">${Object.keys(v.variacoes||{}).length} varia√ß√µes</div>
  </div>`;
  listaPromos.innerHTML+=`
   <div class="flex justify-between mb-2">
    <span>${v.name}</span>
    <input id="promo-${c.key}" type="number" class="border w-20 text-center">
   </div>`;
 });
});

// MODAL CATEGORIA
function editarCategoria(id){
 ctx={type:'cat',id};
 db.ref('categories/'+id).once('value').then(s=>{
  const v=s.val();
  mTitle.innerText='Editar Categoria';
  let vars='';
  Object.entries(v.variacoes||{}).forEach(([k,x])=>{
   vars+=`
   <div class="flex gap-2 mb-1">
    <input value="${x.label}" onchange="updVar('${id}','${k}','label',this.value)">
    <input type="number" value="${x.precoExtra||0}" onchange="updVar('${id}','${k}','precoExtra',this.value)">
    <input type="number" value="${x.pesoExtra||0}" onchange="updVar('${id}','${k}','pesoExtra',this.value)">
    <input type="checkbox" ${x.ativo?'checked':''} onchange="updVar('${id}','${k}','ativo',this.checked)">
   </div>`;
  });
  mBody.innerHTML=`
   <input id="catNome" value="${v.name}">
   <h3 class="font-bold mt-3">Varia√ß√µes</h3>
   ${vars}
   <button onclick="novaVar('${id}')">+ Nova Varia√ß√£o</button>`;
  abrir();
 });
}
function updVar(cat,key,field,val){
 db.ref(`categories/${cat}/variacoes/${key}/${field}`).set(val);
}
function novaVar(cat){
 const k=prompt('Chave da varia√ß√£o (ex: A, DEUS)');
 if(!k)return;
 db.ref(`categories/${cat}/variacoes/${k}`).set({label:k,ativo:true});
}

// PRODUTOS
db.ref('products').on('value',s=>{
 listaProdutos.innerHTML='';
 s.forEach(p=>{
  const v=p.val();
  listaProdutos.innerHTML+=`
   <div class="card">
    <b>${v.name}</b>
    <div class="text-xs">${v.skuBase}</div>
   </div>`;
 });
});

// PROMOS
function salvarPromos(){
 document.querySelectorAll('[id^=promo-]').forEach(i=>{
  const k=i.id.replace('promo-','');
  db.ref('promoRules/'+k).set({percent:+i.value});
 });
 alert('Promo√ß√µes salvas');
}

// PEDIDOS
db.ref('orders').on('value',s=>{
 listaPedidos.innerHTML='';
 s.forEach(o=>{
  const v=o.val();
  listaPedidos.innerHTML+=`
   <div class="border-b p-2 text-xs">
    ${v.sku} - R$ ${v.preco}
   </div>`;
 });
});
</script>

<style>
.input{width:100%;padding:10px;border:1px solid #ccc;margin-bottom:5px}
.btn-green{background:#16a34a;color:white;padding:10px;width:100%;border-radius:6px}
.btn-black{background:black;color:white;padding:8px 12px;border-radius:6px}
.btn-gray{background:#ddd;padding:8px;width:100%;border-radius:6px}
</style>

</body>
</html>
