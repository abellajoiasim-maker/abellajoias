<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Admin • Abella Joias Atacado</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body{background:#0b0b0b;color:#eee;font-family:Inter,Arial;padding-bottom:60px}
        nav button.active{border-color:#caa85c;color:#caa85c;opacity:1}
        nav button{opacity:0.6;transition:0.3s}
        section{display:none}
        section.active{display:block}
        .card{background:#141414;border:1px solid #2a2a2a;border-radius:12px;padding:12px;position:relative}
        .grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
        @media(min-width:768px){.grid{grid-template-columns:repeat(4,1fr)}}
        input, select, textarea{background:#1a1a1a;border:1px solid #333;color:#fff;padding:8px;border-radius:6px;width:100%;font-size:14px;outline:none}
        input:focus{border-color:#caa85c}
        .btn{background:#caa85c;color:#000;font-weight:bold;padding:8px;border-radius:6px;cursor:pointer;text-align:center;display:inline-block;font-size:10px;text-transform:uppercase}
        .btn-red{background:#ef4444;color:#fff}
        .badge-promo{position:absolute;top:5px;right:5px;background:#22c55e;color:#fff;font-size:9px;padding:2px 5px;border-radius:4px;font-weight:bold;z-index:10}
    </style>
</head>
<body>

<nav class="flex justify-around bg-[#0b0b0b] p-4 border-b border-[#222] sticky top-0 z-50">
    <button onclick="showTab('tab-pedidos',this)" class="active font-bold text-[10px] uppercase">Pedidos</button>
    <button onclick="showTab('tab-produtos',this)" class="font-bold text-[10px] uppercase">Produtos</button>
    <button onclick="showTab('tab-categorias',this)" class="font-bold text-[10px] uppercase">Categorias</button>
    <button onclick="abrirModalConfig()" class="font-bold text-[10px] uppercase text-[#caa85c]">Config</button>
    <button onclick="abrirModalPromocao()" class="font-bold text-[10px] uppercase text-green-500">Promo</button>
</nav>

<main class="p-4 max-w-7xl mx-auto">
    <section id="tab-pedidos" class="active"><div id="listaPedidos" class="space-y-3"></div></section>
    
    <section id="tab-produtos">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-[#caa85c] font-bold text-xs uppercase">Produtos no Bruto</h2>
            <button class="btn" onclick="abrirModalProduto()">+ Novo Produto</button>
        </div>
        <div id="produtosPorCategoria"></div>
    </section>

    <section id="tab-categorias">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-[#caa85c] font-bold text-xs uppercase">Categorias</h2>
            <button class="btn" onclick="abrirModalCategoria()">+ Nova Categoria</button>
        </div>
        <div id="listaCategorias" class="grid"></div>
    </section>
</main>

<div id="modal" class="fixed inset-0 bg-black/90 z-[60] hidden items-center justify-center p-4">
    <div class="bg-[#111] w-full max-w-md rounded-xl border border-[#333] overflow-hidden">
        <div class="p-4 border-b border-[#222] flex justify-between items-center">
            <h2 id="modalTitle" class="text-[#caa85c] font-bold uppercase text-[10px]"></h2>
            <button onclick="fecharModal()" class="text-gray-500">✕</button>
        </div>
        <div id="modalBody" class="p-5 max-h-[70vh] overflow-y-auto text-sm"></div>
        <div class="p-4 bg-[#0b0b0b] flex justify-end gap-3">
            <button onclick="fecharModal()" class="text-[10px] uppercase opacity-50">Sair</button>
            <button id="btnSalvar" class="btn px-6">Salvar Dados</button>
        </div>
    </div>
</div>

<script>
    firebase.initializeApp({
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        authDomain: "catalogo-abella-joias.firebaseapp.com",
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
        projectId: "catalogo-abella-joias"
    });
    const db = firebase.database();

    /* MOTOR DO MODAL (Correção do Erro de Não Abrir) */
    function abrirModal(t, b, cb) {
        document.getElementById('modal').classList.replace('hidden', 'flex');
        document.getElementById('modalTitle').innerText = t;
        document.getElementById('modalBody').innerHTML = b;
        const btnS = document.getElementById('btnSalvar');
        if (cb) {
            btnS.style.display = 'block';
            btnS.onclick = () => { cb(); fecharModal(); };
        } else {
            btnS.style.display = 'none';
        }
    }
    function fecharModal() { document.getElementById('modal').classList.replace('flex', 'hidden'); }

    function showTab(id, btn) {
        document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    /* CONFIGURAÇÃO DA EMPRESA */
    function abrirModalConfig() {
        db.ref('settings/empresa').once('value', s => {
            const v = s.val() || {};
            const html = `
                <div class="space-y-4">
                    <div><label class="text-[10px] font-bold text-[#caa85c]">NOME DA LOJA</label><input id="cNome" value="${v.nome||''}"></div>
                    <div><label class="text-[10px] font-bold text-[#caa85c]">WHATSAPP</label><input id="cFone" value="${v.fone||''}"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-[10px] font-bold text-[#caa85c]">DESC. PIX %</label><input type="number" id="cPix" value="${v.descontoPix||0}"></div>
                        <div><label class="text-[10px] font-bold text-[#caa85c]">MÍN. PEDIDO R$</label><input type="number" id="cMin" value="${v.minPedido||0}"></div>
                    </div>
                </div>`;
            abrirModal('Configuração', html, () => {
                db.ref('settings/empresa').update({
                    nome: document.getElementById('cNome').value,
                    fone: document.getElementById('cFone').value,
                    descontoPix: parseInt(document.getElementById('cPix').value),
                    minPedido: parseFloat(document.getElementById('cMin').value)
                });
            });
        });
    }

    /* PROMOÇÃO (Lógica Unificada do Atacado) */
    function abrirModalPromocao() {
        db.ref().once('value', snap => {
            const data = snap.val();
            const promo = data.settings?.promocao || { ativa: false, porcentagem: 0 };
            const cats = data.categories || {};
            let lista = "";
            Object.entries(cats).forEach(([id, c]) => {
                lista += `<div class="flex justify-between items-center p-2 bg-white/5 rounded mb-1">
                    <span class="text-[10px] font-bold uppercase">${c.name}</span>
                    <input type="number" id="promo-${id}" value="${c.discount||0}" class="w-16 text-center text-xs">
                </div>`;
            });
            const html = `
                <div class="space-y-4">
                    <button onclick="togglePromoStatus()" class="w-full py-2 rounded font-bold text-[10px] ${promo.ativa?'bg-green-600':'bg-red-600'}">
                        PROMOÇÃO ${promo.ativa?'ATIVA':'INATIVA'} (CLIQUE P/ MUDAR)
                    </button>
                    <div><label class="text-[10px] font-bold text-[#caa85c]">DESC. GERAL %</label><input type="number" id="pGeral" value="${promo.porcentagem||0}"></div>
                    <div class="max-h-40 overflow-y-auto border-t border-[#222] pt-2">${lista}</div>
                </div>`;
            abrirModal('Promoções por Categoria', html, () => {
                const up = {};
                up['settings/promocao/porcentagem'] = parseInt(document.getElementById('pGeral').value);
                document.querySelectorAll('[id^="promo-"]').forEach(i => {
                    up['categories/'+i.id.replace('promo-','')+'/discount'] = parseInt(i.value);
                });
                db.ref().update(up).then(()=>alert("Promoções Sincronizadas!"));
            });
        });
    }
    function togglePromoStatus() {
        db.ref('settings/promocao/ativa').once('value', s => {
            db.ref('settings/promocao/ativa').set(!s.val()).then(() => abrirModalPromocao());
        });
    }

    /* GESTÃO DE PRODUTOS */
    db.ref('products').on('value', snap => {
        const container = document.getElementById('produtosPorCategoria');
        container.innerHTML = '';
        const data = snap.val() || {};
        const cats = {};
        Object.entries(data).forEach(([id, p]) => {
            if(!cats[p.category]) cats[p.category] = [];
            p.id = id; cats[p.category].push(p);
        });
        Object.keys(cats).forEach(cat => {
            container.innerHTML += `<h3 class="text-[#caa85c] text-[10px] font-bold mt-6 mb-2 uppercase border-l-2 border-[#caa85c] pl-2">${cat}</h3><div class="grid" id="grid-${cat.replace(/\s/g,'')}"></div>`;
            cats[cat].forEach(p => {
                document.getElementById(`grid-${cat.replace(/\s/g,'')}`).innerHTML += `
                    <div class="card">
                        ${p.discount > 0 ? `<div class="badge-promo">-${p.discount}%</div>` : ''}
                        <img src="${p.image}" class="w-full h-24 object-contain mb-2">
                        <div class="text-[9px] opacity-50 font-mono">${p.sku || 'S/SKU'} | ${p.weight || '0'}g</div>
                        <div class="text-[10px] font-bold truncate">${p.name}</div>
                        <div class="text-[11px] text-[#caa85c] font-bold">R$ ${parseFloat(p.price).toFixed(2)}</div>
                        <div class="flex gap-1 mt-2">
                            <button class="btn flex-1" onclick="editarProduto('${p.id}')">Editar</button>
                            <button class="btn btn-red px-2" onclick="excluir('products','${p.id}')">✕</button>
                        </div>
                    </div>`;
            });
        });
    });

    function editarProduto(id) {
        db.ref('products/'+id).once('value', s => {
            const p = s.val();
            const html = `
                <div class="space-y-3">
                    <input id="eName" value="${p.name}" placeholder="Nome">
                    <div class="grid grid-cols-2 gap-2">
                        <input id="ePrice" type="number" step="0.01" value="${p.price}" placeholder="Preço">
                        <input id="eWeight" value="${p.weight||''}" placeholder="Peso (g)">
                    </div>
                    <input id="eSku" value="${p.sku||''}" placeholder="SKU/Ref">
                    <input id="eImg" value="${p.image}" placeholder="URL Imagem">
                </div>`;
            abrirModal('Editar Produto', html, () => {
                db.ref('products/'+id).update({
                    name: document.getElementById('eName').value,
                    price: parseFloat(document.getElementById('ePrice').value),
                    weight: document.getElementById('eWeight').value,
                    sku: document.getElementById('eSku').value,
                    image: document.getElementById('eImg').value
                });
            });
        });
    }

    function abrirModalProduto() {
        db.ref('categories').once('value', snap => {
            let opt = "";
            snap.forEach(c => { opt += `<option value="${c.val().name}">${c.val().name}</option>`; });
            const html = `
                <div class="space-y-3">
                    <input id="nName" placeholder="Nome do Produto">
                    <div class="grid grid-cols-2 gap-2">
                        <input id="nPrice" type="number" step="0.01" placeholder="Preço Bruto">
                        <input id="nWeight" placeholder="Peso (ex: 2.5g)">
                    </div>
                    <input id="nSku" placeholder="Referência/SKU">
                    <select id="nCat">${opt}</select>
                    <input id="nImg" placeholder="Link da Imagem">
                </div>`;
            abrirModal('Novo Produto', html, () => {
                db.ref('products').push({
                    name: document.getElementById('nName').value,
                    price: parseFloat(document.getElementById('nPrice').value),
                    weight: document.getElementById('nWeight').value,
                    sku: document.getElementById('nSku').value,
                    category: document.getElementById('nCat').value,
                    image: document.getElementById('nImg').value,
                    discount: 0
                });
            });
        });
    }

    /* GESTÃO DE PEDIDOS */
    db.ref('orders').on('value', snap => {
        const lista = document.getElementById('listaPedidos');
        lista.innerHTML = '<h2 class="text-[#caa85c] font-bold uppercase text-xs mb-4">Fila de Pedidos</h2>';
        snap.forEach(o => {
            const p = o.val();
            if(p.arquivado) return;
            lista.innerHTML += `
                <div class="card flex justify-between items-center border-l-4 border-l-[#caa85c]">
                    <div>
                        <div class="text-[10px] font-bold text-[#caa85c]">PEDIDO #${o.key.substring(0,6).toUpperCase()}</div>
                        <div class="text-xs font-bold">${p.cliente}</div>
                        <div class="text-[10px] opacity-50">${p.data || ''}</div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-gold-outline px-4" onclick="verPedido('${o.key}')">DETALHES</button>
                        <button class="btn btn-red px-2" onclick="cancelarPedido('${o.key}')">✕</button>
                    </div>
                </div>`;
        });
    });

    function verPedido(id) {
        db.ref('orders/'+id).once('value', s => {
            const p = s.val();
            let itens = '';
            Object.values(p.itens||{}).forEach(i => {
                itens += `<div class="flex justify-between text-[11px] py-1 border-b border-white/5">
                    <span>${i.qtd}x ${i.nome}</span>
                    <span>R$ ${(i.preco*i.qtd).toFixed(2)}</span>
                </div>`;
            });
            const html = `
                <div class="space-y-4">
                    <div class="bg-white/5 p-3 rounded text-xs">
                        <p><b>Cliente:</b> ${p.cliente}</p>
                        <p><b>Whats:</b> ${p.whatsapp||'--'}</p>
                        <p><b>Pagamento:</b> ${p.pagamento||'--'}</p>
                    </div>
                    <div class="py-2">${itens}</div>
                    <div class="text-right font-bold text-[#caa85c] text-lg">TOTAL: R$ ${parseFloat(p.total).toFixed(2)}</div>
                </div>`;
            abrirModal('Detalhes do Pedido', html, null);
        });
    }

    /* CATEGORIAS */
    function abrirModalCategoria() {
        abrirModal('Nova Categoria', '<input id="newCatName" placeholder="Nome da Categoria">', () => {
            const name = document.getElementById('newCatName').value;
            if(name) db.ref('categories').push({ name: name, discount: 0 });
        });
    }

    db.ref('categories').on('value', snap => {
        const g = document.getElementById('listaCategorias');
        g.innerHTML = '';
        snap.forEach(c => {
            g.innerHTML += `<div class="card flex justify-between items-center"><span class="text-xs font-bold uppercase">${c.val().name}</span><button class="text-red-500 text-xs" onclick="excluir('categories','${c.key}')">✕</button></div>`;
        });
    });

    function excluir(path, id) { if(confirm("Confirmar exclusão?")) db.ref(path+'/'+id).remove(); }
    function cancelarPedido(id) { if(confirm("Arquivar pedido?")) db.ref('orders/'+id).update({arquivado:true}); }

</script>
</body>
</html>
