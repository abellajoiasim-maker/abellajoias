<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Admin • Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:Inter,Arial;background:#0b0b0b;color:#eee}
header{padding:20px;text-align:center;font-size:22px;font-weight:700;background:#000;border-bottom:1px solid #222}
nav{display:flex;gap:10px;padding:10px;background:#111;flex-wrap:wrap}
nav button{flex:1;background:#1a1a1a;border:1px solid #333;color:#fff;padding:10px;border-radius:10px;cursor:pointer}
nav button.active{border-color:#caa85c;color:#caa85c}
section{display:none;padding:20px}
section.active{display:block}

/* Grid ajustada para 6 colunas */
.grid{display:grid;grid-template-columns:repeat(2, 1fr);gap:12px}
@media(min-width: 768px) { .grid { grid-template-columns: repeat(4, 1fr); } }
@media(min-width: 1200px) { .grid { grid-template-columns: repeat(6, 1fr); } }

.card{background:#141414;border:1px solid #2a2a2a;border-radius:14px;padding:12px;position:relative}
.card.paused{opacity: 0.4; grayscale: 1;}
.row{display:flex;justify-content:space-between;align-items:center;gap:6px}
.tag{font-size:11px;padding:3px 8px;border-radius:999px}
.ok{background:#1f3;color:#000}
.no{background:#c33}
.btn{background:#222;border:1px solid #444;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px}
.btn.pause-active{border-color:#caa85c;color:#caa85c;background:#caa85c22}
.btn.danger{border-color:#c33;color:#f77}
input, select{background:#111;border:1px solid #333;color:#fff;padding:8px;border-radius:6px;width:100%;margin-bottom:8px}

#modalEdit { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; align-items:center; justify-content:center; padding:15px; }
.modal-content { background:#141414; border:1px solid #333; width:100%; max-width:550px; border-radius:20px; padding:20px; max-height:95vh; overflow-y:auto; }
.modal-img { width:100%; height:180px; object-fit:contain; background:#000; border-radius:10px; margin-bottom:15px; border:1px solid #222; }

.cat-divider { margin-top: 30px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #222; color: #caa85c; font-weight: bold; text-transform: uppercase; font-size: 13px; }
.var-chip { display: inline-flex; align-items: center; background: #222; border: 1px solid #444; padding: 2px 8px; border-radius: 5px; margin: 2px; font-size: 11px; }
</style>
</head>

<body>

<header>Painel Administrativo • Abella Joias</header>

<nav>
  <button class="active" onclick="show('empresa')">Empresa</button>
  <button onclick="show('categorias')">Categorias</button>
  <button onclick="show('produtos')">Produtos</button>
  <button onclick="show('promocoes')">Promoções</button>
  <button onclick="show('pedidos')">Pedidos</button>
</nav>

<section id="empresa" class="active">
  <h2 class="mb-3 font-bold">Empresa</h2>
  <div class="card max-w-md">
    <input id="empNome" placeholder="Nome">
    <input id="empWhats" placeholder="WhatsApp" class="mt-2">
    <input id="empPix" type="number" placeholder="Desconto PIX %" class="mt-2">
    <input id="empParc" type="number" placeholder="Parcelas" class="mt-2">
    <button class="btn mt-3" onclick="salvarEmpresa()">Salvar</button>
  </div>
</section>

<section id="categorias">
  <h2 class="mb-3 font-bold">Categorias</h2>
  <div class="grid" id="listaCategorias"></div>
</section>

<section id="produtos">
  <h2 class="mb-3 font-bold">Produtos</h2>
  <div id="produtosPorCategoria"></div>
</section>

<section id="promocoes">
  <h2 class="mb-3 font-bold">Promoções</h2>
  <div class="card max-w-2xl">
      <p class="text-xs opacity-60 mb-4 uppercase font-bold">Definir Descontos por Categoria</p>
      <div id="gridPromoCategorias" class="space-y-2"></div>
      <button class="btn w-full mt-4 !bg-[#caa85c] !text-black font-bold" onclick="salvarPromos()">APLICAR DESCONTOS</button>
  </div>
</section>

<section id="pedidos">
  <h2 class="mb-3 font-bold">Pedidos</h2>
  <div id="listaPedidos"></div>
</section>

<div id="modalEdit">
    <div class="modal-content">
        <div class="row mb-4">
            <h3 id="modalTitle" class="font-bold">Editar</h3>
            <button class="btn" onclick="closeModal()">✕</button>
        </div>
        <div id="modalBody"></div>
        <div id="areaVariacoes" class="mt-4 p-3 bg-[#000] rounded-lg border border-[#222]"></div>
        <button class="btn w-full py-3 mt-4 !bg-[#caa85c] !text-black font-bold" id="btnSalvarModal">SALVAR ALTERAÇÕES</button>
    </div>
</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com",
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let listaVariacoesLocal = [];

function show(id){
 document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
 document.getElementById(id).classList.add('active');
 document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
 if(event) event.target.classList.add('active');
}

function closeModal() { document.getElementById('modalEdit').style.display = 'none'; }

// CARREGAR DADOS
db.ref('settings').on('value',s=>{
 const v=s.val()||{};
 empNome.value=v.nome||''; empWhats.value=v.whatsapp||'';
 empPix.value=v.pix||0; empParc.value=v.parcelas||1;
});

function salvarEmpresa(){
 db.ref('settings').update({ nome:empNome.value, whatsapp:empWhats.value, pix:+empPix.value, parcelas:+empParc.value });
 alert('Configurações Salvas');
}

// CATEGORIAS
db.ref('categories').on('value',snap=>{
 listaCategorias.innerHTML='';
 const promoGrid = document.getElementById('gridPromoCategorias');
 promoGrid.innerHTML = '';

 snap.forEach(c=>{
  const d=c.val();
  listaCategorias.innerHTML+=`
   <div class="card ${d.paused?'paused':''}">
    <div class="row"><strong>${d.name}</strong><span class="tag ${d.image?'ok':'no'}">IMG</span></div>
    <div class="row mt-3">
     <button class="btn" onclick="abrirEdicao('categories', '${c.key}')">Editar</button>
     <button class="btn ${d.paused?'pause-active':''}" onclick="togglePause('categories', '${c.key}', ${d.paused})">Pausar</button>
    </div>
   </div>`;
   
   promoGrid.innerHTML += `
    <div class="row bg-[#1a1a1a] p-2 rounded">
        <span class="text-xs uppercase font-bold">${d.name}</span>
        <div class="flex items-center gap-2">
            <input type="number" id="promo-${c.key}" class="!w-20 !mb-0 text-center" placeholder="0" value="${d.discount || 0}">
            <span class="text-[#caa85c] font-bold">%</span>
        </div>
    </div>`;
 });
});

// PRODUTOS EM GRID DE 6 SEPARADOS POR CAT
db.ref('products').on('value',snap=>{
 const map={};
 snap.forEach(p=>{
  const v=p.val(); v.id = p.key;
  if(!map[v.category]) map[v.category]=[];
  map[v.category].push(v);
 });
 
 produtosPorCategoria.innerHTML='';
 Object.keys(map).sort().forEach(cat=>{
  const container = document.createElement('div');
  container.innerHTML = `<div class="cat-divider">${cat}</div>`;
  const grid = document.createElement('div');
  grid.className = 'grid';
  
  map[cat].sort((a,b)=>(a.sku||'').localeCompare(b.sku||'', undefined, {numeric: true})).forEach(p=>{
   grid.innerHTML+=`
    <div class="card ${p.paused?'paused':''}">
     <div class="row"><strong>${p.sku || 'S/SKU'}</strong><span class="tag ${p.image?'ok':'no'}">IMG</span></div>
     <div class="text-sm truncate mt-1">${p.name}</div>
     <div class="text-[10px] opacity-50">R$ ${p.price||'0'} | ${p.weight||'0'}g</div>
     <div class="row mt-2">
      <button class="btn" onclick="abrirEdicao('products', '${p.id}')">Editar</button>
      <button class="btn ${p.paused?'pause-active':''}" onclick="togglePause('products', '${p.id}', ${p.paused})">Pausar</button>
      <button class="btn danger" onclick="if(confirm('Excluir?')) db.ref('products/${p.id}').remove()">✕</button>
     </div>
    </div>`;
  });
  container.appendChild(grid);
  produtosPorCategoria.appendChild(container);
 });
});

// MODAL DE EDIÇÃO COM VARIAÇÕES
async function abrirEdicao(path, id) {
    const snap = await db.ref(path + '/' + id).once('value');
    const v = snap.val();
    const body = document.getElementById('modalBody');
    const areaVar = document.getElementById('areaVariacoes');
    
    document.getElementById('modalTitle').innerText = path === 'products' ? 'Editar Produto' : 'Editar Categoria';
    listaVariacoesLocal = v.variations || [];

    let html = `<img src="${v.image || ''}" class="modal-img" onerror="this.src='https://placehold.co/400?text=Sem+Foto'">`;
    
    if(path === 'products') {
        html += `
            <label class="text-[10px] opacity-50 uppercase font-bold">Nome</label><input id="editNome" value="${v.name||''}">
            <div class="grid grid-cols-2 gap-2">
                <div><label class="text-[10px] opacity-50 font-bold uppercase">SKU</label><input id="editSku" value="${v.sku||''}"></div>
                <div><label class="text-[10px] opacity-50 font-bold uppercase">Peso (g)</label><input id="editPeso" value="${v.weight||''}"></div>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div><label class="text-[10px] opacity-50 font-bold uppercase">Preço (R$)</label><input id="editPreco" value="${v.price||''}"></div>
                <div><label class="text-[10px] opacity-50 font-bold uppercase">Categoria</label><input id="editCat" value="${v.category||''}"></div>
            </div>
            <label class="text-[10px] opacity-50 font-bold uppercase">URL Imagem</label><input id="editImg" value="${v.image||''}">`;
        
        // Gerar interface de variações baseada na categoria
        renderVariacoes(v.category, v.variations);
    } else {
        html += `<label class="text-[10px] opacity-50 font-bold uppercase">Nome Categoria</label><input id="editNome" value="${v.name||''}">
                 <label class="text-[10px] opacity-50 font-bold uppercase">URL Capa</label><input id="editImg" value="${v.image||''}">`;
        areaVar.innerHTML = '';
    }

    body.innerHTML = html;
    document.getElementById('modalEdit').style.display = 'flex';

    document.getElementById('btnSalvarModal').onclick = async () => {
        const up = { name: editNome.value, image: editImg.value };
        if(path === 'products') {
            up.sku = editSku.value; up.weight = editPeso.value;
            up.price = editPreco.value; up.category = editCat.value;
            up.variations = listaVariacoesLocal;
        }
        await db.ref(path + '/' + id).update(up);
        closeModal();
    };
}

function renderVariacoes(cat, vars = []) {
    const area = document.getElementById('areaVariacoes');
    const slug = cat.toLowerCase();
    
    if(slug.includes('pingente') || slug.includes('inicial')) {
        const letras = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        if(vars.length === 0) listaVariacoesLocal = letras.map(l => ({ label: l, active: true }));
        area.innerHTML = `<p class="text-[10px] text-[#caa85c] mb-2 uppercase font-bold">Grade de Letras</p><div class="grid grid-cols-8 gap-1">` + 
            listaVariacoesLocal.map((item, i) => `
                <div class="flex flex-col items-center bg-[#111] p-1 rounded border border-[#333]">
                    <span class="text-[9px] font-bold">${item.label}</span>
                    <input type="checkbox" onchange="listaVariacoesLocal[${i}].active=this.checked" ${item.active?'checked':''} class="!mb-0 !w-3">
                </div>`).join('') + `</div>`;
    } else if(slug.includes('bracelete') || slug.includes('anel')) {
        area.innerHTML = `<p class="text-[10px] text-[#caa85c] mb-2 uppercase font-bold">Personalização (Frases/Tamanhos)</p>
            <div id="listaFrases" class="space-y-1">` + 
            listaVariacoesLocal.map((item, i) => `
                <div class="flex gap-1 items-center bg-[#111] p-1 rounded">
                    <input value="${item.label}" onchange="listaVariacoesLocal[${i}].label=this.value" class="!mb-0 text-xs flex-1">
                    <button onclick="listaVariacoesLocal.splice(${i},1);renderVariacoes('${cat}', listaVariacoesLocal)" class="text-red-500 px-2">✕</button>
                </div>`).join('') + `</div>
            <button onclick="listaVariacoesLocal.push({label:'NOVA',active:true});renderVariacoes('${cat}', listaVariacoesLocal)" class="w-full text-[10px] mt-2 border border-[#caa85c] text-[#caa85c] p-1 rounded">+ ADICIONAR ITEM</button>`;
    } else {
        area.innerHTML = `<p class="text-[10px] opacity-40 text-center uppercase">Sem variações para esta categoria</p>`;
    }
}

function togglePause(path, id, current) {
    db.ref(path + '/' + id).update({ paused: !current });
}

function salvarPromos() {
    const updates = {};
    document.querySelectorAll('[id^="promo-"]').forEach(input => {
        const catKey = input.id.replace('promo-', '');
        db.ref('categories/' + catKey).update({ discount: +input.value });
    });
    alert("Promoções Atualizadas!");
}

// PEDIDOS
db.ref('orders').on('value',s=>{
 listaPedidos.innerHTML='';
 s.forEach(o=>{
  const v=o.val();
  listaPedidos.innerHTML+=`<div class="card mb-2 text-xs">
    <div class="row"><span class="font-bold text-[#caa85c]">Pedido #${o.key.slice(-4)}</span><span>${v.date||''}</span></div>
    <div class="mt-2">${v.items?.map(i => `• ${i.name} (${i.variation || 'Padrao'})`).join('<br>')}</div>
  </div>`;
 });
});
</script>

</body>
</html>
