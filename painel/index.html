<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Administrativo ‚Ä¢ Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        body{background:#0b0b0b;color:#eee;font-family:Inter,Arial;margin:0}
        nav button.active{border-bottom:2px solid #caa85c;color:#caa85c}
        section{display:none;min-height:300px}
        section.active{display:block}
        .card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
        .btn{background:#222;border:1px solid #444;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer}
        .btn-gold{background:#caa85c;color:#000;font-weight:700;padding:10px;border-radius:8px}
        input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff;outline:none}
        #mainModal.active { display: flex; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #caa85c; border-radius: 10px; }
        
        /* Estilos de Impress√£o */
        #print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; display: block; background: #fff; color: #000; }
        }
    </style>
</head>
<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222] text-[#caa85c] tracking-widest uppercase">
    Abella Joias ‚Ä¢ Painel de Controle
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
    <button type="button" class="btn active" onclick="showTab('empresa', this)">Empresa</button>
    <button type="button" class="btn" onclick="showTab('categorias', this)">Categorias</button>
    <button type="button" class="btn" onclick="showTab('produtos', this)">Produtos</button>
    <button type="button" class="btn" onclick="showTab('promocoes', this)">Promo√ß√µes</button>
    <button type="button" class="btn" onclick="showTab('pedidos', this)">Pedidos</button>
</nav>

<main class="p-6 max-w-4xl mx-auto">
    <section id="empresa" class="active">
        <div class="card space-y-3">
            <h2 class="text-[#caa85c] font-bold uppercase text-sm">Configura√ß√£o da Loja</h2>
            <input id="empNome" placeholder="Nome da Empresa">
            <input id="empSub" placeholder="Slogan / Subt√≠tulo">
            <input id="empWhats" placeholder="WhatsApp da Loja">
            <div class="grid grid-cols-2 gap-2">
                <input id="empDesc" type="number" placeholder="Desc. PIX %">
                <input id="empParc" type="number" placeholder="Parcelas M√°x">
            </div>
            <button class="btn-gold w-full" onclick="salvarEmpresa()">GUARDAR ALTERA√á√ïES</button>
        </div>
    </section>

    <section id="categorias">
        <div class="card mb-4">
            <input id="newCatName" placeholder="Nome da Nova Categoria">
            <button class="btn-gold w-full" onclick="novaCategoria()">+ CADASTRAR CATEGORIA</button>
        </div>
        <div id="listaCategorias" class="grid gap-2"></div>
    </section>

    <section id="produtos">
        <div id="listaProdutos" class="grid gap-2"></div>
    </section>

    <section id="promocoes">
        <div class="card mb-4 text-center">
            <h2 class="text-[#caa85c] uppercase text-sm mb-4 tracking-widest">Configura√ß√µes de Promo√ß√£o</h2>
            <button class="btn-gold w-full py-4 uppercase" onclick="abrirPainelPromocoes()">üé® Configurar Etiquetas e Descontos</button>
        </div>
        <div id="listaPromocoes" class="grid gap-2"></div>
    </section>

    <section id="pedidos">
        <div id="listaPedidos" class="grid gap-4"></div>
    </section>
</main>

<div id="editorPedido" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
    <div class="bg-[#111] w-full max-w-4xl rounded-2xl p-5 overflow-auto max-h-[90vh] border border-[#333]">
        <h2 class="text-[#caa85c] font-bold text-lg mb-3 uppercase">Editar Pedido (Atacado)</h2>

        <div class="grid md:grid-cols-2 gap-4">
            <div>
                <h3 class="font-bold mb-2 text-xs text-gray-400">CLIENTE</h3>
                <input id="edClienteNome" placeholder="Nome">
                <input id="edClienteTel" placeholder="WhatsApp">
            </div>
            <div>
                <h3 class="font-bold mb-2 text-xs text-gray-400">ENTREGA</h3>
                <input id="edEntregaNome" placeholder="Local">
                <input id="edRua" placeholder="Rua">
                <div class="grid grid-cols-2 gap-2">
                    <input id="edNum" placeholder="N¬∫">
                    <input id="edBairro" placeholder="Bairro">
                </div>
                <input id="edCidade" placeholder="Cidade">
            </div>
        </div>

        <h3 class="font-bold mt-4 mb-2 text-xs text-[#caa85c]">ITENS DO PEDIDO</h3>
        <div id="edItens" class="space-y-2"></div>
        <button class="btn w-full mt-2 border-dashed border-gray-600" onclick="adicionarItemEditor()">+ Adicionar Item</button>

        <div class="grid grid-cols-3 gap-3 mt-4">
            <div>
                <label class="text-[10px] text-gray-400">DESC. PROMO (R$)</label>
                <input id="edDescPromo" type="number" step="0.01" placeholder="0.00">
            </div>
            <div>
                <label class="text-[10px] text-gray-400">DESC. PIX (R$)</label>
                <input id="edDescPix" type="number" step="0.01" placeholder="0.00">
            </div>
            <div>
                <label class="text-[10px] text-gray-400">VALOR FRETE (R$)</label>
                <input id="edValorFrete" type="number" step="0.01" placeholder="0.00">
            </div>
        </div>

        <div class="flex flex-wrap gap-2 justify-between mt-6 pt-4 border-t border-[#222]">
            <button class="btn px-6" onclick="fecharEditorPedido()">CANCELAR</button>
            <div class="flex gap-2">
                <button class="btn bg-blue-900 border-blue-700" onclick="gerarRomaneio(pedidoEditando, 1)">ROMANEIO 1</button>
                <button class="btn bg-blue-900 border-blue-700" onclick="gerarRomaneio(pedidoEditando, 2)">ROMANEIO 2</button>
                <button class="btn bg-blue-900 border-blue-700" onclick="gerarRomaneio(pedidoEditando, 3)">FOTOS</button>
                <button class="btn-gold px-10" onclick="salvarPedidoEditado()">SALVAR</button>
            </div>
        </div>
    </div>
</div>

<div id="mainModal" class="fixed inset-0 bg-black/90 z-[100] hidden items-center justify-center p-4">
    <div class="bg-[#141414] border border-[#2a2a2a] w-full max-w-lg rounded-2xl overflow-hidden shadow-2xl">
        <div class="p-4 border-b border-[#222] flex justify-between items-center">
            <h3 id="modalTitle" class="text-[#caa85c] uppercase text-sm font-bold">T√≠tulo</h3>
            <button onclick="fecharModal()" class="text-gray-500 hover:text-white">&times;</button>
        </div>
        <div id="modalBody" class="p-6 max-h-[70vh] overflow-y-auto"></div>
        <div class="p-4 border-t border-[#222] flex gap-3">
            <button onclick="fecharModal()" class="flex-1 py-3 text-xs uppercase font-bold text-gray-500">Cancelar</button>
            <button id="modalSaveBtn" class="flex-1 btn-gold py-3 text-xs uppercase font-bold">Guardar Altera√ß√µes</button>
        </div>
    </div>
</div>

<div id="print-area"></div>

<script>
/* CONFIGURA√á√ÉO FIREBASE */
if (!firebase.apps.length) {
    firebase.initializeApp({
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
    });
}
const db = firebase.database();
const fMoeda = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

/* NAVEGA√á√ÉO */
function showTab(id, btn) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (btn) btn.classList.add('active');

    if (id === 'categorias') carregarCategorias();
    if (id === 'produtos') carregarProdutos();
    if (id === 'pedidos') carregarPedidos();
    if (id === 'empresa') carregarEmpresaSeExistir();
}

/* FUN√á√ïES DE PEDIDOS */
let pedidoEditando = null;

function carregarPedidos() {
    db.ref('orders').on('value', s => {
        const lista = document.getElementById('listaPedidos');
        lista.innerHTML = '';
        s.forEach(ped => {
            const p = ped.val();
            lista.innerHTML += `
                <div class="card border-l-4 border-[#caa85c]">
                    <div class="flex justify-between items-center">
                        <div>
                            <b class="text-[#caa85c] uppercase">${p.cliente?.nome || p.cliente || 'Sem Nome'}</b><br>
                            <small>${p.data || ''}</small>
                        </div>
                        <button class="btn-gold text-[10px]" onclick="abrirEditorPedido('${ped.key}')">EDITAR / ROMANEIO</button>
                    </div>
                    <div class="mt-2 text-right">
                        <button onclick="excluirPedido('${ped.key}')" class="text-red-500 text-[10px] uppercase font-bold">üóë Excluir</button>
                    </div>
                </div>`;
        });
    });
}

function excluirPedido(id) {
    if (confirm("Excluir este pedido permanentemente?")) db.ref('orders/' + id).remove();
}

function abrirEditorPedido(id) {
    db.ref('orders/' + id).once('value', s => {
        const p = s.val(); if (!p) return;
        pedidoEditando = id;
        document.getElementById('edClienteNome').value = p.cliente?.nome || '';
        document.getElementById('edClienteTel').value = p.cliente?.telefone || '';
        document.getElementById('edRua').value = p.entrega?.rua || '';
        document.getElementById('edNum').value = p.entrega?.num || '';
        document.getElementById('edBairro').value = p.entrega?.bairro || '';
        document.getElementById('edCidade').value = p.entrega?.cidade || '';
        
        // Carregar Valores Financeiros
        document.getElementById('edDescPromo').value = p.descontoPromo || 0;
        document.getElementById('edDescPix').value = p.descontoPix || 0;
        document.getElementById('edValorFrete').value = p.entrega?.valorFrete || p.valorFrete || 0;

        document.getElementById('edItens').innerHTML = '';
        const itens = Array.isArray(p.itens) ? p.itens : Object.values(p.itens || {});
        itens.forEach(i => addItemEditor(i));
        document.getElementById('editorPedido').classList.remove('hidden');
    });
}

function addItemEditor(i = {}) {
    const div = document.createElement('div');
    div.className = "card bg-black/40 border-[#222]";
    div.innerHTML = `
        <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
            <input placeholder="SKU" value="${i.sku || ''}">
            <input placeholder="Nome" value="${i.name || ''}">
            <input type="number" placeholder="Peso" value="${i.peso || i.weight || 0}">
            <input type="number" placeholder="Pre√ßo" value="${i.price || i.precoFinal || 0}">
            <input type="number" placeholder="Qtd" value="${i.quantidade || i.qtd || 1}">
        </div>
        <button class="text-red-500 text-[10px] uppercase font-bold mt-1" onclick="this.parentElement.remove()">Remover</button>`;
    document.getElementById('edItens').appendChild(div);
}

function adicionarItemEditor() { addItemEditor(); }
function fecharEditorPedido() { document.getElementById('editorPedido').classList.add('hidden'); }

function salvarPedidoEditado() {
    const itens = []; 
    let subtotal = 0, pesoTotal = 0;

    document.querySelectorAll('#edItens .card').forEach(c => {
        const ins = c.querySelectorAll('input');
        const i = {
            sku: ins[0].value,
            name: ins[1].value,
            peso: Number(ins[2].value) || 0,
            price: Number(ins[3].value) || 0,
            quantidade: Number(ins[4].value) || 1
        };
        subtotal += (i.price * i.quantidade);
        pesoTotal += (i.peso * i.quantidade);
        itens.push(i);
    });

    const dp = Number(document.getElementById('edDescPromo').value) || 0;
    const dx = Number(document.getElementById('edDescPix').value) || 0;
    const vf = Number(document.getElementById('edValorFrete').value) || 0;

    db.ref('orders/' + pedidoEditando).update({
        cliente: { 
            nome: document.getElementById('edClienteNome').value, 
            telefone: document.getElementById('edClienteTel').value 
        },
        entrega: { 
            rua: document.getElementById('edRua').value, 
            num: document.getElementById('edNum').value, 
            bairro: document.getElementById('edBairro').value, 
            cidade: document.getElementById('edCidade').value,
            valorFrete: vf
        },
        itens,
        pesoTotal: Number(pesoTotal.toFixed(2)),
        descontoPromo: dp,
        descontoPix: dx,
        total: Number((subtotal - dp - dx + vf).toFixed(2)),
        ajustadoManualmente: true
    }).then(() => { 
        alert("Pedido Salvo!"); 
        fecharEditorPedido(); 
    });
}

/* FUN√á√ÉO ROMANEIO COMPLETA E CORRIGIDA */
function gerarRomaneio(id, tipo = 1) {
    const fmtPeso = (g) => {
        const p = Number(g || 0);
        return p >= 1000 ? `${(p/1000).toFixed(3).replace('.',',')} kg` : `${p.toFixed(2).replace('.',',')} g`;
    };

    db.ref('orders/' + id).once('value', s => {
        const p = s.val(); if (!p) return;
        db.ref('settings/empresa').once('value', e => {
            const emp = e.val() || {};
            let html = `<style>
                .print-body { font-family: Arial, sans-serif; color:#000; padding:20px; font-size:11px; }
                .lux-head { text-align:center; border-bottom:2px solid #A68966; padding-bottom:10px; margin-bottom:15px; }
                .lux-head h1 { margin:0; color:#A68966; font-size:22px; }
                .grid-dados { display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:15px; }
                table { width:100%; border-collapse:collapse; margin-top:10px; font-size:11px; }
                table th { background:#f5f5f5; text-align:left; border-bottom:1px solid #000; padding:4px; }
                table td { border-bottom:1px solid #ddd; padding:4px; }
                .totais-box { text-align:right; margin-top:15px; font-size:11px; border-top:1px solid #000; padding-top:10px; }
                .img-mini { width:45px; height:45px; object-fit:cover; border-radius:4px; }
            </style>
            <div class="print-body">
                <div class="lux-head"><h1>${emp.nome || 'Abella Joias'}</h1><p>${emp.subtitulo || ''}<br>WhatsApp: ${emp.whats || ''}</p></div>
                <div class="grid-dados">
                    <div><b>CLIENTE:</b> ${p.cliente?.nome || ''}<br>WhatsApp: ${p.cliente?.telefone || ''}</div>
                    <div><b>ENTREGA:</b> ${p.entrega?.rua || ''}, ${p.entrega?.num || ''}<br>${p.entrega?.bairro || ''} - ${p.entrega?.cidade || ''}</div>
                </div>
                <table><thead><tr>
                    ${tipo === 3 ? '<th>Foto</th>' : ''}
                    <th>SKU</th><th>Produto</th><th>Peso</th>
                    ${tipo > 1 ? '<th>Pre√ßo</th>' : ''}
                    <th>Qtd</th>
                    ${tipo > 1 ? '<th>Subtotal</th>' : ''}
                </tr></thead><tbody>`;

            let subCalc = 0, pesoCalc = 0, qtdCalc = 0;
            const itens = Array.isArray(p.itens) ? p.itens : Object.values(p.itens || {});

            itens.forEach(i => {
                const pr = Number(i.price || i.precoFinal || 0);
                const qt = Number(i.quantidade || i.qtd || 1);
                const ps = Number(i.peso || i.weight || 0);
                subCalc += (pr * qt);
                pesoCalc += (ps * qt);
                qtdCalc += qt;

                html += `<tr>
                    ${tipo === 3 ? `<td><img src="${i.image || ''}" class="img-mini"></td>` : ''}
                    <td>${i.sku || '---'}</td>
                    <td>${i.name || ''}</td>
                    <td>${fmtPeso(ps)}</td>
                    ${tipo > 1 ? `<td>${fMoeda(pr)}</td>` : ''}
                    <td>${qt}</td>
                    ${tipo > 1 ? `<td>${fMoeda(pr * qt)}</td>` : ''}
                </tr>`;
            });

            const dPromo = Number(p.descontoPromo || 0);
            const dPix = Number(p.descontoPix || 0);
            const vFrete = Number(p.entrega?.valorFrete || p.valorFrete || 0);
            const vFinal = subCalc - dPromo - dPix + vFrete;

            html += `</tbody></table>
            <div class="totais-box">
                <span>Qtd Total: <b>${qtdCalc}</b></span> | <span>Peso Total: <b>${fmtPeso(pesoCalc)}</b></span>
                ${tipo > 1 ? `
                    <div style="margin-top:10px;">
                        Subtotal: ${fMoeda(subCalc)}<br>
                        ${dPromo > 0 ? `Desconto Promo: - ${fMoeda(dPromo)}<br>` : ''}
                        ${dPix > 0 ? `Desconto Pix: - ${fMoeda(dPix)}<br>` : ''}
                        ${vFrete > 0 ? `Frete: + ${fMoeda(vFrete)}<br>` : ''}
                        <b style="font-size:15px; color:#A68966; display:block; margin-top:5px; border-top:1px double #000; pt-1">
                            TOTAL A PAGAR: ${fMoeda(vFinal)}
                        </b>
                    </div>
                ` : ''}
            </div></div>`;

            document.getElementById('print-area').innerHTML = html;
            setTimeout(() => { window.print(); }, 500);
        });
    });
}

/* OUTRAS FUN√á√ïES DE SUPORTE */
function carregarCategorias() {
    const lista = document.getElementById('listaCategorias');
    db.ref('categories').once('value', s => {
        lista.innerHTML = '';
        s.forEach(child => {
            lista.innerHTML += `<div class="card flex justify-between items-center mb-1"><b class="uppercase text-xs">${child.val().name}</b><button class="btn text-blue-400" onclick="editarCategoria('${child.key}', '${child.val().name}')">‚úé</button></div>`;
        });
    });
}
function carregarProdutos() {
    const lista = document.getElementById('listaProdutos');
    lista.innerHTML = '<p class="text-center p-4">Carregando...</p>';
    db.ref('categories').once('value', snapCats => {
        db.ref('products').once('value', snapProds => {
            const produtos = [];
            snapProds.forEach(p => { produtos.push({ key: p.key, ...p.val() }); });
            lista.innerHTML = '';
            snapCats.forEach(cat => {
                const prodsDaCat = produtos.filter(p => p.category === cat.key);
                if (prodsDaCat.length > 0) {
                    let htmlP = prodsDaCat.map(p => `<div class="card flex justify-between items-center py-2 px-3 text-[11px] bg-[#0d0d0d] mb-1"><span><b class="text-[#caa85c]">[${p.sku || '---'}]</b> ${p.name}</span><button onclick="editarProduto('${p.key}')">‚úé</button></div>`).join('');
                    lista.innerHTML += `<div class="mb-4"><b class="text-xs uppercase text-[#caa85c] ml-2">${cat.val().name}</b><div class="mt-2">${htmlP}</div></div>`;
                }
            });
        });
    });
}
function editarProduto(id) {
    db.ref('products/' + id).once('value', s => {
        const p = s.val(); if (!p) return;
        const nNome = prompt("Nome:", p.name);
        const nPreco = prompt("Pre√ßo:", p.price);
        if (nNome) db.ref('products/' + id).update({ name: nNome, price: Number(nPreco) }).then(carregarProdutos);
    });
}
function carregarEmpresaSeExistir() {
    db.ref('settings/empresa').once('value', s => {
        const v = s.val(); if (!v) return;
        document.getElementById('empNome').value = v.nome || '';
        document.getElementById('empSub').value = v.subtitulo || '';
        document.getElementById('empWhats').value = v.whats || '';
        document.getElementById('empDesc').value = v.descontoPix || 0;
        document.getElementById('empParc').value = v.parcelas || 0;
    });
}
function salvarEmpresa() {
    db.ref('settings/empresa').set({
        nome: document.getElementById('empNome').value,
        subtitulo: document.getElementById('empSub').value,
        whats: document.getElementById('empWhats').value,
        descontoPix: +document.getElementById('empDesc').value || 0,
        parcelas: +document.getElementById('empParc').value || 0
    }).then(() => alert('Empresa Atualizada!'));
}
function fecharModal() { document.getElementById('mainModal').classList.remove('active'); }

window.addEventListener('DOMContentLoaded', () => {
    const firstBtn = document.querySelector('nav button.active');
    if (firstBtn) firstBtn.click();
});
</script>
</body>
</html>
