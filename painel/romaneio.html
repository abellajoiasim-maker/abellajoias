<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Romaneio | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

<style>
@media print {.no-print{display:none}}
body{background:#f8f6f2}
.box{border:1px solid #ddd;border-radius:12px}
</style>
</head>

<body class="p-6">

<!-- CONTROLES -->
<div class="no-print flex gap-4 mb-6">
  <select id="tipo" class="border p-2 rounded">
    <option value="simples">Romaneio Simples</option>
    <option value="completo">Romaneio Completo</option>
  </select>

  <label class="flex items-center gap-2">
    <input type="checkbox" id="fotos"> Com fotos
  </label>

  <button onclick="gerarPDF()" class="bg-black text-white px-6 py-2 rounded">
    üìÑ Gerar PDF
  </button>

  <button onclick="window.print()" class="border px-6 py-2 rounded">
    üñ®Ô∏è Imprimir
  </button>
</div>

<!-- ROMANEIO -->
<div id="romaneio" class="bg-white p-6 box max-w-4xl mx-auto">

  <h1 class="text-2xl font-extrabold mb-4">ROMANEIO</h1>

  <!-- DADOS CLIENTE -->
  <div id="dadosCliente" class="grid grid-cols-2 gap-4 mb-6">
    <input id="cliente" placeholder="Nome do cliente" class="border p-2 rounded">
    <input id="telefone" placeholder="Telefone" class="border p-2 rounded">
    <input id="local" placeholder="Local de entrega" class="border p-2 rounded">
    <input id="cidade" placeholder="Cidade" class="border p-2 rounded">
    <textarea id="endereco" placeholder="Endere√ßo completo" class="border p-2 rounded col-span-2"></textarea>
  </div>

  <!-- ITENS -->
  <table class="w-full text-sm border">
    <thead class="bg-gray-100">
      <tr>
        <th class="border p-2">SKU</th>
        <th class="border p-2">Produto</th>
        <th class="border p-2 foto">Foto</th>
        <th class="border p-2">Qtd</th>
        <th class="border p-2">Valor</th>
      </tr>
    </thead>
    <tbody id="itens"></tbody>
  </table>

  <!-- TOTAIS -->
  <div class="mt-6 text-right space-y-1 text-sm">
    <div>Peso total: <strong id="peso">0</strong> g</div>
    <div>Valor total: <strong>R$ <span id="valor">0</span></strong></div>
    <div class="font-bold text-lg">Valor final: R$ <span id="final">0</span></div>
  </div>

</div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
 authDomain:"catalogo-abella-joias.firebaseapp.com",
 databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com"
});
const db=firebase.database();

const id=new URLSearchParams(window.location.search).get('id');
let pedido;

db.ref('pedidos/'+id).once('value').then(s=>{
 pedido=s.val();
 if(!pedido) return;

 cliente.value=pedido.cliente||'';
 telefone.value=pedido.telefone||'';

 let peso=0,valor=0;

 pedido.itens.forEach(i=>{
   peso+=i.peso*i.qtd;
   valor+=i.preco*i.qtd;

   itens.innerHTML+=`
   <tr>
     <td class="border p-2">${i.sku}</td>
     <td class="border p-2">${i.nome}</td>
     <td class="border p-2 foto">
       <img src="${i.imagem}" class="h-16 mx-auto">
     </td>
     <td class="border p-2">
       <input type="number" value="${i.qtd}" class="w-16 border">
     </td>
     <td class="border p-2">R$ ${(i.preco*i.qtd).toFixed(2)}</td>
   </tr>`;
 });

 document.getElementById('peso').innerText=peso;
 document.getElementById('valor').innerText=valor.toFixed(2);
 document.getElementById('final').innerText=valor.toFixed(2);
});

/* CONTROLES */
document.getElementById('tipo').onchange=e=>{
 dadosCliente.style.display=e.target.value==='simples'?'none':'grid';
}
document.getElementById('fotos').onchange=e=>{
 document.querySelectorAll('.foto').forEach(f=>f.style.display=e.target.checked?'table-cell':'none');
}

function gerarPDF(){
 html2pdf().from(romaneio).save(`romaneio_${id}.pdf`);
}
</script>

</body>
</html>
