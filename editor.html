<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Editor Full Master v2.7 ‚Ä¢ Abella Joias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background: #0b0b0b; color: #eee; font-family: 'Poppins', sans-serif; }
        .input-dark { background: #1a1a1a; border: 1px solid #333; color: white; padding: 10px; border-radius: 8px; width: 100%; font-size: 12px; transition: 0.3s; }
        .input-dark:focus { border-color: #caa85c; outline: none; background: #222; box-shadow: 0 0 8px rgba(202, 168, 92, 0.4); }
        .edit-name { font-weight: 600; color: #fff; }
        tr.is-paused { opacity: 0.4; background: #2a1010 !important; }
        .btn-status { font-size: 9px; font-weight: 800; text-transform: uppercase; padding: 5px 10px; border-radius: 5px; cursor: pointer; width: 60px; text-align: center; }
        .status-on { background: #15803d; color: white; }
        .status-off { background: #b91c1c; color: white; }
        .sticky-header th { position: sticky; top: 0; background: #0b0b0b; z-index: 10; border-bottom: 2px solid #caa85c; padding: 12px; }
        .img-preview { width: 50px; height: 50px; object-fit: contain; background: #222; border-radius: 8px; border: 1px solid #333; }
        .highlight-var { border: 1px solid #caa85c !important; background: #262116 !important; }
    </style>
</head>
<body class="p-4 md:p-6">

    <div class="max-w-[99%] mx-auto">
        <header class="flex flex-col xl:flex-row justify-between items-center mb-6 gap-6 bg-[#141414] p-6 rounded-2xl border border-[#2a2a2a] shadow-xl">
            <div>
                <h1 class="text-2xl font-bold text-[#caa85c]">Editor Full Master v2.7</h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest font-semibold">Foco em Nomes e Varia√ß√µes</p>
            </div>
            
            <div class="flex flex-wrap gap-3 w-full xl:w-auto justify-center">
                <select id="filtroCat" class="bg-[#0b0b0b] border border-[#333] px-4 py-2 rounded-xl text-sm text-white outline-none focus:border-[#caa85c]">
                    <option value="">Todas Categorias</option>
                </select>
                <input id="filtroSku" onkeypress="if(event.key === 'Enter') carregarProdutos()" placeholder="SKU ou Nome..." class="bg-[#0b0b0b] border border-[#333] px-4 py-2 rounded-xl text-sm w-full md:w-64 outline-none focus:border-[#caa85c] text-white">
                <button onclick="carregarProdutos()" class="bg-[#caa85c] text-black font-bold px-8 py-2 rounded-xl text-sm hover:brightness-110">üîç BUSCAR</button>
            </div>
        </header>

        <div class="bg-[#141414] border border-[#2a2a2a] rounded-2xl overflow-hidden shadow-2xl">
            <div class="overflow-x-auto" style="max-height: 75vh;">
                <table class="w-full text-left text-[11px] border-collapse">
                    <thead class="sticky-header">
                        <tr class="text-[#caa85c] uppercase text-[9px] tracking-wider">
                            <th class="w-20 p-4">Status</th>
                            <th class="w-16">Foto</th>
                            <th class="w-24">SKU</th>
                            <th class="w-1/4">Nome do Produto</th>
                            <th class="w-32">Categoria</th>
                            <th class="w-32">Tipo Varia√ß√£o</th>
                            <th class="w-48">Op√ß√µes (A, B, C...)</th>
                            <th class="w-20">R$ Promo</th>
                            <th class="w-24 text-center">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCorpo">
                        <tr><td colspan="9" class="p-20 text-center text-gray-500 italic text-lg">Digite o SKU ou selecione uma categoria para come√ßar a editar.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-6 flex flex-col md:flex-row justify-between items-center bg-[#141414] p-5 rounded-2xl border border-[#2a2a2a] gap-4">
            <div id="statusInfo" class="text-sm text-gray-400">Pronto.</div>
            <button onclick="salvarAlteracoes()" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-black px-16 py-4 rounded-xl shadow-lg uppercase tracking-widest text-sm transition-all transform hover:scale-105">
                üíæ Salvar Todas as Mudan√ßas
            </button>
        </div>
    </div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let categoriasCache = {};

async function carregarCategorias() {
    const snap = await db.ref('categories').once('value');
    categoriasCache = snap.val() || {};
    const filterSelect = document.getElementById('filtroCat');
    let options = '<option value="">Todas Categorias</option>';
    Object.entries(categoriasCache).forEach(([id, cat]) => {
        options += `<option value="${id}">${cat.name}</option>`;
    });
    filterSelect.innerHTML = options;
}

async function carregarProdutos() {
    const filtroTexto = document.getElementById('filtroSku').value.trim().toUpperCase();
    const filtroCat = document.getElementById('filtroCat').value;
    const corpo = document.getElementById('tabelaCorpo');
    corpo.innerHTML = '<tr><td colspan="9" class="p-20 text-center text-[#caa85c] animate-pulse font-bold">ABRINDO BANCO DE DADOS...</td></tr>';

    db.ref('products').once('value', snapshot => {
        let html = '';
        let contador = 0;
        snapshot.forEach(child => {
            const p = child.val();
            const sku = String(p.sku || "").toUpperCase();
            const nome = String(p.name || "").toUpperCase();
            const catId = p.category || "";

            if ((!filtroTexto || sku.includes(filtroTexto) || nome.includes(filtroTexto)) && (!filtroCat || catId === filtroCat)) {
                contador++;
                let catOptions = '';
                Object.entries(categoriasCache).forEach(([id, cat]) => {
                    catOptions += `<option value="${id}" ${catId === id ? 'selected' : ''}>${cat.name}</option>`;
                });

                html += `
                <tr data-id="${child.key}" class="border-b border-[#222] transition-colors hover:bg-[#1a1a1a] ${p.paused ? 'is-paused' : ''}">
                    <td class="p-3 text-center">
                        <button class="btn-status ${p.paused ? 'status-off' : 'status-on'}" onclick="toggleStatus(this)">${p.paused ? 'OFF' : 'ON'}</button>
                    </td>
                    <td class="p-2">
                        <img src="${p.image}" class="img-preview">
                    </td>
                    <td class="p-2 font-mono text-[#caa85c] font-bold">${sku}</td>
                    <td class="p-1">
                        <input class="input-dark edit-name" value="${p.name || ''}" placeholder="Nome do produto">
                    </td>
                    <td class="p-1">
                        <select class="input-dark edit-cat">${catOptions}</select>
                    </td>
                    <td class="p-1">
                        <select class="input-dark edit-varTipo" onchange="liberarCampoLista(this)">
                            <option value="" ${!p.variacaoTipo ? 'selected' : ''}>Sem Varia√ß√£o</option>
                            <option value="Aro" ${p.variacaoTipo === 'Aro' ? 'selected' : ''}>Aro (An√©is)</option>
                            <option value="Lista" ${p.variacaoTipo === 'Lista' ? 'selected' : ''}>Lista (Letras/Nomes)</option>
                        </select>
                    </td>
                    <td class="p-1">
                        <input class="input-dark edit-opcoes ${p.variacaoTipo === 'Lista' ? 'highlight-var' : 'opacity-20 pointer-events-none'}" 
                        value="${p.opcoesPersonalizadas || ''}" placeholder="Ex: A, B, C, D...">
                    </td>
                    <td class="p-1">
                        <input class="input-dark edit-precoFinal" type="number" step="0.01" value="${p.precoFinal || p.price || 0}">
                    </td>
                    <td class="p-1 text-center flex justify-center gap-2 pt-4">
                         <button onclick="salvarLinhaUnica(this)" class="bg-green-600 p-2 rounded-lg hover:bg-green-500 title="Salvar apenas este">‚úÖ</button>
                         <button onclick="deletarProduto('${child.key}')" class="bg-red-900 p-2 rounded-lg hover:bg-red-700">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }
        });
        corpo.innerHTML = html || '<tr><td colspan="9" class="p-20 text-center text-red-500 font-bold">Nenhum produto encontrado com esses filtros.</td></tr>';
        document.getElementById('statusInfo').innerText = `${contador} produtos prontos para edi√ß√£o.`;
    });
}

function liberarCampoLista(select) {
    const tr = select.closest('tr');
    const input = tr.querySelector('.edit-opcoes');
    if(select.value === 'Lista') {
        input.classList.remove('opacity-20', 'pointer-events-none');
        input.classList.add('highlight-var');
        input.focus();
    } else {
        input.classList.add('opacity-20', 'pointer-events-none');
        input.classList.remove('highlight-var');
        input.value = '';
    }
}

function salvarLinhaUnica(btn) {
    const tr = btn.closest('tr');
    const id = tr.dataset.id;
    const data = {
        name: tr.querySelector('.edit-name').value,
        category: tr.querySelector('.edit-cat').value,
        variacaoTipo: tr.querySelector('.edit-varTipo').value,
        opcoesPersonalizadas: tr.querySelector('.edit-opcoes').value,
        precoFinal: parseFloat(tr.querySelector('.edit-precoFinal').value) || 0,
        paused: tr.querySelector('.btn-status').classList.contains('status-off')
    };
    
    db.ref(`products/${id}`).update(data)
        .then(() => {
            btn.classList.add('bg-blue-600');
            setTimeout(() => btn.classList.remove('bg-blue-600'), 1000);
        })
        .catch(e => alert("Erro: " + e.message));
}

function salvarAlteracoes() {
    const updates = {};
    document.querySelectorAll('#tabelaCorpo tr[data-id]').forEach(tr => {
        const id = tr.dataset.id;
        updates[`/products/${id}/name`] = tr.querySelector('.edit-name').value;
        updates[`/products/${id}/category`] = tr.querySelector('.edit-cat').value;
        updates[`/products/${id}/variacaoTipo`] = tr.querySelector('.edit-varTipo').value;
        updates[`/products/${id}/opcoesPersonalizadas`] = tr.querySelector('.edit-opcoes').value;
        updates[`/products/${id}/precoFinal`] = parseFloat(tr.querySelector('.edit-precoFinal').value) || 0;
        updates[`/products/${id}/paused`] = tr.querySelector('.btn-status').classList.contains('status-off');
    });
    db.ref().update(updates).then(() => alert("‚úÖ Todos os produtos foram atualizados!")).catch(e => alert(e.message));
}

function toggleStatus(btn) {
    const isActive = btn.classList.contains('status-on');
    btn.className = `btn-status ${isActive ? 'status-off' : 'status-on'}`;
    btn.innerText = isActive ? 'OFF' : 'ON';
    btn.closest('tr').classList.toggle('is-paused', isActive);
}

function deletarProduto(id) { if(confirm("Excluir definitivamente?")) db.ref('products/' + id).remove().then(() => carregarProdutos()); }

carregarCategorias();
</script>
</body>
</html>
