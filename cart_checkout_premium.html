<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Abella Joias | Carrinho</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body { background:#F8F6F2 }
.gold { color:#A68966 }
</style>
</head>

<body class="max-w-4xl mx-auto p-6">

<!-- TÍTULO -->
<div class="text-center mb-8">
  <h1 class="text-2xl gold font-serif">Abella Joias</h1>
  <p class="text-xs tracking-widest">ATACADO DE JOIAS NO BRUTO</p>
  <h2 class="mt-4 text-lg font-semibold">Carrinho de Compras</h2>
</div>

<div id="listaCarrinho" class="space-y-4"></div>

<!-- RESUMO -->
<div class="bg-white p-6 mt-6 space-y-2 text-sm">
  <p>Peso total: <strong><span id="pesoTotal">0.00</span> g</strong></p>

  <p>Valor cheio: <strong>R$ <span id="valorCheio">0.00</span></strong></p>
  <p>Valor PIX: <strong>R$ <span id="valorPix">0.00</span></strong></p>
  <p>Valor em parcelas:
    <strong>
      <span id="parcelasTxt"></span>
    </strong>
  </p>

  <select id="formaPagamento" class="border p-2 w-full mt-2">
    <option value="pix">PIX</option>
    <option value="cartao">Cartão</option>
  </select>

  <button onclick="finalizarPedido()"
    class="w-full bg-black text-white py-3 mt-4">
    Finalizar Pedido
  </button>
</div>

<!-- VOLTAR -->
<a href="index.html"
 class="fixed bottom-6 left-6 bg-white border px-4 py-2 shadow">
⬅ Voltar
</a>

<script>
// FIREBASE
firebase.initializeApp({
  apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com"
});
const db = firebase.database();

// DADOS EMPRESA
let settings={pix:0,parcelas:1};
db.ref('settings').once('value').then(s=>{
  if(s.val()) settings=s.val();
  atualizarResumo();
});

// CARRINHO
let carrinho = JSON.parse(localStorage.getItem('cart') || '[]');

function salvarCarrinho(){
  localStorage.setItem('cart', JSON.stringify(carrinho));
  render();
}

function render(){
  listaCarrinho.innerHTML='';
  carrinho.forEach((p,i)=>{
    listaCarrinho.innerHTML+=`
    <div class="bg-white p-4 flex gap-4 items-center">
      <img src="${p.image}" class="w-20 h-20 object-cover">

      <div class="flex-1">
        <p class="font-semibold">${p.name}</p>
        <p class="text-xs">${p.sku}</p>
        <p class="gold">R$ ${p.price.toFixed(2)}</p>
      </div>

      <div class="flex items-center gap-2">
        <button onclick="alterarQtd(${i},-1)" class="border px-2">-</button>

        <input type="number" min="1"
          value="${p.qty}"
          onchange="setQtd(${i}, this.value)"
          class="border w-16 text-center">

        <button onclick="alterarQtd(${i},1)" class="border px-2">+</button>
      </div>

      <button onclick="remover(${i})"
        class="text-red-600 text-xs">
        Excluir
      </button>
    </div>`;
  });
  atualizarResumo();
}

function alterarQtd(i,delta){
  carrinho[i].qty=Math.max(1,carrinho[i].qty+delta);
  salvarCarrinho();
}

function setQtd(i,val){
  carrinho[i].qty=Math.max(1,parseInt(val)||1);
  salvarCarrinho();
}

function remover(i){
  carrinho.splice(i,1);
  salvarCarrinho();
}

// RESUMO
function atualizarResumo(){
  let peso=0,total=0;
  carrinho.forEach(p=>{
    peso+=p.weight*p.qty;
    total+=p.price*p.qty;
  });

  pesoTotal.textContent=peso.toFixed(2);
  valorCheio.textContent=total.toFixed(2);

  let pixTotal= total*(1-settings.pix/100);
  valorPix.textContent=pixTotal.toFixed(2);

  let parcelaValor=(total/settings.parcelas).toFixed(2);
  parcelasTxt.textContent=
    `${settings.parcelas}x sem acréscimo de R$ ${parcelaValor}`;
}

// FINALIZAR
function finalizarPedido(){
  if(!carrinho.length) return alert('Carrinho vazio');

  db.ref('orders').push({
    itens:carrinho,
    total:+valorCheio.textContent,
    pagamento:formaPagamento.value,
    peso:+pesoTotal.textContent,
    status:'Novo',
    data:new Date().toLocaleString()
  });

  alert('Pedido enviado com sucesso! Em instantes a Abella Joias entrará em contato.');
  localStorage.removeItem('cart');
  carrinho=[];
  render();
}

// INIT
render();
</script>

</body>
</html>
