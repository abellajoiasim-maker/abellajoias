<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checkout | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.gold{color:#A68966}
.font-serif{font-family:'Cinzel',serif}
.floating{position:fixed;bottom:20px;right:20px;z-index:50}
</style>
</head>

<body class="p-6">

<h1 class="text-center font-serif text-2xl gold mb-2">Abella Joias</h1>
<p class="text-center text-sm tracking-widest mb-6">
ATACADO DE JOIAS NO BRUTO<br>
<strong>Carrinho de Compras</strong>
</p>

<div id="lista" class="max-w-4xl mx-auto space-y-4"></div>

<div class="max-w-4xl mx-auto bg-white border p-4 mt-6">
  <p id="peso"></p>
  <p id="valorCheio"></p>
  <p id="valorPix" class="text-green-700 font-semibold"></p>
  <p id="parcelas"></p>

  <div class="mt-4">
    <label class="block mb-2 font-semibold">Forma de pagamento:</label>
    <select id="pagamento" class="w-full border p-2">
      <option value="Pix">Pix</option>
      <option value="Cart√£o">Cart√£o</option>
    </select>
  </div>

  <button onclick="finalizar()" class="mt-4 bg-black text-white w-full py-3">
    FINALIZAR COMPRA
  </button>
</div>

<!-- Bot√£o flutuante -->
<div class="floating">
  <a href="index.html" class="bg-gray-800 text-white px-4 py-3 rounded-full text-sm">üîô Voltar</a>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});
const db=firebase.database();

let cart=JSON.parse(localStorage.getItem('cart')||'[]');
let pixDesc=0, parcelasCfg=1;

db.ref('settings').once('value').then(s=>{
  pixDesc=s.val()?.pix||0;
  parcelasCfg=s.val()?.parcelas||1;
  render();
});

function render(){
  let pesoT=0, total=0;
  lista.innerHTML='';

  cart.forEach((p,i)=>{
    pesoT+=p.weight*p.qty;
    total+=p.price*p.qty;

    lista.innerHTML+=`
    <div class="bg-white border p-3 flex gap-3">
      <img src="${p.image}" class="w-20 h-20 object-contain">
      <div class="flex-1">
        <p class="font-semibold">${p.name}</p>
        <p class="text-xs text-gray-500">SKU ${p.sku}</p>

        <div class="flex items-center gap-2 mt-2">
          <button onclick="alterar(${i},-1)" class="px-2 border">-</button>
          <input type="number" min="1" value="${p.qty}"
            class="w-16 border text-center"
            onchange="digitar(${i},this.value)">
          <button onclick="alterar(${i},1)" class="px-2 border">+</button>

          <button onclick="excluir(${i})" class="ml-auto text-red-600 text-sm">
            Excluir Produto
          </button>
        </div>
      </div>
    </div>`;
  });

  const pixVal=total*(1-pixDesc/100);
  const parcelaVal=(total/parcelasCfg);

  peso.innerText=`Peso total: ${pesoT.toFixed(2).replace('.',',')} g`;
  valorCheio.innerText=`Valor Cheio: R$ ${total.toFixed(2)}`;
  valorPix.innerText=`Valor Pix: R$ ${pixVal.toFixed(2)}`;
  parcelas.innerText=`${parcelasCfg}x de R$ ${parcelaVal.toFixed(2)} sem acr√©scimo`;
}

function alterar(i,v){
  cart[i].qty=Math.max(1,cart[i].qty+v);
  salvar();
}
function digitar(i,v){
  cart[i].qty=Math.max(1,parseInt(v||1));
  salvar();
}
function excluir(i){
  cart.splice(i,1);
  salvar();
}
function salvar(){
  localStorage.setItem('cart',JSON.stringify(cart));
  render();
}

function finalizar(){
  if(!cart.length) return alert('Carrinho vazio');

  const forma=pagamento.value;
  const total=cart.reduce((s,p)=>s+p.price*p.qty,0);
  const final=forma==='Pix'?total*(1-pixDesc/100):total;

  const pedido=db.ref('orders').push();
  pedido.set({
    data:new Date().toLocaleString(),
    pagamento:forma,
    total:final,
    itens:cart
  });

  const msg=`Ol√°, fiz um pedido na Abella Joias.
Valor: R$ ${final.toFixed(2)}
Pagamento: ${forma}
Status: aguardando contato para confirma√ß√£o.`;

  window.open(`https://wa.me/5519988207658?text=${encodeURIComponent(msg)}`,'_blank');

  alert('Pedido enviado com sucesso! Em instantes a Abella Joias entrar√° em contato.');
  localStorage.removeItem('cart');
  location.href='index.html';
}
</script>

</body>
</html>
