<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checkout | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body { background:#F8F6F2 }
.gold { color:#A68966 }

.floating {
  position: fixed;
  right: 20px;
  bottom: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.btn-float {
  background: #000;
  color: #fff;
  padding: 14px 18px;
  border-radius: 999px;
  font-size: 12px;
}
</style>
</head>

<body class="max-w-5xl mx-auto p-6">

<h1 class="text-2xl gold font-semibold mb-6">Finalizar Pedido</h1>

<div id="itensCarrinho" class="space-y-4"></div>

<div class="bg-white border p-6 mt-6 space-y-3">
  <p>Total: <strong>R$ <span id="totalCheio">0.00</span></strong></p>
  <p class="text-green-700">Desconto PIX: − R$ <span id="descontoPix">0.00</span></p>
  <p class="text-lg font-bold">Total Final: R$ <span id="totalFinal">0.00</span></p>
  <p class="text-xs text-gray-500" id="parcelasTexto"></p>
</div>

<div class="bg-white border p-6 mt-6 space-y-4">
  <input id="nomeCliente" placeholder="Nome completo" class="border p-3 w-full">
  <input id="whatsCliente" placeholder="WhatsApp" class="border p-3 w-full">

  <select id="formaPagamento" class="border p-3 w-full">
    <option value="PIX">PIX</option>
    <option value="Cartão">Cartão</option>
  </select>

  <button onclick="finalizarPedido()"
   class="bg-black text-white w-full py-4 text-sm tracking-widest">
   FINALIZAR PEDIDO
  </button>
</div>

<div class="floating">
  <a href="index.html" class="btn-float">⬅ Voltar</a>
  <a href="galvanicas.html" class="btn-float">Galvânicas</a>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});
const db = firebase.database();

let carrinho = JSON.parse(localStorage.getItem('cart') || '[]');
let settings = {};

db.ref('settings').once('value').then(s => settings = s.val());

function renderCarrinho(){
  let total = 0, peso = 0;
  itensCarrinho.innerHTML = '';

  carrinho.forEach((i,idx)=>{
    total += i.price * i.qty;
    peso += i.weight * i.qty;

    itensCarrinho.innerHTML += `
    <div class="bg-white border p-4 flex gap-4">
      <img src="${i.image}" class="w-24 h-24 object-cover">
      <div class="flex-1">
        <p class="font-semibold">${i.name}</p>
        <p class="text-xs">SKU: ${i.sku}</p>
        <div class="flex items-center gap-2 mt-2">
          <button onclick="alterarQtd(${idx},-1)" class="border px-2">−</button>
          <span>${i.qty}</span>
          <button onclick="alterarQtd(${idx},1)" class="border px-2">+</button>
        </div>
        <p class="mt-2 font-semibold">R$ ${(i.price*i.qty).toFixed(2)}</p>
      </div>
    </div>`;
  });

  const desconto = settings?.pix ? total * (settings.pix/100) : 0;
  totalCheio.textContent = total.toFixed(2);
  descontoPix.textContent = desconto.toFixed(2);
  totalFinal.textContent = (total-desconto).toFixed(2);
  parcelasTexto.textContent = settings?.parcelas
    ? `${settings.parcelas} sem acréscimo no cartão`
    : '';
}

function alterarQtd(i,v){
  carrinho[i].qty += v;
  if(carrinho[i].qty<=0) carrinho.splice(i,1);
  localStorage.setItem('cart',JSON.stringify(carrinho));
  renderCarrinho();
}

function finalizarPedido(){
  if(!nomeCliente.value || !whatsCliente.value){
    alert('Preencha nome e WhatsApp');
    return;
  }

  const pagamento = formaPagamento.value;
  const total = Number(totalFinal.textContent);
  const pedido = {
    cliente:nomeCliente.value,
    whatsapp:whatsCliente.value,
    pagamento,
    itens:carrinho,
    total,
    desconto: pagamento==='PIX' ? settings.pix : 0,
    status:'Novo',
    data: new Date().toLocaleString('pt-BR')
  };

  db.ref('orders').push(pedido);

  const msg = encodeURIComponent(
    `Pedido enviado com sucesso!\n\nCliente: ${pedido.cliente}\nTotal: R$ ${total.toFixed(2)}\nPagamento: ${pagamento}\n\nEm instantes entraremos em contato.`
  );

  alert('✅ Pedido enviado com sucesso!\nEm instantes a Abella Joias entrará em contato.');

  localStorage.removeItem('cart');
  window.open(`https://wa.me/${settings.whatsapp}?text=${msg}`,'_blank');
  window.location.href='index.html';
}

renderCarrinho();
</script>

</body>
</html>
