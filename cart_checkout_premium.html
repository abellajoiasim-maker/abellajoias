<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checkout | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.gold{color:#A68966}
.font-serif{font-family:'Cinzel',serif}
.floating{position:fixed;bottom:20px;right:20px;z-index:50}
</style>
</head>

<body class="p-6">

<h1 class="text-center font-serif text-2xl gold mb-2">Abella Joias</h1>
<p class="text-center text-sm tracking-widest mb-6">
ATACADO DE JOIAS NO BRUTO<br>
<strong>Carrinho de Compras</strong>
</p>

<div id="lista" class="max-w-4xl mx-auto space-y-4"></div>

<div class="max-w-4xl mx-auto bg-white border p-4 mt-6 shadow-sm">
  <p id="peso" class="text-gray-500 text-sm"></p>
  <p id="valorCheio"></p>
  <p id="valorPix" class="text-green-700 font-semibold"></p>
  <p id="parcelas"></p>

  <div class="mt-4 border-t pt-4">
    <label class="block mb-2 font-semibold text-xs uppercase gold">Forma de pagamento:</label>
    <select id="pagamento" class="w-full border p-3 bg-gray-50" onchange="render()">
      <option value="Pix">Pix</option>
      <option value="Cart√£o">Cart√£o</option>
    </select>
  </div>

  <button onclick="finalizar()" class="mt-4 bg-black text-white w-full py-4 font-bold text-xs tracking-widest uppercase">
    FINALIZAR COMPRA
  </button>
</div>

<div class="floating">
  <a href="index.html" class="bg-gray-800 text-white px-5 py-3 rounded-full text-xs font-bold shadow-lg uppercase">üîô Voltar</a>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});
const db = firebase.database();

let cart = JSON.parse(localStorage.getItem('cart') || '[]');
let pixDesc = 0, parcelasCfg = 1;

db.ref('settings').once('value').then(s => {
  const v = s.val();
  pixDesc = v?.pix || 0;
  parcelasCfg = v?.parcelas || 1;
  render();
});

function render() {
  const listaDiv = document.getElementById('lista');
  let pesoT = 0, total = 0;
  listaDiv.innerHTML = '';

  if (cart.length === 0) {
    listaDiv.innerHTML = '<p class="text-center py-10 text-gray-400">Seu carrinho est√° vazio.</p>';
    return;
  }

  cart.forEach((p, i) => {
    // Compatibilidade de campos preco/price e imagem/image
    const precoUnit = parseFloat(p.preco || p.price || 0);
    const pesoUnit = parseFloat(p.peso || p.weight || 0);
    const imgUrl = p.imagem || p.image || 'https://via.placeholder.com/100';

    pesoT += pesoUnit * p.qty;
    total += precoUnit * p.qty;

    listaDiv.innerHTML += `
    <div class="bg-white border p-3 flex gap-4 items-center">
      <img src="${imgUrl}" class="w-16 h-16 object-contain">
      <div class="flex-1">
        <p class="font-semibold text-sm uppercase">${p.nome || p.name}</p>
        <p class="text-[10px] text-gray-400 font-bold">SKU ${p.sku}</p>

        <div class="flex items-center gap-2 mt-2">
          <button onclick="alterar(${i},-1)" class="px-2 border bg-gray-100 font-bold">-</button>
          <input type="number" readonly value="${p.qty}" class="w-10 text-center text-sm border-0">
          <button onclick="alterar(${i},1)" class="px-2 border bg-gray-100 font-bold">+</button>

          <button onclick="excluir(${i})" class="ml-auto text-red-600 text-[10px] font-bold uppercase">
            Remover
          </button>
        </div>
      </div>
    </div>`;
  });

  const pixVal = total * (1 - pixDesc / 100);
  const parcelaVal = (total / parcelasCfg);

  document.getElementById('peso').innerText = `Peso total: ${pesoT.toFixed(2).replace('.', ',')} g`;
  document.getElementById('valorCheio').innerText = `Valor Cheio: R$ ${total.toFixed(2)}`;
  document.getElementById('valorPix').innerText = `Valor Pix: R$ ${pixVal.toFixed(2)}`;
  document.getElementById('parcelas').innerText = `${parcelasCfg}x de R$ ${parcelaVal.toFixed(2)} sem acr√©scimo`;
}

function alterar(i, v) {
  cart[i].qty = Math.max(1, cart[i].qty + v);
  salvar();
}

function excluir(i) {
  cart.splice(i, 1);
  salvar();
}

function salvar() {
  localStorage.setItem('cart', JSON.stringify(cart));
  render();
}

function finalizar() {
  if (!cart.length) return alert('Carrinho vazio');

  const forma = document.getElementById('pagamento').value;
  let subtotal = 0;
  cart.forEach(p => {
    subtotal += parseFloat(p.preco || p.price || 0) * p.qty;
  });

  const final = forma === 'Pix' ? subtotal * (1 - pixDesc / 100) : subtotal;

  // Salva no Banco de Dados
  const pedido = db.ref('orders').push();
  pedido.set({
    data: new Date().toLocaleString(),
    pagamento: forma,
    total: final.toFixed(2),
    itens: cart
  });

  // MENSAGEM CURTA (Mantida conforme solicitado)
  const msg = `Ol√°, fiz um pedido na Abella Joias.
Valor: R$ ${final.toFixed(2)}
Pagamento: ${forma}
Status: aguardando contato para confirma√ß√£o.`;

  window.open(`https://wa.me/5519988207658?text=${encodeURIComponent(msg)}`, '_blank');

  alert('Pedido enviado com sucesso! Em instantes a Abella Joias entrar√° em contato.');
  localStorage.removeItem('cart');
  location.href = 'index.html';
}
</script>

</body>
</html>
