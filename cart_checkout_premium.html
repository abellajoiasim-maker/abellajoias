<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checkout | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body { background:#f8f6f2 }
.gold { color:#A68966 }
.price-old { text-decoration: line-through; color:#999; font-size:12px }
</style>
</head>

<body>

<header class="bg-white border-b p-6 text-center">
  <h1 class="text-xl font-bold gold uppercase">Checkout Premium</h1>
</header>

<main class="max-w-3xl mx-auto p-6 space-y-8">

<!-- CLIENTE -->
<section class="bg-white border p-6 space-y-4">
<h2 class="font-bold uppercase gold">Dados do Cliente</h2>
<input id="cNome" placeholder="Nome completo" class="border p-3 w-full">
<input id="cWhatsapp" placeholder="WhatsApp" class="border p-3 w-full">
</section>

<!-- PAGAMENTO -->
<section class="bg-white border p-6 space-y-4">
<h2 class="font-bold uppercase gold">Pagamento</h2>
<select id="pagamento" onchange="atualizarResumo()" class="border p-3 w-full">
  <option value="pix">PIX</option>
  <option value="cartao">Cart√£o</option>
</select>

<div id="parcelasBox" class="hidden">
  <select id="parcelas" onchange="atualizarResumo()" class="border p-3 w-full mt-2"></select>
</div>
</section>

<!-- RESUMO -->
<section class="bg-white border p-6 space-y-3">
<h2 class="font-bold uppercase gold">Resumo do Pedido</h2>
<div id="listaCarrinho" class="text-sm space-y-1"></div>
<hr>
<p id="linhaPreco"></p>
<p id="linhaDesconto"></p>
<p id="linhaPix"></p>
<p class="font-bold text-lg" id="linhaTotal"></p>
</section>

<button onclick="finalizar()" class="w-full bg-black text-white py-4 font-bold">
FINALIZAR PEDIDO
</button>

</main>

<script>
/* üî• FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});
const db = firebase.database();

let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
let settings={}, selos={};

/* CONFIG */
db.ref('settings').once('value').then(s=>settings=s.val()||{});
db.ref('selos').once('value').then(s=>selos=s.val()||{});

/* PARCELAS */
db.ref('settings/parcelas').once('value').then(s=>{
  const max=s.val()||1;
  parcelas.innerHTML='';
  for(let i=1;i<=max;i++) parcelas.innerHTML+=`<option>${i}x</option>`;
});

/* RENDER */
function atualizarResumo(){
  let total=0, desconto=0;
  listaCarrinho.innerHTML='';
  carrinho.forEach(p=>{
    let preco=p.preco;
    if(p.selo && selos[p.selo]){
      desconto+=preco*(selos[p.selo].desconto/100)*p.qtd;
      preco=preco*(1-selos[p.selo].desconto/100);
    }
    total+=preco*p.qtd;
    listaCarrinho.innerHTML+=`<div>${p.nome} (${p.qtd}x)</div>`;
  });

  linhaPreco.innerHTML=`Subtotal: R$ ${total.toFixed(2)}`;
  linhaDesconto.innerHTML=desconto?`Desconto promo√ß√£o: -R$ ${desconto.toFixed(2)}`:'';

  let pixDesc=0;
  if(pagamento.value==='pix'){
    pixDesc=total*(settings.pix||0)/100;
    linhaPix.innerHTML=`PIX (-${settings.pix}%): -R$ ${pixDesc.toFixed(2)}`;
  } else linhaPix.innerHTML='';

  linhaTotal.innerHTML=`Total: R$ ${(total-pixDesc).toFixed(2)}`;

  parcelasBox.classList.toggle('hidden', pagamento.value!=='cartao');
}
atualizarResumo();

/* FINALIZAR */
function finalizar(){
  const nome=cNome.value, tel=cWhatsapp.value;
  if(!nome||!tel){ alert('Preencha seus dados'); return; }

  const total=linhaTotal.innerText.replace('Total: ','');
  const forma=pagamento.value==='pix'?'PIX':'Cart√£o';

  db.ref('pedidos').push({
    cliente:nome,
    whatsapp:tel,
    total:total,
    formaPagamento:forma,
    itens:carrinho,
    status:'novo',
    data:new Date().toISOString()
  });

  const msg = `Ol√° üòä
Gostaria de confirmar um pedido que acabei de fazer no cat√°logo da Abella Joias.

Nome: ${nome}
WhatsApp: ${tel}
Valor do pedido: ${total}
Forma de pagamento: ${forma}

Fico no aguardo das orienta√ß√µes para confirma√ß√£o e pagamento. Obrigado(a)!`;

  window.location.href=`https://wa.me/55${settings.whatsapp}?text=${encodeURIComponent(msg)}`;
}
</script>

</body>
</html>
