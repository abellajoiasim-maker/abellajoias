<script>
    async function importarTudo() {
        const input = document.getElementById('csvFiles');
        const status = document.getElementById('status');
        const log = document.getElementById('log');

        if (input.files.length === 0) return alert("Selecione o arquivo!");
        
        status.innerHTML = "<span style='color:blue'>Tentando conectar ao Firebase...</span>";
        
        try {
            const file = input.files[0];
            const texto = await file.text();
            const linhas = texto.split(/\r?\n/);
            const batch = {};

            // TESTE DE CONEXÃO: Tenta gravar uma marca simples
            await db.ref('conexao_teste').set(new Date().getTime());
            log.innerHTML += "✅ Conexão com Firebase OK!<br>";

            for (let i = 1; i < linhas.length; i++) {
                const colunas = linhas[i].split(';');
                if (colunas.length < 5) continue;

                const sku = colunas[2]?.trim();
                if (!sku || sku === "sku") continue;

                const skuLimpo = sku.replace(/[\.\#\$\/\[\]]/g, "_");

                batch[skuLimpo] = {
                    nome: colunas[1]?.trim() || "Sem nome",
                    sku: sku,
                    categoria: colunas[3]?.trim() || "Geral",
                    preco: parseFloat(colunas[4]?.replace(',', '.') || 0),
                    peso: parseFloat(colunas[5]?.replace(',', '.') || 0),
                    imagem: "" 
                };
            }
            
            status.innerText = "Enviando dados...";
            await db.ref('products').update(batch);
            
            status.innerHTML = "<b style='color:green'>SUCESSO! Verifique seu Firebase agora.</b>";
            log.innerHTML += `✅ Arquivo ${file.name} processado com ${Object.keys(batch).length} itens.`;

        } catch (err) {
            console.error(err);
            status.innerHTML = "<b style='color:red'>ERRO DE CONEXÃO</b>";
            log.innerHTML += `<br>❌ Erro detalhado: ${err.message}<br>Verifique as REGRAS (Rules) do seu Database no Firebase.`;
        }
    }
</script>
