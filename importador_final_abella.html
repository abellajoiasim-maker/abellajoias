<script>
    async function importar() {
        var input = document.getElementById('arquivoCsv');
        var status = document.getElementById('status');
        var log = document.getElementById('log');

        if (input.files.length === 0) return alert("Selecione os arquivos!");

        log.innerHTML = "Iniciando processamento robusto...<br>";
        var arquivos = Array.from(input.files);
        var totalGeral = 0;

        for (var f = 0; f < arquivos.length; f++) {
            var file = arquivos[f];
            var texto = await file.text();
            
            // O SEGREDO: Uma limpeza mais agressiva nas quebras de linha
            var linhas = texto.replace(/\r/g, "").split("\n");
            var batch = {};
            var itensNesteArquivo = 0;

            for (var i = 0; i < linhas.length; i++) {
                var linhaLimpa = linhas[i].trim();
                if (!linhaLimpa) continue; // Pula linhas totalmente vazias

                var colunas = linhaLimpa.split(';');
                
                // Pula o cabeçalho se a primeira ou terceira coluna for "tipo" ou "sku"
                if (colunas[2] === "sku" || colunas[0] === "tipo") continue;

                if (colunas.length >= 4) {
                    var skuOrigem = colunas[2] ? colunas[2].trim() : "";
                    if (!skuOrigem) continue;

                    var chave = skuOrigem.replace(/[\.\#\$\/\[\]]/g, "_");

                    batch[chave] = {
                        nome: colunas[1] ? colunas[1].trim() : "Sem nome",
                        sku: skuOrigem,
                        categoria: colunas[3] ? colunas[3].trim() : "Geral",
                        preco: colunas[4] ? parseFloat(colunas[4].replace(',', '.')) : 0,
                        peso: colunas[5] ? parseFloat(colunas[5].replace(',', '.')) : 0,
                        imagem: "" // Ficar vazio aqui está correto!
                    };
                    itensNesteArquivo++;
                }
            }

            if (Object.keys(batch).length > 0) {
                await db.ref('products').update(batch);
                totalGeral += itensNesteArquivo;
                log.innerHTML += "✅ " + file.name + ": " + itensNesteArquivo + " itens processados.<br>";
            }
            log.scrollTop = log.scrollHeight;
        }

        status.innerText = "IMPORTAÇÃO CONCLUÍDA!";
        log.innerHTML += "<br><b>TOTAL FINAL NO BANCO: " + totalGeral + "</b>";
        alert("Sucesso! Total de " + totalGeral + " produtos.");
    }
</script>
