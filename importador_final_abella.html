<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Importador Blindado - Abella</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 40px; background: #fdfaf5; }
        .container { background: white; max-width: 600px; margin: auto; padding: 30px; border: 2px solid #A68966; border-radius: 15px; }
        button { background: #1a1a1a; color: white; padding: 15px; width: 100%; border: none; cursor: pointer; font-weight: bold; margin-top: 15px; }
        #log { text-align: left; background: #f4f4f4; padding: 15px; margin-top: 20px; font-size: 12px; height: 200px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color:#A68966">Importador Inteligente</h2>
    <p>Selecione o arquivo <b>abella-produtos-importacao.csv</b></p>
    <input type="file" id="csvFile" accept=".csv">
    <button onclick="processarArquivo()">LIMPAR BANCO E IMPORTAR AGORA</button>
    <div id="status" style="margin-top:15px; font-weight:bold;">Aguardando arquivo...</div>
    <div id="log">Logs de importação...</div>
</div>

<script>
    var firebaseConfig = {
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        authDomain: "catalogo-abella-joias.firebaseapp.com",
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
        projectId: "catalogo-abella-joias"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    async function processarArquivo() {
        const fileInput = document.getElementById('csvFile');
        const log = document.getElementById('log');
        const status = document.getElementById('status');

        if (!fileInput.files[0]) return alert("Selecione o arquivo!");

        status.innerText = "Limpando e Processando...";
        log.innerHTML = "Iniciando análise técnica da planilha...<br>";

        try {
            const text = await fileInput.files[0].text();
            await db.ref('products').remove(); // Limpa banco antigo

            const linhas = text.replace(/\r/g, "").split("\n");
            let batch = {};
            let contador = 0;

            for (let i = 1; i < linhas.length; i++) {
                let linha = linhas[i].trim();
                if (!linha) continue;

                // Lógica especial: Divide pela última vírgula para achar Peso, Preço e Categoria
                // Isso ignora as vírgulas problemáticas no nome do produto
                let colunas = linha.split(",");
                
                // Pegamos o SKU que costuma ser a segunda coluna ou estar após o primeiro nome
                // Mas vamos usar uma busca inteligente:
                let sku = colunas[1] ? colunas[1].trim().replace(/"/g, "") : "";
                if (!sku || sku.toLowerCase() === 'sku' || sku.length < 3) continue;

                // Captura de preço e peso garantindo que não sejam NaN
                // Buscamos os valores numéricos no final da linha
                let precoStr = colunas[3] || "0";
                let pesoStr = colunas[4] || "0";
                
                let preco = parseFloat(precoStr.replace(/"/g, "")) || 0;
                let peso = parseFloat(pesoStr.replace(/"/g, "")) || 0;

                let chave = sku.replace(/[\.\#\$\/\[\]]/g, "_");

                batch[chave] = {
                    nome: colunas[0].replace(/"/g, "").trim(),
                    sku: sku,
                    categoria: colunas[2] ? colunas[2].replace(/"/g, "").trim() : "Geral",
                    preco: preco,
                    peso: peso,
                    imagem: ""
                };

                contador++;

                if (contador % 100 === 0) {
                    await db.ref('products').update(batch);
                    log.innerHTML += `> ${contador} produtos processados...<br>`;
                    batch = {};
                    log.scrollTop = log.scrollHeight;
                }
            }

            if (Object.keys(batch).length > 0) {
                await db.ref('products').update(batch);
            }

            status.innerHTML = "<span style='color:green'>SUCESSO TOTAL!</span>";
            log.innerHTML += `<br><b>Importação finalizada: ${contador} itens.</b>`;
            alert("Foram importados " + contador + " produtos com sucesso!");

        } catch (e) {
            log.innerHTML += `<br><span style='color:red'>Erro: ${e.message}</span>`;
        }
    }
</script>
</body>
</html>
